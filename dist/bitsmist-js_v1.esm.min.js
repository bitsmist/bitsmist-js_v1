let t;const e=new Uint8Array(16);function s(){if(!t&&(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(e)}const i=[];for(let t=0;t<256;++t)i.push((t+256).toString(16).slice(1));var a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function n(t,e,n){if(a.randomUUID&&!e&&!t)return a.randomUUID();const r=(t=t||{}).random||(t.rng||s)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){n=n||0;for(let t=0;t<16;++t)e[n+t]=r[t];return e}return function(t,e=0){return i[t[e+0]]+i[t[e+1]]+i[t[e+2]]+i[t[e+3]]+"-"+i[t[e+4]]+i[t[e+5]]+"-"+i[t[e+6]]+i[t[e+7]]+"-"+i[t[e+8]]+i[t[e+9]]+"-"+i[t[e+10]]+i[t[e+11]]+i[t[e+12]]+i[t[e+13]]+i[t[e+14]]+i[t[e+15]]}(r)}class Unit extends HTMLElement{static#t={callback:new Map};#e={};#s;#i;#a=n();static{Unit.#n(Unit,"method","upgrade",((...t)=>{Unit.#n(Unit,...t)})),Unit.upgrade("method","get",Unit.#r),Unit.upgrade("method","set",Unit.#o),Unit.upgrade("method","has",Unit.#l)}static get uniqueId(){return"00000000-0000-0000-0000-000000000000"}get uniqueId(){return this.#a}static get tagName(){return"BODY"}static get assets(){return Unit.#t}get assets(){return this.#e}get ready(){return this.#i}connectedCallback(){this.#s||(Unit.#n(this,"method","upgrade",((...t)=>{Unit.#n(this,...t)})),this.upgrade("method","get",Unit.#r),this.upgrade("method","set",Unit.#o),this.upgrade("method","has",Unit.#l),this.#i=Unit.get("callback","initializeCallback")(this),this.#s=!0,this.setAttribute("bm-powered","")),this.#i=this.#i.then((()=>Unit.get("callback","connectedCallback")(this)))}disconnectedCallback(){this.#i=this.#i.then((()=>Unit.get("callback","disconnectedCallback")(this)))}adoptedCallback(){this.#i=this.#i.then((()=>Unit.get("callback","adoptedCallback")(this)))}attributeChangedCallback(t,e,s){if(this.#s)return Unit.get("callback","attributeChangedCallback")(this)}static#r(t,e,s){return this.assets[t].get(e,s)}static#o(t,e,s){this.assets[t].set(e,s)}static#l(t,e){this.assets[t].has(e)}static#n(t,e,s,i){switch(e){case"asset":t.assets[s]=i;break;case"method":t[s]=i;break;case"property":Object.defineProperty(t,s,i);break;default:t.assets[e].set(s,i)}}}customElements.define("bm-unit",Unit);class Util{static safeGet(t,e,s){let i=t,a=!0,n=e.split(".");for(let t=0;t<n.length;t++){if(null===i||"object"!=typeof i||!(n[t]in i)){a=!1;break}i=i[n[t]]}return a?i:s}static safeSet(t,e,s){let i=e.split("."),a=Util.#c(t,i);return Util.assert(null!==a&&"object"==typeof a,(()=>`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${e}, existingKey=${i.length>1?i[i.length-2]:""}, existingValue=${a}`),TypeError),a[i[i.length-1]]=s,t}static safeRemove(t,e){let s=!0,i=t,a=e.split(".");for(let t=0;t<a.length-1;t++){if(!(a[t]in i)){s=!1;break}i=i[a[t]]}return s&&delete i[a[a.length-1]],t}static safeMerge(t,e,s){let i=e.split("."),a=Util.#c(t,i);Util.assert(a&&"object"==typeof a,(()=>`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${e}, existingKey=${i.length>1?i[i.length-2]:""}, existingValue=${a}`),TypeError);let n=i[i.length-1];return a[n]=Util.deepMerge(a[n],s),t}static safeHas(t,e){let s=t,i=!0,a=e.split(".");for(let t=0;t<a.length;t++){if(!s||"object"!=typeof s||!(a[t]in s)){i=!1;break}s=s[a[t]]}return i}static safeEval(t,e){let s=!1;try{s=Function(`"use strict";return (${t})`).apply(e)}catch(t){}return s}static concatPath(t){let e=t[0]||"";for(let s=1;s<t.length;s++)t[s]&&("/"===e.slice(e.length-1)&&"/"===t[s].slice(0,1)?e+=t[s].slice(1):"/"===e.slice(e.length-1)||"/"===t[s].slice(0,1)?e+=t[s]:e?e+="/"+t[s]:e=t[s]);return e}static deepMerge(t,e){let s=t;return Array.isArray(t)?Array.isArray(e)?Array.prototype.push.apply(s,Util.#g(e)):s.push(Util.deepClone(e)):Util.#u(t)&&Util.#d(e)?Object.keys(e).forEach((i=>{s[i]=Util.deepMerge(t[i],e[i])})):void 0===e||(s=Util.deepClone(e)),s}static deepClone(t){return Array.isArray(t)?Util.#g(t):Util.#u(t)?Util.#_(t):t}static getClassNameFromTagName(t){let e;if("bm-unit"===t)e="Unit";else{let s=t.split("-");e=s[0].charAt(0).toUpperCase()+s[0].slice(1).toLowerCase()+s[1].charAt(0).toUpperCase()+s[1].slice(1).toLowerCase()}return e}static getTagNameFromClassName(t){let e,s=t,i=t.split("."),a=i[i.length-1];for(e=1;e<a.length&&!Util.#p(a.substring(e,e+1));e++);return e<a.length&&(s=a.substring(0,e).toLowerCase()+"-"+a.substring(e).toLowerCase()),s}static assert(t,e,s,i){if(!t){let t=new(s=s||Error)(e="function"==typeof e?e():e),i=t.stack.split("\n");throw i.splice(1,1),t.stack=i.join("\n"),t}}static warn(t,e,s,i){let a=!0;return e="function"==typeof e?e():e,t||(s=s||"warn",a=!1),a}static randomWait(t,e){let s=e?t:Math.floor(Math.random()*t);return new Promise(((t,e)=>{setTimeout((()=>{t()}),s)}))}static scopedSelectorAll(t,e,s){let i=t===Unit||t instanceof Unit?t.get("inventory","basic.unitRoot"):t,a=i instanceof DocumentFragment?e:":scope "+e.replace(",",",:scope "),n=i.querySelectorAll(a),r=new Set(n);if(!s||!s.penetrate){let t=i instanceof DocumentFragment?"[bm-powered] "+e.replace(",",", [bm-powered] "):":scope [bm-powered] "+e.replace(",",", :scope [bm-powered] "),s=i.querySelectorAll(t);new Set(s).forEach((t=>{r.delete(t)}))}return Array.from(r)}static getObject(t,e){let s;return Util.#u(t)?s=t:"string"==typeof t&&(s=e&&"js"===e.format?Util.safeEval(t,e&&e.bindTo):JSON.parse(t)),s}static#p(t){return t===t.toUpperCase()&&t!==t.toLowerCase()}static#c(t,e){let s=t;for(let t=0;t<e.length-1;t++)Util.assert(null!==s&&"object"==typeof s,(()=>`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. existingKey=${t>0?e[t-1]:""}, existingValue=${s}`),TypeError),e[t]in s||(s[e[t]]={}),s=s[e[t]];return s}static#_(t){let e={};return Object.keys(t).forEach((s=>{e[s]=Util.deepClone(t[s])})),e}static#g(t){let e=[];for(let s=0;s<t.length;s++)e.push(Util.deepClone(t[s]));return e}static#u(t){let e=typeof t,s=t&&t.constructor&&t.constructor.name;return null!==t&&"Object"===s&&"function"!==e}static#d(t){return Util.#u(t)||Array.isArray(t)}}class ClassUtil{static newUnit(t,e,s,i){s=s||Unit;let a=Function("superClass",`return function ${ClassUtil.#h(t)}(){ return Reflect.construct(superClass, [], this.constructor); }`)(s);return ClassUtil.inherit(a,s),(e=e||{}).setting=e.setting?e.setting:{},a.prototype._getSettings=function(){return e},i&&customElements.define(i.toLowerCase(),a),a}static inherit(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}static getClass(t){let e;if(BITSMIST.V1[t]&&(e=BITSMIST.V1[t]),e||globalThis[t]&&(e=globalThis[t]),!e)try{e=Function(`return (${ClassUtil.#h(t)})`)()}catch(t){if(!(t instanceof ReferenceError))throw t}return e}static#h(t){let e=/^[a-zA-Z0-9\-\._]+$/.test(t);return Util.assert(e,(()=>`ClassUtil.#__validateClassName(): Class name '${t}' is not valid.`),TypeError),t}}class AjaxUtil{static ajaxRequest(t){return new Promise(((e,s)=>{let i=Util.safeGet(t,"URL"),a=Util.safeGet(t,"method"),n=Util.safeGet(t,"data",""),r=Util.safeGet(t,"headers"),o=Util.safeGet(t,"options"),l=new XMLHttpRequest;l.open(a,i,!0),o&&Object.keys(o).forEach((t=>{l[t]=o[t]})),r&&Object.keys(r).forEach((t=>{l.setRequestHeader(t,r[t])})),l.addEventListener("load",(()=>{200===l.status||201===l.status?e(l):s(l)})),l.addEventListener("error",(()=>{s(l)})),l.send(n)}))}static loadScript(t){return new Promise(((e,s)=>{let i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>{e()},i.onerror=t=>{s(t)},document.getElementsByTagName("head")[0].appendChild(i)}))}static loadJSON(t,e){let s=Util.safeGet(e,"format",t.split("?")[0].split(".").pop());return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>Util.getObject(t.responseText,Object.assign({format:s},e))))}static loadText(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadHTML(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadCSS(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadClass(t,e){let s=t+".js";return Promise.resolve().then((()=>AjaxUtil.loadScript(s))).then((()=>{}))}}class URLUtil{static loadParameters(t){t=t||window.location.href;let e,s,i={};if(window.location.href.indexOf("?")>-1){let a=t.slice(t.indexOf("?")+1).split("&");for(let t=0;t<a.length;t++)e=a[t].split("="),s=e[1]?e[1].split("#")[0]:e[1],i[e[0]]=decodeURIComponent(s)}return i}static buildURL(t,e){let s=Object.assign({},URLUtil.parseURL(),t),i=t.URL?t.URL:Util.concatPath([s.protocol+"//",s.host,s.pathname]);if(s.queryParameters){let t={};e&&e.mergeParameters&&(t=Object.assign(t,URLUtil.loadParameters())),t=Object.assign(t,s.queryParameters),i+=URLUtil.buildQuery(t)}else i+=s.query;return i||"/"}static buildQuery(t){let e="";return t&&(e=Object.keys(t).reduce(((e,s)=>(Array.isArray(t[s])?e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s].join())}&`:t[s]&&(e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s])}&`),e)),"")),e?`?${e.slice(0,-1)}`:""}static parseURL(t){t=t||window.location.href;let e=new URL(t,window.location.href),s={protocol:e.protocol,username:e.username,password:e.password,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,path:e.pathname.substring(0,e.pathname.lastIndexOf("/")+1),search:e.search,query:e.search,hash:e.hash,filename:e.pathname.split("/").pop(),queryParameters:URLUtil.loadParameters(t)};return s.filenameWithoutExtension=s.filename.split(".")[0],s.extension=s.filename.split(".").pop(),s}}class Store{constructor(t){this._options=t||{},this._items=Util.safeGet(t,"items",{}),this.merger=Util.safeGet(t,"merger",Util.deepMerge)}get options(){return this._options}set options(t){this._options=t}get items(){return this.clone()}set items(t){this._items=t}get merger(){this._merger}set merger(t){Util.assert("function"==typeof t,`Store.merger(setter): Merger is not a function. merger=${t}`,TypeError),this._merger=t}clear(){this._items={}}clone(){return Util.deepMerge({},this._items)}merge(t,e){e=e||this._merger;let s=Array.isArray(t)?t:[t];for(let t=0;t<s.length;t++)this._items=e(this._items,s[t])}get(t,e){return Util.deepClone(Util.safeGet(this._items,t,e))}set(t,e,s){Util.safeSet(this._items,t,e)}remove(t){Util.safeRemove(this._items,t)}has(t){return Util.safeHas(this._items,t)}}class ChainableStore extends Store{constructor(t){super(t),this._chain;let e=Util.safeGet(this._options,"chain");e&&this.chain(e)}get localItems(){return Store.prototype.clone.call(this)}clone(){return this._chain?Util.deepMerge(this._chain.clone(),this._items):Store.prototype.clone.call(this)}chain(t){this._chain=t}get(t,e){let s=e;return Store.prototype.has.call(this,t)&&this._chain&&Store.prototype.has.call(this._chain,t)?s=Util.deepMerge(Store.prototype.get.call(this._chain,t),Store.prototype.get.call(this,t)):Store.prototype.has.call(this,t)?s=Store.prototype.get.call(this,t,e):this._chain&&(s=this._chain.get(t,e)),s}merge(t,e,s){Util.safeGet(s,"writeThrough",this._options.writeThrough)?this._chain.merge(t,e):Store.prototype.merge.call(this,t,e)}set(t,e,s){Util.safeGet(s,"writeThrough",this._options.writeThrough)?this._chain.set(t,e,s):Store.prototype.set.call(this,t,e,s)}has(t){let e=Util.safeHas(this._items,t);return!1===e&&this._chain&&(e=this._chain.has(t)),e}}class Perk{static#m={};static#k={};static#f={common:{}};static#y={sectionName:"perk",order:0};static#P={attachPerks:Perk.#S,attach:Perk.#U};static get info(){return Perk.#y}static get spells(){return Perk.#P}static globalInit(){}static init(t,e){}static deinit(t,e){}static registerPerk(t){let e=t.info;e.sectionName=e.sectionName,e.order="order"in e?e.order:500,e.depends=e.depends||[],e.depends=Array.isArray(e.depends)?e.depends:[e.depends],Perk.#m[t.name]={name:t.name,object:t,sectionName:e.sectionName,order:e.order,depends:e.depends},Object.hasOwn(t,"globalInit")&&t.globalInit(),Perk.#k[e.sectionName]=Perk.#m[t.name]}static getPerk(t){return Perk.#m[t].object}static getPerkFromSectionName(t){return Perk.#k[t].object}static registerHandler(t,e){e=e||"common",Perk.#f[e]||(Perk.#f[e]={}),Perk.#f[e][t.name]=t}static createHandler(t,...e){let s=Perk.#f[this.name]&&Perk.#f[this.name][t]||Perk.#f.common[t];return Util.assert(s,(()=>`Perk.createHandler(): Handler '${t}' is not registered.`),ReferenceError),new s(...e)}static#S(t,e){let s=e.settings,i=Promise.resolve(),a=Perk.#b(t,s);return Perk.#v(a).forEach((s=>{i=i.then((()=>Perk.#U(t,Perk.#m[s].object,e)))})),i}static#U(t,e,s){if(!t.assets.perk[e.name]){let i=Perk.#m[e.name].depends;for(let e=0;e<i.length;e++)Perk.#U(t,Perk.#m[i[e]].object,s);return t.assets.perk[e.name]=e,e.init(t,s)}}static#b(t,e){let s={};Promise.resolve();let i=Util.safeGet(e,"perk.options.apply");if(i)for(let e=0;e<i.length;e++){let a=i[e];Util.assert(Perk.#m[a],`Perk.#__listNewPerk(): Perk not found. name=${t.tagName}, perkName=${a}`),t.assets.perk[a]||(s[a]=Perk.#m[a])}return Object.keys(e).forEach((e=>{let i=Perk.#k[e];i&&!t.assets.perk[i.name]&&(s[i.name]=i)})),s}static#v(t){return Object.keys(t).sort(((e,s)=>t[e].order-t[s].order))}}class BasicPerk extends Perk{static#w={};static#E={tagName:{},className:{},id:{}};static#y={sectionName:"basic",order:0};static#C={scan:BasicPerk.#A,scanAll:BasicPerk.#N,locate:BasicPerk.#R,locateAll:BasicPerk.#j};static#P={start:BasicPerk.#T,stop:BasicPerk.#$,transform:BasicPerk.#L,setup:BasicPerk.#I,refresh:BasicPerk.#x,fetch:BasicPerk.#O,fill:BasicPerk.#G,clear:BasicPerk.#B};static get info(){return BasicPerk.#y}static get skills(){return BasicPerk.#C}static get spells(){return BasicPerk.#P}static globalInit(){Unit.upgrade("asset","inventory",new ChainableStore),Unit.upgrade("callback","initializeCallback",BasicPerk.#M.bind(BasicPerk)),Unit.upgrade("callback","connectedCallback",BasicPerk.#H.bind(BasicPerk)),Unit.upgrade("callback","disconnectedCallback",BasicPerk.#q.bind(BasicPerk)),Unit.upgrade("callback","adoptedCallback",BasicPerk.#H.bind(BasicPerk)),Unit.upgrade("callback","attributeChangedCallback",BasicPerk.#F.bind(BasicPerk)),Unit.upgrade("method","use",BasicPerk.#D),Unit.upgrade("method","cast",BasicPerk.#z),Unit.set("inventory","promise.documentReady",new Promise(((t,e)=>{"interactive"===document.readyState||"complete"===document.readyState?(Unit.set("inventory","basic.unitRoot",document.body),t()):document.addEventListener("DOMContentLoaded",(()=>{Unit.set("inventory","basic.unitRoot",document.body),t()}))})))}static#M(t){BasicPerk.#W(t),t.upgrade("asset","perk",{}),t.upgrade("asset","inventory",new ChainableStore({chain:Unit.assets.inventory})),t.upgrade("method","use",BasicPerk.#D),t.upgrade("method","cast",BasicPerk.#z),t.upgrade("inventory","basic.unitRoot",t);let e=Promise.resolve();return["BasicPerk","Perk","SettingPerk","UnitPerk","StatusPerk","EventPerk","SkinPerk","StylePerk"].forEach((s=>{e=e.then((()=>t.cast("perk.attach",Perk.getPerk(s))))})),e.then((()=>t.cast("basic.start")))}static#H(t){}static#q(t){return t.cast("basic.stop")}static#V(t){return t.cast("event.trigger","afterAdopt")}static#F(t,e,s,i){return t.cast("event.trigger","afterAttributeChange",{name:e,oldValue:s,newValue:i})}static#z(t,...e){let s=t.indexOf("."),i=t.slice(0,s),a=t.slice(s+1),n=Perk.getPerkFromSectionName(i).spells[a];return Util.assert("function"==typeof n,(()=>`Spell is not available. spellName=${t}`)),n.call(this,this,...e)}static#D(t,...e){let s=t.indexOf("."),i=Perk.getPerkFromSectionName(t.slice(0,s)).skills[t.slice(s+1)];return Util.assert("function"==typeof i,(()=>`Skill is not available. skillName=${t}`)),i.call(this,this,...e)}static#N(t,e,s){return Util.scopedSelectorAll(t,e,s)}static#A(t,e,s){let i=Util.scopedSelectorAll(t,e,s);return i?i[0]:null}static#j(t,e){return"object"!=typeof e?"string"==typeof e?BasicPerk.#E.tagName[e.toUpperCase()]:[e]:"selector"in e?document.querySelectorAll(e.selector):"scan"in e?(t.use("basic.scan",e.scan),t.use("basic.scanAll",e.scan)):"uniqueId"in e?[BasicPerk.#w[e.uniqueId].object]:"tagName"in e?BasicPerk.#E.tagName[e.tagName.toUpperCase()]:"object"in e?[e.object]:"id"in e?BasicPerk.#E.id[e.id]:"className"in e?BasicPerk.#E.className[e.className]:void 0}static#R(t,e){let s=BasicPerk.#j(t,e);if(s)return s[0]}static async#T(t,e){await t.cast("setting.apply",{settings:t.assets.setting.items}),await t.cast("event.trigger","beforeStart"),t.use("status.change","starting"),t.get("setting","basic.options.autoTransform",!0)&&await t.cast("basic.transform",{skinName:"default",styleName:"default"}),await t.cast("event.trigger","doStart"),t.get("setting","basic.options.autoRefresh",!0)&&await t.cast("basic.refresh"),t.use("status.change","started"),await t.cast("event.trigger","afterStart"),t.use("status.change","ready"),await t.cast("event.trigger","afterReady")}static async#$(t,e){e=e||{},t.use("status.change","stopping"),await t.cast("event.trigger","beforeStop",e),await t.cast("event.trigger","doStop",e),t.use("status.change","stopped"),await t.cast("event.trigger","afterStop",e)}static async#L(t,e){e=e||{},await t.cast("event.trigger","beforeTransform",e),t.get("setting","basic.options.autoSetup",!0)&&await t.cast("basic.setup",e),await t.cast("event.trigger","doTransform",e),await t.cast("unit.materializeAll",t),await t.cast("event.trigger","afterTransform",e)}static async#I(t,e){e=e||{},await t.cast("event.trigger","beforeSetup",e),await t.cast("event.trigger","doSetup",e),await t.cast("event.trigger","afterSetup",e)}static async#x(t,e){e=e||{},await t.cast("event.trigger","beforeRefresh",e),Util.safeGet(e,"autoClear",t.get("setting","basic.options.autoClear",!0))&&await t.cast("basic.clear",e),Util.safeGet(e,"autoFetch",t.get("setting","basic.options.autoFetch",!0))&&await t.cast("basic.fetch",e),Util.safeGet(e,"autoFill",t.get("setting","basic.options.autoFill",!0))&&await t.cast("basic.fill",e),await t.cast("event.trigger","doRefresh",e),await t.cast("event.trigger","afterRefresh",e)}static async#O(t,e){e=e||{},await t.cast("event.trigger","beforeFetch",e),await t.cast("event.trigger","doFetch",e),await t.cast("event.trigger","afterFetch",e)}static async#G(t,e){e=e||{},await t.cast("event.trigger","beforeFill",e),await t.cast("event.trigger","doFill",e),await t.cast("event.trigger","afterFill",e)}static async#B(t,e){e=e||{},await t.cast("event.trigger","beforeClear",e),await t.cast("event.trigger","doClear",e),await t.cast("event.trigger","afterClear",e)}static#W(t,e){let s=customElements.get(t.tagName.toLowerCase());BasicPerk.#w[t.uniqueId]={object:t,class:s},BasicPerk.#E.tagName[t.tagName]=BasicPerk.#E.tagName[t.tagName]||[],BasicPerk.#E.tagName[t.tagName].push(t),BasicPerk.#E.className[s.name]=BasicPerk.#E.className[s.name]||[],BasicPerk.#E.className[s.name].push(t),t.id&&(BasicPerk.#E.id[t.id]=BasicPerk.#E.id[t.id]||[],BasicPerk.#E.id[t.id].push(t))}}class SettingPerk extends Perk{static#y={sectionName:"setting",order:10};static#C={get:SettingPerk.#J,set:SettingPerk.#K,merge:SettingPerk.#Q};static#P={summon:SettingPerk.#X,apply:SettingPerk.#Y};static get info(){return SettingPerk.#y}static get skills(){return SettingPerk.#C}static get spells(){return SettingPerk.#P}static globalInit(){Unit.upgrade("asset","setting",new ChainableStore)}static async init(t,e){let s=e&&e.settings||{};s=SettingPerk.#Z(t,s),s=SettingPerk.#tt(t,s),t.upgrade("asset","setting",new ChainableStore({items:s,chain:Unit.assets.setting})),SettingPerk.#et(t),SettingPerk.#st(t)&&await SettingPerk.#X(t),SettingPerk.#et(t)}static#J(t,e,s){return t.get("setting",e,s)}static#K(t,e,s){return t.set("setting",e,s)}static#Q(t,e,s){t.assets.setting.merge(e,s)}static async#Y(t,e){await t.cast("event.trigger","beforeApplySettings",e),await t.cast("perk.attachPerks",e),await t.cast("event.trigger","doApplySettings",e),await t.cast("event.trigger","afterApplySettings",e)}static async#X(t,e){let s=await AjaxUtil.loadJSON(SettingPerk.#it(t),Object.assign({bindTo:t},e));s&&t.use("setting.merge",s)}static#et(t){if(t.hasAttribute("bm-settingsref")){let e=t.getAttribute("bm-settingsref")||!0;"false"===e&&(e=!1),t.set("setting","setting.options.settingsRef",e)}if(t.hasAttribute("bm-options")){let e={options:JSON.parse(t.getAttribute("bm-options"))};t.use("setting.merge",e)}if(t.hasAttribute("bm-path")&&t.set("setting","setting.options.path",t.getAttribute("bm-path")),t.hasAttribute("bm-filename")&&t.set("setting","setting.options.fileName",t.getAttribute("bm-filename")),t.hasAttribute("bm-autoload")){let e=t.getAttribute("bm-autoload");if(e){let s=URLUtil.parseURL(e);t.set("setting","setting.options.path",s.path),t.set("setting","setting.options.fileName",s.filenameWithoutExtension)}}}static#st(t){let e=!1;return t.get("setting","setting.options.settingsRef",t.get("setting","system.setting.options.settingsRef"))&&(e=!0),e}static#it(t){let e,s,i,a=t.get("setting","setting.options.settingsRef");if(a&&!0!==a){let t=URLUtil.parseURL(a);e=t.path,s=t.filename,i=t.query}else{e=Util.concatPath([t.get("setting","system.setting.options.path",t.get("setting","system.unit.options.path","")),t.get("setting","setting.options.path",t.get("setting","unit.options.path",""))]);let a=t.get("setting","setting.options.settingFormat",t.get("setting","system.setting.options.settingFormat","json"));s=t.get("setting","setting.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase()))+".settings."+a,i=t.get("setting","unit.options.query")}return Util.concatPath([e,s])+(i?`?${i}`:"")}static#Z(t,e){return"function"==typeof t._injectSettings&&(e=t._injectSettings.call(t,e)),e}static#tt(t,e){let s,i=Object.getPrototypeOf(t),a={};for(;"function"==typeof Object.getPrototypeOf(i)._getSettings;)s=Object.getPrototypeOf(i)._getSettings.call(t),Object.keys(s).length>0&&(Util.deepMerge(s,a),a=s),i=Object.getPrototypeOf(i);return Util.deepMerge(e,a),"function"==typeof t._getSettings&&Util.deepMerge(e,t._getSettings.call(t)),e}}class StatusPerk extends Perk{static#at={};static#nt=new Store;static#y={sectionName:"status",order:100};static#C={change:StatusPerk.#rt};static#P={wait:StatusPerk.#ot};static get info(){return StatusPerk.#y}static get skills(){return StatusPerk.#C}static get spells(){return StatusPerk.#P}static globalInit(){StatusPerk.waitFor=function(t,e){return StatusPerk.#ot(Unit,t,e)}}static init(t,e){t.upgrade("inventory","status.status","connected"),t.use("event.add","doApplySettings",{handler:StatusPerk.#lt,order:StatusPerk.info.order})}static#lt(t,e,s){Object.entries(Util.safeGet(e.detail,"settings.status.waitFor",{})).forEach((([t,e])=>{StatusPerk.addEventHandler(t,{handler:StatusPerk.#ct,options:e})}))}static#ct(t,e,s){return StatusPerk.#ot(this,s.options)}static#rt(t,e){Util.assert(StatusPerk.#gt(t.get("inventory","status.status"),e),(()=>`StatusPerk.#_changeStatus(): Illegal transition. name=${t.tagName}, fromStatus=${t.get("inventory","status.status")}, toStatus=${e}, id=${t.id}`),Error),t.set("inventory","status.status",e),StatusPerk.#at[t.uniqueId]={status:e},StatusPerk.#ut()}static#ot(t,e,s){let i,a=s&&s.timeout||t.get("setting","status.options.waitForTimeout",t.get("setting","system.status.options.waitForTimeout",1e4)),n={waiter:s&&s.waiter?s.waiter:t,waitlist:Util.deepClone(e)};return StatusPerk.#dt(n)?i=Promise.resolve():(i=new Promise(((s,i)=>{n.resolve=s,n.reject=i,n.timer=setTimeout((()=>{let s=t&&t.tagName||n.waiter&&n.waiter.tagName||"",r=t&&t.uniqueId||"";i(`StatusPerk.#_waitFor(): Timed out after ${a} milliseconds waiting for ${StatusPerk.#_t(e)}, name=${s}, uniqueId=${r}.`)}),a)})),n.promise=i,StatusPerk.#pt(n)),i}static#ut(){let t=[];Object.keys(StatusPerk.#nt.items).forEach((e=>{StatusPerk.#dt(StatusPerk.#nt.get(e))&&(clearTimeout(StatusPerk.#nt.get(e).timer),StatusPerk.#nt.get(e).resolve(),t.push(e))}));for(let e=0;e<t.length;e++)StatusPerk.#nt.remove(t[e])}static#pt(t){let e=n();StatusPerk.#nt.set(e,t)}static#gt(t,e){let s=!0;return t&&"ing"===t.slice(-3)&&("stopping"===t&&"stopped"!==e||"starting"===t&&"started"!==e)&&(s=!1),s}static#ht(t,e){let s,i=t.use("basic.locate",e);return i&&(s=StatusPerk.#at[i.uniqueId]),s}static#dt(t){let e=!0,s=t.waitlist;for(let i=0;i<s.length;i++){let a=!1,n=StatusPerk.#ht(t.waiter,s[i]);if(n&&StatusPerk.#mt(n.status,s[i].status)&&(a=!0),!a){e=!1;break}}return e}static#mt(t,e){e=e||"ready";let s=!1;switch(t){case"ready":"ready"!==e&&"started"!==e&&"starting"!==e||(s=!0);break;case"started":"started"!==e&&"starting"!==e||(s=!0);break;case"stopped":"stopped"!==e&&"stopping"!==e||(s=!0);break;default:t===e&&(s=!0)}return s}static#_t(t){let e="";for(let s=0;s<t.length;s++)if("string"==typeof t[s])e+=`\n\t{"${t[s]}", status:ready},`;else{e+=`\n\t{${`uniqueId:${t[s].uniqueId}, `}${t[s].id?`id:${t[s].id}, `:""}${t[s].tagName?`tagName:${t[s].tagName}, `:""}${t[s].object?`object:${t[s].object.tagName}, `:""}${t[s].selector?`selector:${t[s].selector}, `:""}${t[s].status?`status:${t[s].status}`:"status:ready"}},`}return`[${e}\n]`}static#kt(){let t={},e=new Promise(((e,s)=>{t.resolve=e,t.reject=s,t.status="pending"}));return t.promise=e,t}}class SkinPerk extends Perk{static#y={sectionName:"skin",order:210};static#C={apply:SkinPerk.#ft};static#P={summon:SkinPerk.#yt};static get info(){return SkinPerk.#y}static get skills(){return SkinPerk.#C}static get spells(){return SkinPerk.#P}static init(t,e){let s;switch(t.upgrade("inventory","skin.skins",{}),t.upgrade("inventory","skin.active.skinName",""),t.use("event.add","beforeTransform",{handler:SkinPerk.#Pt,order:SkinPerk.info.order}),t.use("event.add","doTransform",{handler:SkinPerk.#St,order:SkinPerk.info.order}),SkinPerk.#et(t),SkinPerk.#Ut(t),t.get("setting","skin.options.shadowDOM",t.get("setting","system.skin.options.shadowDOM"))){case"open":case"closed":s=t.attachShadow({mode:"open"}),t.set("inventory","skin.shadowRoot",s),t.set("inventory","basic.unitRoot",s)}}static async#Pt(t,e,s){if(this.get("setting","skin.options.hasSkin",!0)){let t=await SkinPerk.#yt(this,e.detail.skinName,e.detail.skinOptions);this.get("inventory","basic.unitRoot").textContent="",this.set("inventory","basic.unitRoot",t.template.content.cloneNode(!0))}}static#St(t,e,s){if(this.get("setting","skin.options.hasSkin",!0))return SkinPerk.#ft(this,e.detail.skinName,this.get("inventory","basic.unitRoot"))}static#ft(t,e,s){let i=t.get("inventory",`skin.skins.${e}`);Util.assert(i,(()=>`SkinPerk.#_applySkin(): Skin not loaded. name=${t.tagName}, skinName=${e}, id=${t.id}, uniqueId=${t.uniqueId}`),ReferenceError),s=s||this.get("inventory","basic.unitRoot"),t.set("inventory","basic.unitRoot",t.get("inventory","skin.shadowRoot",t)),t.get("inventory","basic.unitRoot").innerHTML="",t.get("inventory","basic.unitRoot").appendChild(s),t.set("inventory","skin.active.skinName",e)}static#yt(t,e,s){let i=Promise.resolve(),a=t.get("inventory",`skin.skins.${e}`)||SkinPerk.#bt(t,e),n=s||t.get("setting",`skin.skins.${e}`,{});if("loaded"===a.status)return Promise.resolve(a);switch(n.type){case"HTML":a.HTML=n.HTML;break;case"node":let s=t.use("basic.scan",n.selector||"");Util.assert(s,(()=>`SkinPerk.#_loadSkin(): Node does not exist. name=${t.tagName}, skinName=${e}, selector=${n.selector}`)),a.HTML=s.innerHTML;break;case"URL":default:let r=n.URL||SkinPerk.#vt(t,e,n);Util.assert(r,(()=>`SkinPerk.#_loadSkin(): Skin URL is not speicified. name=${t.tagName}, skinName=${e}`)),i=AjaxUtil.loadHTML(r).then((t=>{a.HTML=t})),a.promise=i,a.status="loading";break;case"inline":i=new Promise(((e,s)=>{setTimeout((()=>{a.HTML=t.firstElementChild&&"TEMPLATE"===t.firstElementChild.tagName?t.firstElementChild.innerHTML:t.innerHTML,t.innerHTML="",e()}),1)})),a.promise=i,a.status="loading"}return i.then((()=>(a.template=document.createElement("template"),a.template.innerHTML=a.HTML,a.status="loaded",a)))}static#et(t){if(t.hasAttribute("bm-skinref")){let e=t.getAttribute("bm-skinref")||!0;"false"===e&&(e=!1),t.set("setting","skin.options.skinRef",e)}}static#Ut(t){let e=t.get("setting","skin.options.skinRef");if(!1===e)t.set("setting","skin.options.hasSkin",!1);else{let s=t.get("setting","skin.skins.default",{});s.type=s.type||"URL",s.URL=s.URL||("string"==typeof e?e:""),t.set("setting","skin.skins.default",s)}}static#bt(t,e){let s={name:e,HTML:"",template:null,status:""};return t.set("inventory",`skin.skins.${e}`,s),s}static#vt(t,e,s){let i,a,n,r=t.get("setting","skin.options.skinRef");if(r&&!0!==r){let t=URLUtil.parseURL(r);i=t.path,a=t.filename,n=t.query}else i=Util.concatPath([t.get("setting","system.skin.options.path",t.get("setting","system.unit.options.path","")),Util.safeGet(s,"path",t.get("setting","skin.options.path",t.get("setting","unit.options.path","")))]),a=SkinPerk.#wt(t,e,s)+".html",n=t.get("setting","unit.options.query");return Util.concatPath([i,a])+(n?`?${n}`:"")}static#wt(t,e,s){return Util.safeGet(s,"fileName",t.get("setting","skin.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase())))}}class StylePerk extends Perk{static#Et=new WeakMap;static#Ct={};static#At={};static#y={sectionName:"style",order:200};static#P={summon:StylePerk.#Nt,apply:StylePerk.#Rt};static get info(){return StylePerk.#y}static get spells(){return StylePerk.#P}static globalInit(){StylePerk.#Et.set(Unit,{applied:[]}),Unit.upgrade("inventory","style.styles",new ChainableStore),StylePerk.#At.promise=new Promise(((t,e)=>{StylePerk.#At.resolve=t,StylePerk.#At.reject=e})),Promise.resolve(),Unit.get("inventory","promise.documentReady").then((()=>{let t=[];return Object.entries(Unit.get("setting","system.style.styles",{})).forEach((([e,s])=>{t.push(StylePerk.#Nt(Unit,e,s,!0))})),Promise.all(t).then((()=>{let t=Promise.resolve(),e=Unit.get("setting","system.style.options.apply",[]);for(let s=0;s<e.length;s++)t=t.then((()=>StylePerk.#Rt(Unit,e[s])));return t.then((()=>{StylePerk.#At.resolve()}))}))}))}static init(t,e){StylePerk.#Et.set(t,{applied:[]}),t.upgrade("inventory","style.styles",new ChainableStore({chain:Unit.get("inventory","style.styles")})),t.use("event.add","beforeTransform",{handler:StylePerk.#jt,order:StylePerk.info.order}),t.use("event.add","doTransform",{handler:StylePerk.#Tt,order:StylePerk.info.order}),StylePerk.#et(t),StylePerk.#Ut(t)}static#jt(t,e,s){return StylePerk.#At.promise.then((()=>{let t=[],s=this.get("setting","style.options.apply",[]);this.get("setting","style.options.hasStyle",!0)&&(s=s.concat(this.get("setting",`style.styles.${e.detail.styleName}.apply`,[])),t.push(StylePerk.#Nt(this,e.detail.styleName,e.detail.styleOptions)));for(let e=0;e<s.length;e++)t.push(StylePerk.#Nt(this,s[e]));return Promise.all(t)}))}static#Tt(t,e,s){let i=this.get("setting","style.options.apply",[]);this.get("setting","style.options.hasStyle",!0)&&(i=i.concat(this.get("setting",`style.styles.${e.detail.styleName}.apply`,[])),i.push(e.detail.styleName)),StylePerk.#$t(this);let a=Promise.resolve();for(let t=0;t<i.length;t++)a=a.then((()=>StylePerk.#Rt(this,i[t])));return a}static#Nt(t,e,s,i){let a=Promise.resolve(),n=t.get("inventory","style.styles").get(e)||StylePerk.#Lt(t,e),r=s||t.get("setting",`style.styles.${e}`,{});if("loaded"===n.status)return Promise.resolve(n);if("CSS"===r.type)n.CSS=r.CSS;else if("loading"===n.status)a=n.promise;else{let s=r.URL||StylePerk.#vt(t,e,r);Util.assert(s,(()=>`StylePerk.#_loadCSS(): CSS URL is not speicified. name=${t.tagName}, styleName=${e}`)),a=AjaxUtil.loadCSS(s).then((t=>{n.CSS=t})),n.promise=a,n.status="loading"}return a.then((()=>(n.status="loaded",n.shared=i,n)))}static async#Rt(t,e){let s=t.get("inventory","style.styles").get(e);Util.assert(s,(()=>`StylePerk.#_applyCSS(): CSS not loaded. name=${t.tagName||"Global"}, styleName=${e}, id=${t.id}, uniqueId=${t.uniqueId}`),ReferenceError);let i=new CSSStyleSheet;await i.replace(`${s.CSS}`);let a=t.get("inventory","skin.shadowRoot");a?a.adoptedStyleSheets=[...a.adoptedStyleSheets,i]:(!((e=s.shared?e:`${t.tagName}.${e}`)in StylePerk.#Ct)||StylePerk.#Ct[e].count<=0?(StylePerk.#Ct[e]=StylePerk.#Ct[e]||{},document.adoptedStyleSheets=[...document.adoptedStyleSheets,i],StylePerk.#Ct[e].object=i,StylePerk.#Ct[e].count=1):StylePerk.#Ct[e].count++,StylePerk.#Et.get(t).applied.push(e))}static#$t(t){let e=t.get("inventory","skin.shadowRoot");if(e)e.adoptedStyleSheets=[];else{let e=StylePerk.#Et.get(t).applied;if(e.length>0){for(let t=0;t<e.length;t++)StylePerk.#Ct[e[t]].count--;StylePerk.#Et.get(t).applied=[],document.adoptedStyleSheets=[],Object.keys(StylePerk.#Ct).forEach((t=>{StylePerk.#Ct[t].count>0&&(document.adoptedStyleSheets=[...document.adoptedStyleSheets,StylePerk.#Ct[t].object])}))}}}static#et(t){if(t.hasAttribute("bm-styleref")){let e=t.getAttribute("bm-styleref")||!0;"false"===e&&(e=!1),t.set("setting","style.options.styleRef",e)}}static#Ut(t){let e=t.get("setting","style.options.styleRef");if(!1===e)t.set("setting","style.options.hasStyle",!1);else if(e){let s=t.get("setting","style.styles.default",{});s.type=s.type||"URL",s.URL=s.URL||("string"==typeof e?e:""),t.set("setting","style.styles.default",s),t.set("setting","style.options.hasStyle",!0)}}static#Lt(t,e){let s={name:e,CSS:"",status:""};return t.get("inventory","style.styles").set(e,s),s}static#vt(t,e,s){let i,a,n,r=t.get("setting","style.options.styleRef");if(r&&!0!==r){let t=URLUtil.parseURL(r);i=t.path,a=t.filename,n=t.query}else i=Util.concatPath([t.get("setting","system.style.options.path",t.get("setting","system.unit.options.path","")),Util.safeGet(s,"path",t.get("setting","style.options.path",t.get("setting","unit.options.path","")))]),a=StylePerk.#wt(t,e,s)+".css",n=t.get("setting","unit.options.query");return Util.concatPath([i,a])+(n?`?${n}`:"")}static#wt(t,e,s){return Util.safeGet(s,"fileName",t.get("setting","style.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase())))}}class EventPerk extends Perk{static#It=new WeakMap;static#y={sectionName:"event",order:210};static#C={add:EventPerk.#xt,remove:EventPerk.#Ot,init:EventPerk.#Gt,reset:EventPerk.#Bt,triggerSync:EventPerk.#Mt};static#P={trigger:EventPerk.#Ht};static get info(){return EventPerk.#y}static get skills(){return EventPerk.#C}static get spells(){return EventPerk.#P}static init(t,e){t.use("event.add","doApplySettings",{handler:EventPerk.#qt,order:EventPerk.info.order}),t.use("event.add","afterTransform",{handler:EventPerk.#Ft,order:EventPerk.info.order})}static deinit(t,e){let s=t.get("setting","event");s&&Object.keys(s).forEach((e=>{EventPerk.#Bt(t,e,s[eventName])}))}static#qt(t,e,s){Object.entries(Util.safeGet(e.detail,"settings.event.events",{})).forEach((([t,e])=>{EventPerk.#Gt(this,t,e)}))}static#Ft(t,e,s){Object.entries(this.get("setting","event.events",{})).forEach((([t,e])=>{EventPerk.#Dt(t,e)||EventPerk.#Gt(this,t,e)}))}static#xt(t,e,s,i,a){i=i||t;let n="object"==typeof s?s:{},r=EventPerk.#zt(t,s);Util.assert(r,(()=>`EventPerk.#_addEventHandler(): handler not found. name=${t.tagName}, eventName=${e}`)),EventPerk.#It.get(i)||EventPerk.#It.set(i,{unit:t,listeners:{},promises:{},statuses:{}});let o=EventPerk.#It.get(i).listeners;o[e]||(o[e]=[],i.addEventListener(e,EventPerk.#Wt,n.listnerOptions));let l=Util.safeGet(n,"order",1e3);o[e].push({handler:r,options:n.options,bindTo:a,order:l}),o[e].sort(((t,e)=>t.order===e.order?0:t.order>e.order?1:-1))}static#Ot(t,e,s,i){i=i||t;let a=EventPerk.#zt(t,s);Util.assert(a,(()=>`EventPerk.#_removeEventHandler(): handler not found. name=${t.tagName}, eventName=${e}`));let n=Util.safeGet(EventPerk.#It.get(i),`.listeners.${e}`);if(n)for(let t=n.length-1;t>=0;t--)if(n[t].handler===a){n.splice(t,1);break}}static#Gt(t,e,s,i){s=s||t.get("setting",`event.events.${e}`);let a=EventPerk.#Vt(t,i,e,s);Object.keys(s.handlers).forEach((e=>{let i=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<i.length;s++)for(let n=0;n<a.length;n++)EventPerk.#xt(t,e,i[s],a[n])}))}static#Bt(t,e,s,i){s=s||t.get("setting",`event.events.${e}`);let a=EventPerk.#Vt(t,i,e,s);Object.keys(s.handlers).forEach((e=>{let i=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<i.length;s++)for(let n=0;n<a.length;n++)t.removeEventHandler(e,i[s],a[n])}))}static#Ht(t,e,s,i){return s=s||{},(i=i||t).dispatchEvent(new CustomEvent(e,{detail:s})),Util.safeGet(EventPerk.#It.get(i),`promises.${e}`)||Promise.resolve()}static#Mt(t,e,s,i){return(s=s||{}).async=!0,EventPerk.#Ht(t,e,s,i)}static#zt(t,e){return"object"==typeof e?e.handler:e}static#Dt(t,e){let s=!1;return("this"===t||e&&"this"===e.selector)&&(s=!0),s}static#Vt(t,e,s,i){let a;return e=e||t,a=EventPerk.#Dt(s,i)?[e]:i&&i.selector?Util.scopedSelectorAll(e,i.selector):Util.scopedSelectorAll(e,`#${s}`),a}static#Jt(t,e,s){let i=!1,a=Util.safeGet(EventPerk.#It.get(t),`listeners.${e}`);if(a)for(let t=0;t<a.length;t++)if(a[t].handler===s){i=!0;break}return i}static#Wt(t){let e=EventPerk.#It.get(this),s=Util.safeGet(e,`listeners.${t.type}`),i=Util.safeGet(t,"detail.sender",this),a=Util.safeGet(e,"unit"),n=`statuses.${t.type}`,r=`promises.${t.type}`;if(Util.safeSet(e,n,"handling"),!1===Util.safeGet(t,"detail.async",!1))e.promises[t.type]=EventPerk.#Kt(t,i,a,s).then((()=>{Util.safeSet(e,r,null),Util.safeSet(e,n,"")})).catch((t=>{throw Util.safeSet(e,r,null),Util.safeSet(e,n,""),t}));else try{e.promises[t.type]=EventPerk.#Qt(t,i,a,s),Util.safeSet(e,r,null),Util.safeSet(e,n,"")}catch(t){throw Util.safeSet(e,r,null),Util.safeSet(e,n,""),t}}static#Kt(t,e,s,i){let a=Promise.resolve(),n=!1;for(let r=0;r<i.length;r++){let o={unit:s,options:i[r].options?i[r].options:{}};a=a.then((()=>{let a=i[r].handler;a="string"==typeof a?s[a]:a,Util.assert("function"==typeof a,(()=>`EventPerk.#__handle(): Event handler is not a function. name=${s.tagName}, eventName=${t.type}`),TypeError);let n=i[r].bindTo?i[r].bindTo:s;return a.call(n,e,t,o)})),n=!(!i[r].options||!i[r].options.stopPropagation)||n}return n&&t.stopPropagation(),a}static#Qt(t,e,s,i){let a=!1;for(let n=0;n<i.length;n++){let r={unit:s,options:i[n].options?i[n].options:{}},o=i[n].handler;o="string"==typeof o?s[o]:o,Util.assert("function"==typeof o,(()=>`EventPerk.#__handleSync(): Event handler is not a function. name=${s.tagName}, eventName=${t.type}`),TypeError);let l=i[n].bindTo?i[n].bindTo:s;o.call(l,e,t,r),a=!(!i[n].options||!i[n].options.stopPropagation)||a}return a&&t.stopPropagation(),Promise.resolve()}}class UnitPerk extends Perk{static#Xt={Unit:{status:"loaded"}};static#y={sectionName:"unit",order:400};static#P={materializeAll:UnitPerk.#Yt,materialize:UnitPerk.#Zt,summon:UnitPerk.#te};static get info(){return UnitPerk.#y}static get spells(){return UnitPerk.#P}static async globalInit(){await Unit.get("inventory","promise.documentReady"),Unit.get("setting","system.unit.options.autoLoadOnStartup",!0)&&UnitPerk.#Yt(null,document.body,{waitForTags:!1})}static init(t,e){t.upgrade("inventory","unit.units",{}),t.use("event.add","doApplySettings",{handler:UnitPerk.#ee,order:UnitPerk.info.order});let s=UnitPerk.#et(t);t.use("setting.merge",s)}static#ee(t,e,s){let i=Promise.resolve();return Object.entries(Util.safeGet(e.detail,"settings.unit.units",{})).forEach((([t,e])=>{i=i.then((()=>{if(!this.get("inventory",`unit.units.${t}.object`)){let s=Util.safeGet(e,"unit.options.parentUnit");return(s?this.use("basic.locate",s):this).cast("unit.materialize",t,e)}}))})),i}static#te(t,e){t=t.toLowerCase();let s=Util.safeGet(e,"unit.options.className",Util.getClassNameFromTagName(t)),i=Util.safeGet(e,"unit.options.autoMorph",s);i=!0===i?"Unit":i;let a=Promise.resolve();return UnitPerk.#se(t,i,e)&&(UnitPerk.#Xt[i]&&"loading"===UnitPerk.#Xt[i].status?a=UnitPerk.#Xt[i].promise:(UnitPerk.#Xt[i]={status:"loading"},a=AjaxUtil.loadClass(UnitPerk.#ie(t,e)).then((()=>{UnitPerk.#Xt[i]={status:"loaded"}})),UnitPerk.#Xt[i].promise=a)),a.then((()=>{if(i!==s){let a=ClassUtil.getClass(i);ClassUtil.newUnit(s,e,a,t),UnitPerk.#Xt[s]={status:"loaded"}}if(!customElements.get(t)){let e=ClassUtil.getClass(s);Util.assert(e,(()=>`UnitPerk.#_loadClass(): Class does not exist. tagName=${t}, className=${s}`)),customElements.define(t,e)}}))}static async#Zt(t,e,s,i){if(t.get("inventory",`unit.units.${e}.object`))return Promise.resolve(t.get("inventory",`unit.units.${e}.object`));let a=Util.safeGet(s,"unit.options.tag");a&&(e=a.match(/([\w-]+)\s+\w+.*?>/)[1]),await UnitPerk.#te(e,s);let n=await UnitPerk.#ae(t,e,s);t.set("inventory",`unit.units.${e}.object`,n);let r=Util.safeGet(i,"syncOnAdd",Util.safeGet(s,"unit.options.syncOnAdd"));return r&&await t.cast("status.wait",[{uniqueId:n.uniqueId,status:!0===r?"ready":r}]),n}static#Yt(t,e,s){let i=[];return Util.scopedSelectorAll(e,"[bm-autoload]:not([bm-autoloading]):not([bm-powered]),[bm-automorph]:not([bm-autoloading]):not([bm-powered]),[bm-classref]:not([bm-autoloading]):not([bm-powered]),[bm-htmlref]:not([bm-autoloading]):not([bm-powered])").forEach((t=>{let e=UnitPerk.#et(t);t.setAttribute("bm-autoloading",""),t._injectSettings=function(t){return Util.deepMerge(t,e)},i.push(UnitPerk.#te(t.tagName,e).then((()=>{t.removeAttribute("bm-autoloading")})))})),Promise.all(i).then((()=>{if(Util.safeGet(s,"waitForTags"))return UnitPerk.#ne(e)}))}static#et(t){let e={unit:{options:{}}};if(t.hasAttribute("bm-classname")&&(e.unit.options.className=t.getAttribute("bm-classname")),t.hasAttribute("bm-splitclass")){let s=t.getAttribute("bm-splitclass")||!0;"false"===s&&(s=!1),e.unit.options.splitClass=s}return t.hasAttribute("bm-path")&&(e.unit.options.path=t.getAttribute("bm-path")),t.hasAttribute("bm-filename")&&(e.unit.options.fileName=t.getAttribute("bm-filename")),t.hasAttribute("bm-automorph")&&(e.unit.options.autoMorph=!t.getAttribute("bm-automorph")||t.getAttribute("bm-automorph")),t.hasAttribute("bm-htmlref")&&(e.unit.options.autoMorph=!t.getAttribute("bm-htmlref")||t.getAttribute("bm-htmlref")),t.hasAttribute("bm-autoload")&&(e.unit.options.autoLoad=!t.getAttribute("bm-autoload")||t.getAttribute("bm-autoload")),t.hasAttribute("bm-classref")&&(e.unit.options.autoLoad=!t.getAttribute("bm-classref")||t.getAttribute("bm-classref")),UnitPerk.#Ut(t,e)}static#Ut(t,e){let s=Util.safeGet(e,"unit.options.autoLoad");if("string"==typeof s){let t=URLUtil.parseURL(s);e.unit.options.path=t.path,e.unit.options.fileName=t.filenameWithoutExtension,"html"===t.extension&&(e.unit.options.autoMorph=Util.safeGet(e,"unit.options.autoMorph",!0))}return e}static#se(t,e,s){let i=!1;return(Util.safeGet(s,"unit.options.classRef")||Util.safeGet(s,"unit.options.htmlRef")||Util.safeGet(s,"unit.options.autoLoad")||Util.safeGet(s,"unit.options.autoMorph"))&&(i=!0,(UnitPerk.#Xt[e]&&"loaded"===UnitPerk.#Xt[e].status||customElements.get(t)||ClassUtil.getClass(e))&&(i=!1)),i}static#ae(t,e,s){let i,a;a=Util.safeGet(s,"unit.options.parentNode")?t.use("basic.scan",Util.safeGet(s,"unit.options.parentNode")):this.get("inventory","basic.unitRoot"),Util.assert(a,(()=>`UnitPerk.#__insertTag(): Root node does not exist. name=${t.tagName}, tagName=${e}, parentNode=${Util.safeGet(s,"unit.options.parentNode")}`),ReferenceError);let n=Util.safeGet(s,"unit.options.tag")?Util.safeGet(s,"unit.options.tag"):`<${e}></${e}>`;if(Util.safeGet(s,"unit.options.replaceParent"))a.outerHTML=n,i=a;else{let t=Util.safeGet(s,"unit.options.adjacentPosition","afterbegin");switch(a.insertAdjacentHTML(t,n),t){case"beforebegin":i=a.previousSibling;break;case"afterbegin":i=a.children[0];break;case"beforeend":i=a.lastChild;break;case"afterend":i=a.nextSibling}}return i._injectSettings=function(t){return Util.deepMerge(t,s)},i}static#ne(t){let e=[];return Util.scopedSelectorAll(t,"[bm-powered],[bm-autoloading]").forEach((s=>{if(t!=s.rootElement&&!s.hasAttribute("bm-nowait")){let t={object:s,status:"ready"};e.push(t)}})),StatusPerk.waitFor(e,{waiter:t})}static#ie(t,e){let s=Util.concatPath([Util.safeGet(e,"system.unit.options.path",Unit.get("setting","system.unit.options.path","")),Util.safeGet(e,"unit.options.path","")]),i=Util.safeGet(e,"unit.options.fileName",t),a=Util.safeGet(e,"unit.options.query");return Util.concatPath([s,i])+(a?`?${a}`:"")}}Perk.registerPerk(Perk),Perk.registerPerk(BasicPerk),Perk.registerPerk(SettingPerk),Perk.registerPerk(StatusPerk),Perk.registerPerk(SkinPerk),Perk.registerPerk(StylePerk),Perk.registerPerk(EventPerk),Perk.registerPerk(UnitPerk),globalThis.BITSMIST&&(globalThis.BITSMIST.V1.Unit=Unit);export{AjaxUtil,ChainableStore,ClassUtil,Perk,Store,URLUtil,Unit,Util};
