let t;const e=new Uint8Array(16);function s(){if(!t&&(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(e)}const i=[];for(let t=0;t<256;++t)i.push((t+256).toString(16).slice(1));var a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function n(t,e,n){if(a.randomUUID&&!e&&!t)return a.randomUUID();const r=(t=t||{}).random||(t.rng||s)();return r[6]=15&r[6]|64,r[8]=63&r[8]|128,function(t,e=0){return i[t[e+0]]+i[t[e+1]]+i[t[e+2]]+i[t[e+3]]+"-"+i[t[e+4]]+i[t[e+5]]+"-"+i[t[e+6]]+i[t[e+7]]+"-"+i[t[e+8]]+i[t[e+9]]+"-"+i[t[e+10]]+i[t[e+11]]+i[t[e+12]]+i[t[e+13]]+i[t[e+14]]+i[t[e+15]]}(r)}class Unit extends HTMLElement{static#t={callback:new Map};#e={};#s;#i;#a=n();static{Unit.#n(Unit,"method","upgrade",((...t)=>{Unit.#n(Unit,...t)})),Unit.upgrade("method","get",Unit.#r),Unit.upgrade("method","set",Unit.#l),Unit.upgrade("method","has",Unit.#o)}static get uniqueId(){return"00000000-0000-0000-0000-000000000000"}get uniqueId(){return this.#a}static get tagName(){return"BODY"}static get assets(){return Unit.#t}get assets(){return this.#e}get ready(){return this.#i}connectedCallback(){this.#s||(Unit.#n(this,"method","upgrade",((...t)=>{Unit.#n(this,...t)})),this.upgrade("method","get",Unit.#r),this.upgrade("method","set",Unit.#l),this.upgrade("method","has",Unit.#o),this.#i=Unit.get("callback","initializeCallback")(this),this.#s=!0,this.setAttribute("bm-powered","")),this.#i=this.#i.then((()=>Unit.get("callback","connectedCallback")(this)))}disconnectedCallback(){this.#i=this.#i.then((()=>Unit.get("callback","disconnectedCallback")(this)))}adoptedCallback(){this.#i=this.#i.then((()=>Unit.get("callback","adoptedCallback")(this)))}attributeChangedCallback(t,e,s){if(this.#s)return Unit.get("callback","attributeChangedCallback")(this)}static#r(t,e,s){return this.assets[t].get(e,s)}static#l(t,e,s){this.assets[t].set(e,s)}static#o(t,e){this.assets[t].has(e)}static#n(t,e,s,i){switch(e){case"asset":t.assets[s]=i;break;case"method":t[s]=i;break;case"property":Object.defineProperty(t,s,i);break;default:t.assets[e].set(s,i)}}}customElements.define("bm-unit",Unit);class Util{static safeGet(t,e,s){let i=t,a=!0,n=e.split(".");for(let t=0;t<n.length;t++){if(null===i||"object"!=typeof i||!(n[t]in i)){a=!1;break}i=i[n[t]]}return a?i:s}static safeSet(t,e,s){let i=e.split("."),a=Util.#c(t,i);return Util.assert(null!==a&&"object"==typeof a,(()=>`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${e}, existingKey=${i.length>1?i[i.length-2]:""}, existingValue=${a}`),TypeError),a[i[i.length-1]]=s,t}static safeRemove(t,e){let s=!0,i=t,a=e.split(".");for(let t=0;t<a.length-1;t++){if(!(a[t]in i)){s=!1;break}i=i[a[t]]}return s&&delete i[a[a.length-1]],t}static safeMerge(t,e,s){let i=e.split("."),a=Util.#c(t,i);Util.assert(a&&"object"==typeof a,(()=>`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${e}, existingKey=${i.length>1?i[i.length-2]:""}, existingValue=${a}`),TypeError);let n=i[i.length-1];return a[n]=Util.deepMerge(a[n],s),t}static safeHas(t,e){let s=t,i=!0,a=e.split(".");for(let t=0;t<a.length;t++){if(!s||"object"!=typeof s||!(a[t]in s)){i=!1;break}s=s[a[t]]}return i}static safeEval(t,e){let s=!1;try{s=Function(`"use strict";return (${t})`).apply(e)}catch(t){}return s}static concatPath(t){let e=t[0]||"";for(let s=1;s<t.length;s++)t[s]&&("/"===e.slice(e.length-1)&&"/"===t[s].slice(0,1)?e+=t[s].slice(1):"/"===e.slice(e.length-1)||"/"===t[s].slice(0,1)?e+=t[s]:e?e+="/"+t[s]:e=t[s]);return e}static deepMerge(t,e){let s=t;return Array.isArray(t)?Array.isArray(e)?Array.prototype.push.apply(s,Util.#g(e)):s.push(Util.deepClone(e)):Util.#d(t)&&Util.#u(e)?Object.keys(e).forEach((i=>{s[i]=Util.deepMerge(t[i],e[i])})):void 0===e||(s=Util.deepClone(e)),s}static deepClone(t){return Array.isArray(t)?Util.#g(t):Util.#d(t)?Util.#_(t):t}static getClassNameFromTagName(t){let e;if("bm-unit"===t)e="Unit";else{let s=t.split("-");e=s[0].charAt(0).toUpperCase()+s[0].slice(1).toLowerCase()+s[1].charAt(0).toUpperCase()+s[1].slice(1).toLowerCase()}return e}static getTagNameFromClassName(t){let e,s=t,i=t.split("."),a=i[i.length-1];for(e=1;e<a.length&&!Util.#p(a.substring(e,e+1));e++);return e<a.length&&(s=a.substring(0,e).toLowerCase()+"-"+a.substring(e).toLowerCase()),s}static assert(t,e,s,i){if(!t){let t=new(s=s||Error)(e="function"==typeof e?e():e),i=t.stack.split("\n");throw i.splice(1,1),t.stack=i.join("\n"),t}}static warn(t,e,s,i){let a=!0;return e="function"==typeof e?e():e,t||(s=s||"warn",a=!1),a}static randomWait(t,e){let s=e?t:Math.floor(Math.random()*t);return new Promise(((t,e)=>{setTimeout((()=>{t()}),s)}))}static scopedSelectorAll(t,e,s){let i=t===Unit||t instanceof Unit?t.get("inventory","basic.unitRoot"):t,a=i instanceof DocumentFragment?e:":scope "+e.replace(",",",:scope "),n=i.querySelectorAll(a),r=new Set(n);if(!s||!s.penetrate){let t=i instanceof DocumentFragment?"[bm-powered] "+e.replace(",",", [bm-powered] "):":scope [bm-powered] "+e.replace(",",", :scope [bm-powered] "),s=i.querySelectorAll(t);new Set(s).forEach((t=>{r.delete(t)}))}return Array.from(r)}static getObject(t,e){let s;return Util.#d(t)?s=t:"string"==typeof t&&(s=e&&"js"===e.format?Util.safeEval(t,e&&e.bindTo):JSON.parse(t)),s}static#p(t){return t===t.toUpperCase()&&t!==t.toLowerCase()}static#c(t,e){let s=t;for(let t=0;t<e.length-1;t++)Util.assert(null!==s&&"object"==typeof s,(()=>`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. existingKey=${t>0?e[t-1]:""}, existingValue=${s}`),TypeError),e[t]in s||(s[e[t]]={}),s=s[e[t]];return s}static#_(t){let e={};return Object.keys(t).forEach((s=>{e[s]=Util.deepClone(t[s])})),e}static#g(t){let e=[];for(let s=0;s<t.length;s++)e.push(Util.deepClone(t[s]));return e}static#d(t){return null!==t&&"object"==typeof t&&(void 0===t.constructor||"Object"===t.constructor.name)}static#u(t){return Util.#d(t)||Array.isArray(t)}}class ClassUtil{static newUnit(t,e,s,i){s=s||Unit;let a=Function("superClass",`return function ${ClassUtil.#h(t)}(){ return Reflect.construct(superClass, [], this.constructor); }`)(s);return ClassUtil.inherit(a,s),(e=e||{}).setting=e.setting?e.setting:{},a.prototype._getSettings=function(){return e},i&&customElements.define(i.toLowerCase(),a),a}static inherit(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}static getClass(t){let e;if(!e)try{e=Function(`return (${ClassUtil.#h(t)})`)()}catch(t){if(!(t instanceof ReferenceError))throw t}return e}static#h(t){let e=/^[a-zA-Z0-9\-\._]+$/.test(t);return Util.assert(e,(()=>`ClassUtil.#__validateClassName(): Class name '${t}' is not valid.`),TypeError),t}}class AjaxUtil{static ajaxRequest(t){return new Promise(((e,s)=>{let i=Util.safeGet(t,"URL"),a=Util.safeGet(t,"method"),n=Util.safeGet(t,"data",""),r=Util.safeGet(t,"headers"),l=Util.safeGet(t,"options"),o=new XMLHttpRequest;o.open(a,i,!0),l&&Object.keys(l).forEach((t=>{o[t]=l[t]})),r&&Object.keys(r).forEach((t=>{o.setRequestHeader(t,r[t])})),o.addEventListener("load",(()=>{200===o.status||201===o.status?e(o):s(o)})),o.addEventListener("error",(()=>{s(o)})),o.send(n)}))}static loadScript(t,e){return new Promise(((s,i)=>{let a=document.createElement("script");a.src=t,a.async=!0,e&&e.type&&(a.type=e.type),a.onload=()=>{s()},a.onerror=t=>{i(t)},document.head.appendChild(a)}))}static loadJSON(t,e){let s=Util.safeGet(e,"format",t.split("?")[0].split(".").pop());return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>Util.getObject(t.responseText,Object.assign({format:s},e))))}static loadText(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadHTML(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadCSS(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadClass(t,e){let s=t+".js";return Promise.resolve().then((()=>AjaxUtil.loadScript(s,e))).then((()=>{}))}}class URLUtil{static loadParameters(t){t=t||window.location.href;let e,s,i={};if(window.location.href.indexOf("?")>-1){let a=t.slice(t.indexOf("?")+1).split("&");for(let t=0;t<a.length;t++)e=a[t].split("="),s=e[1]?e[1].split("#")[0]:e[1],i[e[0]]=decodeURIComponent(s)}return i}static buildURL(t,e){let s=new URL(t.href||t.pathname||window.location.href,document.baseURI);if(s.protocol=t.protocol||s.protocol,s.username=t.username||s.username,s.password=t.password||s.password,s.host=t.host||s.host,s.hostname=t.hostname||s.hostname,s.port=t.port||s.port,t.href&&(s.pathname=t.pathname||s.pathname),s.search=t.search||s.search,s.hash=t.hash||s.hash,t.queryParameters){let i={};e&&e.mergeParameters&&(i=URLUtil.loadParameters()),i=Object.assign(i,t.queryParameters),s.search=URLUtil.buildQuery(i)}return s.href}static buildQuery(t){let e="";return t&&(e=Object.keys(t).reduce(((e,s)=>(Array.isArray(t[s])?e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s].join())}&`:t[s]&&(e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s])}&`),e)),"")),e?`?${e.slice(0,-1)}`:""}static parseURL(t){t=t||window.location.href;let e=new URL(t,document.baseURI),s={protocol:e.protocol,username:e.username,password:e.password,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,search:e.search,searchParams:e.searchParams,hash:e.hash,filename:e.pathname.split("/").pop()};return s.path=e.pathname.substring(0,e.pathname.lastIndexOf("/")+1),s.filenameWithoutExtension=s.filename.split(".")[0],s.extension=s.filename.split(".").pop(),s.queryParameters=URLUtil.loadParameters(t),s}}class Store{#k;#m;#f;constructor(t){this.#k=t||{},this.#f=Util.safeGet(t,"items",{}),this.merger=Util.safeGet(t,"merger",Util.deepMerge)}get options(){return this.#k}set options(t){this.#k=t}get items(){return this.clone()}get merger(){return this.#m}set merger(t){Util.assert("function"==typeof t,`Store.merger(setter): Merger is not a function. merger=${t}`,TypeError),this.#m=t}clear(){this.#f={}}replace(t){this.#f=t}clone(){return Util.deepClone(this.#f)}merge(t,e){let s=Util.safeGet(e,"merger",this.#m),i=Array.isArray(t)?t:[t];for(let t=0;t<i.length;t++)this.#f=s(this.#f,i[t])}get(t,e){return Util.deepClone(Util.safeGet(this.#f,t,e))}set(t,e,s){Util.safeSet(this.#f,t,e)}remove(t){Util.safeRemove(this.#f,t)}has(t){return Util.safeHas(this.#f,t)}}class ChainableStore extends Store{#y;constructor(t){super(t);let e=Util.safeGet(this.options,"chain");e&&this.chain(e)}get localItems(){return super.clone()}clone(){return this.#y?Util.deepMerge(this.#y.clone(),super.clone()):super.clone()}chain(t){this.#y=t}get(t,e){let s=e;return super.has(t)&&this.#y&&super.has.call(this.#y,t)?s=Util.deepMerge(super.get.call(this.#y,t),super.get(t)):super.has(t)?s=super.get(t,e):this.#y&&(s=this.#y.get(t,e)),s}merge(t,e){Util.safeGet(e,"writeThrough",this.options.writeThrough)?this.#y.merge(t,e):super.merge(t,e)}set(t,e,s){Util.safeGet(s,"writeThrough",this.options.writeThrough)?this.#y.set(t,e,s):super.set(t,e,s)}has(t){let e=super.has(t);return!1===e&&this.#y&&(e=this.#y.has(t)),e}}class Perk{static#P={};static#S={};static#U={common:{}};static#b={sectionName:"perk",order:0};static get info(){return Perk.#b}static get ready(){return Promise.resolve()}static globalInit(){this===Perk&&(Unit.upgrade("spell","perk.attachPerks",Perk.#v),Unit.upgrade("spell","perk.attach",Perk.#w))}static init(t,e){}static deinit(t,e){}static registerPerk(t){let e=t.info;return e.sectionName=e.sectionName,e.order="order"in e?e.order:500,e.depends=e.depends||[],e.depends=Array.isArray(e.depends)?e.depends:[e.depends],Perk.#P[t.name]={name:t.name,object:t,sectionName:e.sectionName,order:e.order,depends:e.depends},Perk.#S[e.sectionName]=Perk.#P[t.name],t.globalInit()}static getPerk(t){return Util.assert(t in Perk.#P,(()=>`Perk "${t}" doesn't exist.`)),Perk.#P[t].object}static getPerkFromSectionName(t){return Util.assert(t in Perk.#S,(()=>`Perk for section "${t}" doesn't exist.`)),Perk.#S[t].object}static registerHandler(t,e){e=e||this.name,Perk.#U[e]||(Perk.#U[e]={}),Perk.#U[e][t.name]=t}static createHandler(t,...e){let s=Perk.#U[this.name]&&Perk.#U[this.name][t]||Perk.#U.common[t];return Util.assert(s,(()=>`Perk.createHandler(): Handler '${t}' is not registered.`),ReferenceError),new s(...e)}static#v(t,e){let s=e.settings,i=Promise.resolve(),a=Perk.#C(t,s);return Perk.#E(a).forEach((s=>{i=i.then((()=>Perk.#w(t,Perk.#P[s].object,e)))})),i}static#w(t,e,s){if(!t.assets.perk[e.name]){let i=Perk.#P[e.name].depends;for(let e=0;e<i.length;e++)Perk.#w(t,Perk.#P[i[e]].object,s);return t.assets.perk[e.name]=e,e.init(t,s)}}static#C(t,e){let s={};Promise.resolve();let i=Util.safeGet(e,"perk.options.apply");if(i)for(let e=0;e<i.length;e++){let a=i[e];Util.assert(Perk.#P[a],`Perk.#__listNewPerk(): Perk not found. name=${t.tagName}, perkName=${a}`),t.assets.perk[a]||(s[a]=Perk.#P[a])}return Object.keys(e).forEach((e=>{let i=Perk.#S[e];i&&!t.assets.perk[i.name]&&(s[i.name]=i)})),s}static#E(t){return Object.keys(t).sort(((e,s)=>t[e].order-t[s].order))}}class BasicPerk extends Perk{static#i;static#A;static#T={};static#N={tagName:{},className:{},id:{}};static#b={sectionName:"basic",order:0};static get info(){return BasicPerk.#b}static get ready(){return BasicPerk.#i}static globalInit(){BasicPerk.#i=new Promise(((t,e)=>{BasicPerk.#A=t})),Unit.upgrade("asset","inventory",new ChainableStore),Unit.upgrade("asset","skill",new ChainableStore),Unit.upgrade("asset","spell",new ChainableStore),Unit.upgrade("callback","initializeCallback",BasicPerk.#j.bind(BasicPerk)),Unit.upgrade("callback","connectedCallback",BasicPerk.#$.bind(BasicPerk)),Unit.upgrade("callback","disconnectedCallback",BasicPerk.#R.bind(BasicPerk)),Unit.upgrade("callback","adoptedCallback",BasicPerk.#$.bind(BasicPerk)),Unit.upgrade("callback","attributeChangedCallback",BasicPerk.#I.bind(BasicPerk)),Unit.upgrade("method","use",BasicPerk.#L),Unit.upgrade("method","cast",BasicPerk.#x),Unit.upgrade("skill","basic.scan",BasicPerk.#B),Unit.upgrade("skill","basic.scanAll",BasicPerk.#O),Unit.upgrade("skill","basic.locate",BasicPerk.#M),Unit.upgrade("skill","basic.locateAll",BasicPerk.#G),Unit.upgrade("spell","basic.start",BasicPerk.#H),Unit.upgrade("spell","basic.stop",BasicPerk.#F),Unit.upgrade("spell","basic.transform",BasicPerk.#q),Unit.upgrade("spell","basic.setup",BasicPerk.#D),Unit.upgrade("spell","basic.refresh",BasicPerk.#V),Unit.upgrade("spell","basic.fetch",BasicPerk.#z),Unit.upgrade("spell","basic.fill",BasicPerk.#W),Unit.upgrade("spell","basic.clear",BasicPerk.#J),"interactive"===document.readyState||"complete"===document.readyState?(Unit.set("inventory","basic.unitRoot",document.body),BasicPerk.#A(),BasicPerk.#A=null):document.addEventListener("DOMContentLoaded",(()=>{Unit.set("inventory","basic.unitRoot",document.body),BasicPerk.#A(),BasicPerk.#A=null}))}static#j(t){BasicPerk.#K(t),t.upgrade("asset","perk",{}),t.upgrade("asset","inventory",new ChainableStore({chain:Unit.assets.inventory})),t.upgrade("asset","skill",new ChainableStore({chain:Unit.assets.skill})),t.upgrade("asset","spell",new ChainableStore({chain:Unit.assets.spell})),t.upgrade("method","use",BasicPerk.#L),t.upgrade("method","cast",BasicPerk.#x),t.upgrade("inventory","basic.unitRoot",t);let e=Promise.resolve();return["BasicPerk","SettingPerk","UnitPerk","StatusPerk","EventPerk","SkinPerk","StylePerk"].forEach((s=>{e=e.then((()=>t.cast("perk.attach",Perk.getPerk(s))))})),e.then((()=>t.cast("basic.start")))}static#$(t){}static#R(t){return t.cast("basic.stop")}static#Q(t){return t.cast("event.trigger","afterAdopt")}static#I(t,e,s,i){return t.cast("event.trigger","afterAttributeChange",{name:e,oldValue:s,newValue:i})}static#x(t,...e){let s=this.assets.spell.get(t);return Util.assert("function"==typeof s,(()=>`Spell is not available. spellName=${t}`)),s.call(this,this,...e)}static#L(t,...e){let s=this.assets.skill.get(t);return Util.assert("function"==typeof s,(()=>`Skill is not available. skillName=${t}`)),s.call(this,this,...e)}static#O(t,e,s){return Util.scopedSelectorAll(t,e,s)}static#B(t,e,s){let i=Util.scopedSelectorAll(t,e,s);return i?i[0]:null}static#G(t,e){return"object"!=typeof e?"string"==typeof e?BasicPerk.#N.tagName[e.toUpperCase()]:[e]:"selector"in e?document.querySelectorAll(e.selector):"scan"in e?(t.use("basic.scan",e.scan),t.use("basic.scanAll",e.scan)):"uniqueId"in e?[BasicPerk.#T[e.uniqueId].object]:"tagName"in e?BasicPerk.#N.tagName[e.tagName.toUpperCase()]:"object"in e?[e.object]:"id"in e?BasicPerk.#N.id[e.id]:"className"in e?BasicPerk.#N.className[e.className]:void 0}static#M(t,e){let s=BasicPerk.#G(t,e);if(s)return s[0]}static async#H(t,e){await t.cast("setting.apply",{settings:t.assets.setting.items}),await t.cast("event.trigger","beforeStart"),t.use("status.change","starting"),t.get("setting","basic.options.autoTransform",!0)&&await t.cast("basic.transform",{skinName:"default",styleName:"default"}),await t.cast("event.trigger","doStart"),t.get("setting","basic.options.autoRefresh",!0)&&await t.cast("basic.refresh"),t.use("status.change","started"),await t.cast("event.trigger","afterStart"),t.use("status.change","ready"),await t.cast("event.trigger","afterReady")}static async#F(t,e){e=e||{},t.use("status.change","stopping"),await t.cast("event.trigger","beforeStop",e),await t.cast("event.trigger","doStop",e),t.use("status.change","stopped"),await t.cast("event.trigger","afterStop",e)}static async#q(t,e){e=e||{},await t.cast("event.trigger","beforeTransform",e),t.get("setting","basic.options.autoSetup",!0)&&await t.cast("basic.setup",e),await t.cast("event.trigger","doTransform",e),await t.cast("unit.materializeAll",t),await t.cast("event.trigger","afterTransform",e)}static async#D(t,e){e=e||{},await t.cast("event.trigger","beforeSetup",e),await t.cast("event.trigger","doSetup",e),await t.cast("event.trigger","afterSetup",e)}static async#V(t,e){e=e||{},await t.cast("event.trigger","beforeRefresh",e),Util.safeGet(e,"autoClear",t.get("setting","basic.options.autoClear",!0))&&await t.cast("basic.clear",e),Util.safeGet(e,"autoFetch",t.get("setting","basic.options.autoFetch",!0))&&await t.cast("basic.fetch",e),Util.safeGet(e,"autoFill",t.get("setting","basic.options.autoFill",!0))&&await t.cast("basic.fill",e),await t.cast("event.trigger","doRefresh",e),await t.cast("event.trigger","afterRefresh",e)}static async#z(t,e){e=e||{},await t.cast("event.trigger","beforeFetch",e),await t.cast("event.trigger","doFetch",e),await t.cast("event.trigger","afterFetch",e)}static async#W(t,e){e=e||{},await t.cast("event.trigger","beforeFill",e),await t.cast("event.trigger","doFill",e),await t.cast("event.trigger","afterFill",e)}static async#J(t,e){e=e||{},await t.cast("event.trigger","beforeClear",e),await t.cast("event.trigger","doClear",e),await t.cast("event.trigger","afterClear",e)}static#K(t,e){let s=customElements.get(t.tagName.toLowerCase());BasicPerk.#T[t.uniqueId]={object:t,class:s},BasicPerk.#N.tagName[t.tagName]=BasicPerk.#N.tagName[t.tagName]||[],BasicPerk.#N.tagName[t.tagName].push(t),BasicPerk.#N.className[s.name]=BasicPerk.#N.className[s.name]||[],BasicPerk.#N.className[s.name].push(t),t.id&&(BasicPerk.#N.id[t.id]=BasicPerk.#N.id[t.id]||[],BasicPerk.#N.id[t.id].push(t))}}class SettingPerk extends Perk{static#i;static#A;static#b={sectionName:"setting",order:10};static get info(){return SettingPerk.#b}static get ready(){return SettingPerk.#i}static globalInit(){return SettingPerk.#i=new Promise(((t,e)=>{SettingPerk.#A=t})),Unit.upgrade("asset","setting",new ChainableStore),Unit.upgrade("skill","setting.get",SettingPerk.#X),Unit.upgrade("skill","setting.set",SettingPerk.#Y),Unit.upgrade("skill","setting.merge",SettingPerk.#Z),Unit.upgrade("spell","setting.summon",SettingPerk.#tt),Unit.upgrade("spell","setting.apply",SettingPerk.#et),Perk.getPerk("BasicPerk").ready.then((()=>{SettingPerk.#A&&(SettingPerk.#A(),SettingPerk.#A=null)}))}static async init(t,e){let s=e&&e.settings||{};s=SettingPerk.#st(t,s),s=SettingPerk.#it(t,s),await SettingPerk.ready,t.upgrade("asset","setting",new ChainableStore({items:s,chain:Unit.assets.setting})),SettingPerk.#at(t),SettingPerk.#nt(t)&&await SettingPerk.#tt(t),SettingPerk.#at(t)}static#X(t,e,s){return t.get("setting",e,s)}static#Y(t,e,s){return t.set("setting",e,s)}static#Z(t,e,s){t.assets.setting.merge(e,s)}static async#et(t,e){await t.cast("event.trigger","beforeApplySettings",e),await t.cast("perk.attachPerks",e),await t.cast("event.trigger","doApplySettings",e),await t.cast("event.trigger","afterApplySettings",e)}static async#tt(t,e){let s=await AjaxUtil.loadJSON(SettingPerk.#rt(t),Object.assign({bindTo:t},e));s&&t.use("setting.merge",s)}static#at(t){if(t.hasAttribute("bm-settingsref")){let e=t.getAttribute("bm-settingsref")||!0;"false"===e&&(e=!1),t.set("setting","setting.options.settingsRef",e)}if(t.hasAttribute("bm-options")){let e={options:JSON.parse(t.getAttribute("bm-options"))};t.use("setting.merge",e)}if(t.hasAttribute("bm-path")&&t.set("setting","setting.options.path",t.getAttribute("bm-path")),t.hasAttribute("bm-filename")&&t.set("setting","setting.options.fileName",t.getAttribute("bm-filename")),t.hasAttribute("bm-autoload")){let e=t.getAttribute("bm-autoload");if(e){let s=URLUtil.parseURL(e);t.set("setting","setting.options.path",s.path),t.set("setting","setting.options.fileName",s.filenameWithoutExtension)}}}static#nt(t){let e=!1;return t.get("setting","setting.options.settingsRef",t.get("setting","system.setting.options.settingsRef"))&&(e=!0),e}static#rt(t){let e,s=t.get("setting","setting.options.settingsRef");if(s&&!0!==s)e=s;else{let s=Util.concatPath([t.get("setting","system.setting.options.path",t.get("setting","system.unit.options.path","")),t.get("setting","setting.options.path",t.get("setting","unit.options.path",""))]),i=t.get("setting","setting.options.settingFormat",t.get("setting","system.setting.options.settingFormat","json")),a=t.get("setting","setting.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase()))+".settings."+i,n=t.get("setting","unit.options.query");e=Util.concatPath([s,a])+(n?`?${n}`:"")}return e}static#st(t,e){return"function"==typeof t._injectSettings&&(e=t._injectSettings.call(t,e)),e}static#it(t,e){let s,i=Object.getPrototypeOf(t),a={};for(;"function"==typeof Object.getPrototypeOf(i)._getSettings;)s=Object.getPrototypeOf(i)._getSettings.call(t),Object.keys(s).length>0&&(Util.deepMerge(s,a),a=s),i=Object.getPrototypeOf(i);return Util.deepMerge(e,a),"function"==typeof t._getSettings&&Util.deepMerge(e,t._getSettings.call(t)),e}}class StatusPerk extends Perk{static#lt={};static#ot=new Store;static#b={sectionName:"status",order:100};static get info(){return StatusPerk.#b}static globalInit(){StatusPerk.waitFor=function(t,e){return StatusPerk.#ct(Unit,t,e)},Unit.upgrade("skill","status.change",StatusPerk.#gt),Unit.upgrade("spell","status.wait",StatusPerk.#ct)}static init(t,e){t.upgrade("inventory","status.status","connected"),t.use("event.add","doApplySettings",{handler:StatusPerk.#dt,order:StatusPerk.info.order})}static#dt(t,e,s){Object.entries(Util.safeGet(e.detail,"settings.status.waitFor",{})).forEach((([t,e])=>{StatusPerk.addEventHandler(t,{handler:StatusPerk.#ut,options:e})}))}static#ut(t,e,s){return StatusPerk.#ct(this,s.options)}static#gt(t,e){Util.assert(StatusPerk.#_t(t.get("inventory","status.status"),e),(()=>`StatusPerk.#_changeStatus(): Illegal transition. name=${t.tagName}, fromStatus=${t.get("inventory","status.status")}, toStatus=${e}, id=${t.id}`),Error),t.set("inventory","status.status",e),StatusPerk.#lt[t.uniqueId]={status:e},StatusPerk.#pt()}static#ct(t,e,s){let i,a=s&&s.timeout||t.get("setting","status.options.waitForTimeout",t.get("setting","system.status.options.waitForTimeout",1e4)),n={waiter:s&&s.waiter?s.waiter:t,waitlist:Util.deepClone(e)};return StatusPerk.#ht(n)?i=Promise.resolve():(i=new Promise(((s,i)=>{n.resolve=s,n.reject=i,n.timer=setTimeout((()=>{let s=t&&t.tagName||n.waiter&&n.waiter.tagName||"",r=t&&t.uniqueId||"";i(`StatusPerk.#_waitFor(): Timed out after ${a} milliseconds waiting for ${StatusPerk.#kt(e)}, name=${s}, uniqueId=${r}.`)}),a)})),n.promise=i,StatusPerk.#mt(n)),i}static#pt(){let t=[];Object.keys(StatusPerk.#ot.items).forEach((e=>{StatusPerk.#ht(StatusPerk.#ot.get(e))&&(clearTimeout(StatusPerk.#ot.get(e).timer),StatusPerk.#ot.get(e).resolve(),t.push(e))}));for(let e=0;e<t.length;e++)StatusPerk.#ot.remove(t[e])}static#mt(t){let e=n();StatusPerk.#ot.set(e,t)}static#_t(t,e){let s=!0;return t&&"ing"===t.slice(-3)&&("stopping"===t&&"stopped"!==e||"starting"===t&&"started"!==e)&&(s=!1),s}static#ft(t,e){let s,i=t.use("basic.locate",e);return i&&(s=StatusPerk.#lt[i.uniqueId]),s}static#ht(t){let e=!0,s=t.waitlist;for(let i=0;i<s.length;i++){let a=!1,n=StatusPerk.#ft(t.waiter,s[i]);if(n&&StatusPerk.#yt(n.status,s[i].status)&&(a=!0),!a){e=!1;break}}return e}static#yt(t,e){e=e||"ready";let s=!1;switch(t){case"ready":"ready"!==e&&"started"!==e&&"starting"!==e||(s=!0);break;case"started":"started"!==e&&"starting"!==e||(s=!0);break;case"stopped":"stopped"!==e&&"stopping"!==e||(s=!0);break;default:t===e&&(s=!0)}return s}static#kt(t){let e="";for(let s=0;s<t.length;s++)if("string"==typeof t[s])e+=`\n\t{"${t[s]}", status:ready},`;else{e+=`\n\t{${`uniqueId:${t[s].uniqueId}, `}${t[s].id?`id:${t[s].id}, `:""}${t[s].tagName?`tagName:${t[s].tagName}, `:""}${t[s].object?`object:${t[s].object.tagName}, `:""}${t[s].selector?`selector:${t[s].selector}, `:""}${t[s].status?`status:${t[s].status}`:"status:ready"}},`}return`[${e}\n]`}static#Pt(){let t={},e=new Promise(((e,s)=>{t.resolve=e,t.reject=s,t.status="pending"}));return t.promise=e,t}}class SkinPerk extends Perk{static#b={sectionName:"skin",order:210};static get info(){return SkinPerk.#b}static globalInit(){Unit.upgrade("skill","skin.apply",SkinPerk.#St),Unit.upgrade("spell","skin.summon",SkinPerk.#Ut)}static init(t,e){let s;switch(t.upgrade("inventory","skin.skins",{}),t.upgrade("inventory","skin.active.skinName",""),t.use("event.add","beforeTransform",{handler:SkinPerk.#bt,order:SkinPerk.info.order}),t.use("event.add","doTransform",{handler:SkinPerk.#vt,order:SkinPerk.info.order}),SkinPerk.#at(t),SkinPerk.#wt(t),t.get("setting","skin.options.shadowDOM",t.get("setting","system.skin.options.shadowDOM"))){case"open":s=t.attachShadow({mode:"open"}),t.set("inventory","skin.shadowRoot",s),t.set("inventory","basic.unitRoot",s);break;case"closed":s=t.attachShadow({mode:"closed"}),t.set("inventory","skin.shadowRoot",s),t.set("inventory","basic.unitRoot",s)}}static async#bt(t,e,s){if(this.get("setting","skin.options.hasSkin",!0)){let t=await SkinPerk.#Ut(this,e.detail.skinName,e.detail.skinOptions);this.get("inventory","basic.unitRoot").textContent="",this.set("inventory","basic.unitRoot",t.template.content.cloneNode(!0))}}static#vt(t,e,s){if(this.get("setting","skin.options.hasSkin",!0))return SkinPerk.#St(this,e.detail.skinName,this.get("inventory","basic.unitRoot"))}static#St(t,e,s){let i=t.get("inventory",`skin.skins.${e}`);Util.assert(i,(()=>`SkinPerk.#_applySkin(): Skin not loaded. name=${t.tagName}, skinName=${e}, id=${t.id}, uniqueId=${t.uniqueId}`),ReferenceError),s=s||this.get("inventory","basic.unitRoot"),t.set("inventory","basic.unitRoot",t.get("inventory","skin.shadowRoot",t)),t.get("inventory","basic.unitRoot").innerHTML="",t.get("inventory","basic.unitRoot").appendChild(s),t.set("inventory","skin.active.skinName",e)}static#Ut(t,e,s){let i=Promise.resolve(),a=t.get("inventory",`skin.skins.${e}`)||SkinPerk.#Ct(t,e),n=s||t.get("setting",`skin.skins.${e}`,{});if("loaded"===a.status)return Promise.resolve(a);switch(n.type){case"HTML":a.HTML=n.HTML;break;case"node":let s=t.use("basic.scan",n.selector||"");Util.assert(s,(()=>`SkinPerk.#_loadSkin(): Node does not exist. name=${t.tagName}, skinName=${e}, selector=${n.selector}`)),a.HTML=s.innerHTML;break;case"URL":default:let r=n.URL||SkinPerk.#Et(t,e,n);Util.assert(r,(()=>`SkinPerk.#_loadSkin(): Skin URL is not speicified. name=${t.tagName}, skinName=${e}`)),i=AjaxUtil.loadHTML(r).then((t=>{a.HTML=t})),a.promise=i,a.status="loading";break;case"inline":i=new Promise(((e,s)=>{setTimeout((()=>{a.HTML=t.firstElementChild&&"TEMPLATE"===t.firstElementChild.tagName?t.firstElementChild.innerHTML:t.innerHTML,t.innerHTML="",e()}),1)})),a.promise=i,a.status="loading"}return i.then((()=>(a.template=document.createElement("template"),a.template.innerHTML=a.HTML,a.status="loaded",a)))}static#at(t){if(t.hasAttribute("bm-skinref")){let e=t.getAttribute("bm-skinref")||!0;"false"===e&&(e=!1),t.set("setting","skin.options.skinRef",e)}}static#wt(t){let e=t.get("setting","skin.options.skinRef");if(!1===e)t.set("setting","skin.options.hasSkin",!1);else{let s=t.get("setting","skin.skins.default",{});s.type=s.type||"URL",s.URL=s.URL||("string"==typeof e?e:""),t.set("setting","skin.skins.default",s)}}static#Ct(t,e){let s={name:e,HTML:"",template:null,status:""};return t.set("inventory",`skin.skins.${e}`,s),s}static#Et(t,e,s){let i,a=t.get("setting","skin.options.skinRef");if(a&&!0!==a)i=a;else{let a=Util.concatPath([t.get("setting","system.skin.options.path",t.get("setting","system.unit.options.path","")),Util.safeGet(s,"path",t.get("setting","skin.options.path",t.get("setting","unit.options.path","")))]),n=SkinPerk.#At(t,e,s)+".html",r=t.get("setting","unit.options.query");i=Util.concatPath([a,n])+(r?`?${r}`:"")}return i}static#At(t,e,s){return Util.safeGet(s,"fileName",t.get("setting","skin.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase())))}}class StylePerk extends Perk{static#i;static#A;static#Tt=new WeakMap;static#Nt={};static#b={sectionName:"style",order:200};static get info(){return StylePerk.#b}static get ready(){return StylePerk.#i}static async globalInit(){StylePerk.#i=new Promise(((t,e)=>{StylePerk.#A=t})),StylePerk.#Tt.set(Unit,{applied:[]}),Unit.upgrade("inventory","style.styles",new ChainableStore),Unit.upgrade("spell","style.summon",StylePerk.#jt),Unit.upgrade("spell","style.apply",StylePerk.#$t),await Perk.getPerk("SettingPerk").ready;let t=[];Object.entries(Unit.get("setting","system.style.styles",{})).forEach((([e,s])=>{t.push(StylePerk.#jt(Unit,e,s,!0))})),await Promise.all(t),await Perk.getPerk("BasicPerk").ready,await StylePerk.#Rt(Unit,Unit.get("setting","system.style.options.apply",[])),StylePerk.#A(),StylePerk.#A=null}static init(t,e){StylePerk.#Tt.set(t,{applied:[]}),t.upgrade("inventory","style.styles",new ChainableStore({chain:Unit.get("inventory","style.styles")})),t.use("event.add","beforeTransform",{handler:StylePerk.#It,order:StylePerk.info.order}),t.use("event.add","doTransform",{handler:StylePerk.#Lt,order:StylePerk.info.order}),StylePerk.#at(t),StylePerk.#wt(t)}static async#It(t,e,s){await StylePerk.ready,StylePerk.#xt(this);let i=[],a=this.get("setting","style.options.apply",[]);for(let t=0;t<a.length;t++)i.push(StylePerk.#jt(this,a[t]));await Promise.all(i),await StylePerk.#Rt(this,a)}static async#Lt(t,e,s){if(this.get("setting","style.options.hasStyle",!0)){let t=[],s=this.get("setting",`style.styles.${e.detail.styleName}.apply`,[]);s.push(e.detail.styleName);for(let e=0;e<s.length;e++)t.push(StylePerk.#jt(this,s[e]));await Promise.all(t),await StylePerk.#Rt(this,s)}}static#jt(t,e,s,i){let a=Promise.resolve(),n=t.get("inventory","style.styles").get(e)||StylePerk.#Bt(t,e),r=s||t.get("setting",`style.styles.${e}`,{});if("loaded"===n.status)return Promise.resolve(n);if(Util.warn("default"===e||Object.keys(r).length>0,(()=>`Style settings not found. name=${t.tagName}, styleName=${e}`)),"CSS"===r.type)n.CSS=r.CSS;else if("loading"===n.status)a=n.promise;else{let s=r.URL||StylePerk.#Et(t,e,r);Util.assert(s,(()=>`StylePerk.#_loadCSS(): CSS URL is not speicified. name=${t.tagName}, styleName=${e}`)),a=AjaxUtil.loadCSS(s).then((t=>{n.CSS=t})),n.promise=a,n.status="loading"}return a.then((()=>(n.status="loaded",n.shared=i,n)))}static async#$t(t,e){let s=t.get("inventory","style.styles").get(e);Util.assert(s,(()=>`StylePerk.#_applyCSS(): CSS not loaded. name=${t.tagName||"Global"}, styleName=${e}, id=${t.id}, uniqueId=${t.uniqueId}`),ReferenceError);let i=new CSSStyleSheet;await i.replace(`${s.CSS}`);let a=t.get("inventory","skin.shadowRoot");a?a.adoptedStyleSheets=[...a.adoptedStyleSheets,i]:(!((e=s.shared?e:`${t.tagName}.${e}`)in StylePerk.#Nt)||StylePerk.#Nt[e].count<=0?(StylePerk.#Nt[e]=StylePerk.#Nt[e]||{},document.adoptedStyleSheets=[...document.adoptedStyleSheets,i],StylePerk.#Nt[e].object=i,StylePerk.#Nt[e].count=1):StylePerk.#Nt[e].count++,StylePerk.#Tt.get(t).applied.push(e))}static#xt(t){let e=t.get("inventory","skin.shadowRoot");if(e)e.adoptedStyleSheets=[];else{let e=StylePerk.#Tt.get(t).applied;if(e.length>0){for(let t=0;t<e.length;t++)StylePerk.#Nt[e[t]].count--;StylePerk.#Tt.get(t).applied=[],document.adoptedStyleSheets=[],Object.keys(StylePerk.#Nt).forEach((t=>{StylePerk.#Nt[t].count>0&&(document.adoptedStyleSheets=[...document.adoptedStyleSheets,StylePerk.#Nt[t].object])}))}}}static#Rt(t,e){let s=Promise.resolve();for(let i=0;i<e.length;i++)s=s.then((()=>StylePerk.#$t(t,e[i])));return s}static#at(t){if(t.hasAttribute("bm-styleref")){let e=t.getAttribute("bm-styleref")||!0;"false"===e&&(e=!1),t.set("setting","style.options.styleRef",e)}}static#wt(t){let e=t.get("setting","style.options.styleRef");if(!1===e)t.set("setting","style.options.hasStyle",!1);else if(e){let s=t.get("setting","style.styles.default",{});s.type=s.type||"URL",s.URL=s.URL||("string"==typeof e?e:""),t.set("setting","style.styles.default",s),t.set("setting","style.options.hasStyle",!0)}}static#Bt(t,e){let s={name:e,CSS:"",status:""};return t.get("inventory","style.styles").set(e,s),s}static#Et(t,e,s){let i,a=t.get("setting","style.options.styleRef");if(a&&!0!==a)i=a;else{let a=Util.concatPath([t.get("setting","system.style.options.path",t.get("setting","system.unit.options.path","")),Util.safeGet(s,"path",t.get("setting","style.options.path",t.get("setting","unit.options.path","")))]),n=StylePerk.#At(t,e,s)+".css",r=t.get("setting","unit.options.query");i=Util.concatPath([a,n])+(r?`?${r}`:"")}return i}static#At(t,e,s){return Util.safeGet(s,"fileName",t.get("setting","style.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase())))}}class EventPerk extends Perk{static#Ot=new WeakMap;static#b={sectionName:"event",order:210};static get info(){return EventPerk.#b}static globalInit(t,e){Unit.upgrade("skill","event.add",EventPerk.#Mt),Unit.upgrade("skill","event.remove",EventPerk.#Gt),Unit.upgrade("skill","event.init",EventPerk.#Ht),Unit.upgrade("skill","event.reset",EventPerk.#Ft),Unit.upgrade("skill","event.triggerSync",EventPerk.#qt),Unit.upgrade("spell","event.trigger",EventPerk.#Dt)}static init(t,e){t.use("event.add","doApplySettings",{handler:EventPerk.#Vt,order:EventPerk.info.order}),t.use("event.add","afterTransform",{handler:EventPerk.#zt,order:EventPerk.info.order})}static deinit(t,e){let s=t.get("setting","event");s&&Object.keys(s).forEach((e=>{EventPerk.#Ft(t,e,s[eventName])}))}static#Vt(t,e,s){Object.entries(Util.safeGet(e.detail,"settings.event.events",{})).forEach((([t,e])=>{EventPerk.#Ht(this,t,e)}))}static#zt(t,e,s){Object.entries(this.get("setting","event.events",{})).forEach((([t,e])=>{EventPerk.#Wt(t,e)||EventPerk.#Ht(this,t,e)}))}static#Mt(t,e,s,i,a){i=i||t;let n="object"==typeof s?s:{},r=EventPerk.#Jt(t,s);Util.assert(r,(()=>`EventPerk.#_addEventHandler(): handler not found. name=${t.tagName}, eventName=${e}`)),EventPerk.#Ot.get(i)||EventPerk.#Ot.set(i,{unit:t,listeners:{},promises:{},statuses:{}});let l=EventPerk.#Ot.get(i).listeners;l[e]||(l[e]=[],i.addEventListener(e,EventPerk.#Kt,n.listnerOptions));let o=Util.safeGet(n,"order",1e3);l[e].push({handler:r,options:n.options,bindTo:a,order:o}),l[e].sort(((t,e)=>t.order===e.order?0:t.order>e.order?1:-1))}static#Gt(t,e,s,i){i=i||t;let a=EventPerk.#Jt(t,s);Util.assert(a,(()=>`EventPerk.#_removeEventHandler(): handler not found. name=${t.tagName}, eventName=${e}`));let n=Util.safeGet(EventPerk.#Ot.get(i),`.listeners.${e}`);if(n)for(let t=n.length-1;t>=0;t--)if(n[t].handler===a){n.splice(t,1);break}}static#Ht(t,e,s,i){s=s||t.get("setting",`event.events.${e}`);let a=EventPerk.#Qt(t,i,e,s);Object.keys(s.handlers).forEach((e=>{let i=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<i.length;s++)for(let n=0;n<a.length;n++)EventPerk.#Mt(t,e,i[s],a[n])}))}static#Ft(t,e,s,i){s=s||t.get("setting",`event.events.${e}`);let a=EventPerk.#Qt(t,i,e,s);Object.keys(s.handlers).forEach((e=>{let i=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<i.length;s++)for(let n=0;n<a.length;n++)t.removeEventHandler(e,i[s],a[n])}))}static#Dt(t,e,s,i){return s=s||{},(i=i||t).dispatchEvent(new CustomEvent(e,{detail:s})),Util.safeGet(EventPerk.#Ot.get(i),`promises.${e}`)||Promise.resolve()}static#qt(t,e,s,i){return(s=s||{}).async=!0,EventPerk.#Dt(t,e,s,i)}static#Jt(t,e){return"object"==typeof e?e.handler:e}static#Wt(t,e){let s=!1;return("this"===t||e&&"this"===e.selector)&&(s=!0),s}static#Qt(t,e,s,i){let a;return e=e||t,a=EventPerk.#Wt(s,i)?[e]:i&&i.selector?Util.scopedSelectorAll(e,i.selector):Util.scopedSelectorAll(e,`#${s}`),a}static#Xt(t,e,s){let i=!1,a=Util.safeGet(EventPerk.#Ot.get(t),`listeners.${e}`);if(a)for(let t=0;t<a.length;t++)if(a[t].handler===s){i=!0;break}return i}static#Kt(t){let e=EventPerk.#Ot.get(this),s=Util.safeGet(e,`listeners.${t.type}`),i=Util.safeGet(t,"detail.sender",this),a=Util.safeGet(e,"unit"),n=`statuses.${t.type}`,r=`promises.${t.type}`;if(Util.safeSet(e,n,"handling"),!1===Util.safeGet(t,"detail.async",!1))e.promises[t.type]=EventPerk.#Yt(t,i,a,s).then((()=>{Util.safeSet(e,r,null),Util.safeSet(e,n,"")})).catch((t=>{throw Util.safeSet(e,r,null),Util.safeSet(e,n,""),t}));else try{e.promises[t.type]=EventPerk.#Zt(t,i,a,s),Util.safeSet(e,r,null),Util.safeSet(e,n,"")}catch(t){throw Util.safeSet(e,r,null),Util.safeSet(e,n,""),t}}static#Yt(t,e,s,i){let a=Promise.resolve(),n=!1;for(let r=0;r<i.length;r++){let l={unit:s,options:i[r].options?i[r].options:{}};a=a.then((()=>{let a=i[r].handler;a="string"==typeof a?s[a]:a,Util.assert("function"==typeof a,(()=>`EventPerk.#__handle(): Event handler is not a function. name=${s.tagName}, eventName=${t.type}`),TypeError);let n=i[r].bindTo?i[r].bindTo:s;return a.call(n,e,t,l)})),n=!(!i[r].options||!i[r].options.stopPropagation)||n}return n&&t.stopPropagation(),a}static#Zt(t,e,s,i){let a=!1;for(let n=0;n<i.length;n++){let r={unit:s,options:i[n].options?i[n].options:{}},l=i[n].handler;l="string"==typeof l?s[l]:l,Util.assert("function"==typeof l,(()=>`EventPerk.#__handleSync(): Event handler is not a function. name=${s.tagName}, eventName=${t.type}`),TypeError);let o=i[n].bindTo?i[n].bindTo:s;l.call(o,e,t,r),a=!(!i[n].options||!i[n].options.stopPropagation)||a}return a&&t.stopPropagation(),Promise.resolve()}}class UnitPerk extends Perk{static#te={Unit:{status:"loaded"}};static#b={sectionName:"unit",order:400};static get info(){return UnitPerk.#b}static async globalInit(){Unit.upgrade("spell","unit.materializeAll",UnitPerk.#ee),Unit.upgrade("spell","unit.materialize",UnitPerk.#se),Unit.upgrade("spell","unit.summon",UnitPerk.#ie)}static init(t,e){t.upgrade("inventory","unit.units",{}),t.use("event.add","doApplySettings",{handler:UnitPerk.#ae,order:UnitPerk.info.order});let s=UnitPerk.#at(t);t.use("setting.merge",s)}static#ae(t,e,s){let i=Promise.resolve();return Object.entries(Util.safeGet(e.detail,"settings.unit.units",{})).forEach((([t,e])=>{i=i.then((()=>{if(!this.get("inventory",`unit.units.${t}.object`)){let s=Util.safeGet(e,"unit.options.parentUnit");return(s?this.use("basic.locate",s):this).cast("unit.materialize",t,e)}}))})),i}static#ie(t,e){t=t.toLowerCase();let s=Util.safeGet(e,"unit.options.className",Util.getClassNameFromTagName(t)),i=Util.safeGet(e,"unit.options.autoMorph",s);i=!0===i?"Unit":i;let a=Promise.resolve();if(UnitPerk.#ne(t,i,e))if(UnitPerk.#te[i]&&"loading"===UnitPerk.#te[i].status)a=UnitPerk.#te[i].promise;else{UnitPerk.#te[i]={status:"loading"};let s={};s.type=Unit.get("setting","system.unit.options.type","text/javascript"),a=AjaxUtil.loadClass(UnitPerk.#re(t,e),s).then((()=>{UnitPerk.#te[i]={status:"loaded"}})),UnitPerk.#te[i].promise=a}return a.then((()=>{if(i!==s){let a=ClassUtil.getClass(i);ClassUtil.newUnit(s,e,a,t),UnitPerk.#te[s]={status:"loaded"}}if(!customElements.get(t)){let e=ClassUtil.getClass(s);Util.assert(e,(()=>`UnitPerk.#_loadClass(): Class does not exist. tagName=${t}, className=${s}`)),customElements.define(t,e)}}))}static async#se(t,e,s,i){if(t.get("inventory",`unit.units.${e}.object`))return Promise.resolve(t.get("inventory",`unit.units.${e}.object`));let a=Util.safeGet(s,"unit.options.tag");a&&(e=a.match(/([\w-]+)\s+\w+.*?>/)[1]),await UnitPerk.#ie(e,s);let n=await UnitPerk.#le(t,e,s);t.set("inventory",`unit.units.${e}.object`,n);let r=Util.safeGet(i,"syncOnAdd",Util.safeGet(s,"unit.options.syncOnAdd"));return r&&await t.cast("status.wait",[{uniqueId:n.uniqueId,status:!0===r?"ready":r}]),n}static#ee(t,e,s){let i=[];return Util.scopedSelectorAll(e,"[bm-autoload]:not([bm-autoloading]):not([bm-powered]),[bm-automorph]:not([bm-autoloading]):not([bm-powered]),[bm-classref]:not([bm-autoloading]):not([bm-powered]),[bm-htmlref]:not([bm-autoloading]):not([bm-powered])").forEach((t=>{let e=UnitPerk.#at(t);t.setAttribute("bm-autoloading",""),t._injectSettings=function(t){return Util.deepMerge(t,e)},i.push(UnitPerk.#ie(t.tagName,e).then((()=>{t.removeAttribute("bm-autoloading")})))})),Promise.all(i).then((()=>{if(Util.safeGet(s,"waitForTags"))return UnitPerk.#oe(e)}))}static#at(t){let e={unit:{options:{}}};if(t.hasAttribute("bm-classname")&&(e.unit.options.className=t.getAttribute("bm-classname")),t.hasAttribute("bm-splitclass")){let s=t.getAttribute("bm-splitclass")||!0;"false"===s&&(s=!1),e.unit.options.splitClass=s}return t.hasAttribute("bm-path")&&(e.unit.options.path=t.getAttribute("bm-path")),t.hasAttribute("bm-filename")&&(e.unit.options.fileName=t.getAttribute("bm-filename")),t.hasAttribute("bm-automorph")&&(e.unit.options.autoMorph=!t.getAttribute("bm-automorph")||t.getAttribute("bm-automorph")),t.hasAttribute("bm-htmlref")&&(e.unit.options.autoMorph=!t.getAttribute("bm-htmlref")||t.getAttribute("bm-htmlref")),t.hasAttribute("bm-autoload")&&(e.unit.options.autoLoad=!t.getAttribute("bm-autoload")||t.getAttribute("bm-autoload")),t.hasAttribute("bm-classref")&&(e.unit.options.autoLoad=!t.getAttribute("bm-classref")||t.getAttribute("bm-classref")),UnitPerk.#wt(t,e)}static#wt(t,e){let s=Util.safeGet(e,"unit.options.autoLoad");if("string"==typeof s){let t=URLUtil.parseURL(s);e.unit.options.path=t.path,e.unit.options.fileName=t.filenameWithoutExtension,"html"===t.extension&&(e.unit.options.autoMorph=Util.safeGet(e,"unit.options.autoMorph",!0))}return e}static#ne(t,e,s){let i=!1;return(Util.safeGet(s,"unit.options.classRef")||Util.safeGet(s,"unit.options.htmlRef")||Util.safeGet(s,"unit.options.autoLoad")||Util.safeGet(s,"unit.options.autoMorph"))&&(i=!0,(UnitPerk.#te[e]&&"loaded"===UnitPerk.#te[e].status||customElements.get(t)||ClassUtil.getClass(e))&&(i=!1)),i}static#le(t,e,s){let i,a;a=Util.safeGet(s,"unit.options.parentNode")?t.use("basic.scan",Util.safeGet(s,"unit.options.parentNode")):this.get("inventory","basic.unitRoot"),Util.assert(a,(()=>`UnitPerk.#__insertTag(): Root node does not exist. name=${t.tagName}, tagName=${e}, parentNode=${Util.safeGet(s,"unit.options.parentNode")}`),ReferenceError);let n=Util.safeGet(s,"unit.options.tag")?Util.safeGet(s,"unit.options.tag"):`<${e}></${e}>`;if(Util.safeGet(s,"unit.options.replaceParent"))a.outerHTML=n,i=a;else{let t=Util.safeGet(s,"unit.options.adjacentPosition","afterbegin");switch(a.insertAdjacentHTML(t,n),t){case"beforebegin":i=a.previousSibling;break;case"afterbegin":i=a.children[0];break;case"beforeend":i=a.lastChild;break;case"afterend":i=a.nextSibling}}return i._injectSettings=function(t){return Util.deepMerge(t,s)},i}static#oe(t){let e=[];return Util.scopedSelectorAll(t,"[bm-powered],[bm-autoloading]").forEach((s=>{if(t!=s.rootElement&&!s.hasAttribute("bm-nowait")){let t={object:s,status:"ready"};e.push(t)}})),StatusPerk.waitFor(e,{waiter:t})}static#re(t,e){let s=Util.concatPath([Util.safeGet(e,"system.unit.options.path",Unit.get("setting","system.unit.options.path","")),Util.safeGet(e,"unit.options.path","")]),i=Util.safeGet(e,"unit.options.fileName",t),a=Util.safeGet(e,"unit.options.query");return Util.concatPath([s,i])+(a?`?${a}`:"")}}globalThis.BITSMIST||(globalThis.BITSMIST={},globalThis.BITSMIST.V1={},globalThis.BITSMIST.V1.$CORE={},globalThis.BITSMIST.V1.$CORE.Util=Util,globalThis.BITSMIST.V1.$CORE.ClassUtil=ClassUtil,globalThis.BITSMIST.V1.$CORE.AjaxUtil=AjaxUtil,globalThis.BITSMIST.V1.$CORE.URLUtil=URLUtil,globalThis.BITSMIST.V1.$CORE.Store=Store,globalThis.BITSMIST.V1.$CORE.ChainableStore=ChainableStore,globalThis.BITSMIST.V1.$CORE.Perk=Perk,globalThis.BITSMIST.V1.$CORE.Unit=Unit),globalThis.BITSMIST.V1.Unit=Unit,Perk.registerPerk(BasicPerk),Perk.registerPerk(Perk),Perk.registerPerk(SettingPerk),Perk.registerPerk(StatusPerk),Perk.registerPerk(SkinPerk),Perk.registerPerk(StylePerk),Perk.registerPerk(EventPerk),Perk.registerPerk(UnitPerk),BasicPerk.ready.then((async()=>{Unit.get("setting","system.unit.options.autoLoadOnStartup",!0)&&Unit.cast("unit.materializeAll",document.body,{waitForTags:!1})}));export{AjaxUtil,ChainableStore,ClassUtil,Perk,Store,URLUtil,Unit,Util};
