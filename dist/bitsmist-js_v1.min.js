!function(){"use strict";class e{static safeGet(e,t,s){let n=e,r=!0,i=t.split(".");for(let e=0;e<i.length;e++){if(null===n||"object"!=typeof n||!(i[e]in n)){r=!1;break}n=n[i[e]]}return r?n:s}static safeSet(t,s,n){let r=s.split("."),i=e.__createIntermediateObject(t,r);return e.assert(null!==i&&"object"==typeof i,`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${s}, existingKey=${r.length>1?r[r.length-2]:""}, existingValue=${i}`,TypeError),i[r[r.length-1]]=n,t}static safeRemove(e,t){let s=!0,n=e,r=t.split(".");for(let e=0;e<r.length-1;e++){if(!(r[e]in n)){s=!1;break}n=n[r[e]]}return s&&delete n[r[r.length-1]],e}static safeMerge(t,s,n){let r=s.split("."),i=e.__createIntermediateObject(t,r);e.assert(i&&"object"==typeof i,`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${s}, existingKey=${r.length>1?r[r.length-2]:""}, existingValue=${i}`,TypeError);let a=r[r.length-1];return i[a]=e.deepMerge(i[a],n),t}static safeHas(e,t){let s=e,n=!0,r=t.split(".");for(let e=0;e<r.length;e++){if(!s||"object"!=typeof s||!(r[e]in s)){n=!1;break}s=s[r[e]]}return n}static safeEval(e,t,s){let n,r=[];s&&(n=Object.keys(s).join(","),Object.keys(s).forEach((e=>{r.push(s[e])})));let i=!1;try{i=Function(n,'"use strict";return ('+e+")").apply(t,r)}catch(e){}return i}static concatPath(e){let t=e[0]||"";for(let s=1;s<e.length;s++)e[s]&&("/"===t.slice(t.length-1)&&"/"===e[s].slice(0,1)?t+=e[s].slice(1):"/"===t.slice(t.length-1)||"/"===e[s].slice(0,1)?t+=e[s]:t?t+="/"+e[s]:t=e[s]);return t}static deepMerge(t,s){let n=t;return Array.isArray(t)?Array.isArray(s)?Array.prototype.push.apply(n,e.__cloneArr(s)):n.push(e.deepClone(s)):e.__isObject(t)&&e.__isMergeable(s)?Object.keys(s).forEach((r=>{n[r]=e.deepMerge(t[r],s[r])})):void 0===s||(n=e.deepClone(s)),n}static deepClone(t){return Array.isArray(t)?e.__cloneArr(t):e.__isObject(t)?e.__cloneObj(t):t}static getClassNameFromTagName(e){let t=e.split("-");return t[0].charAt(0).toUpperCase()+t[0].slice(1).toLowerCase()+t[1].charAt(0).toUpperCase()+t[1].slice(1).toLowerCase()}static getTagNameFromClassName(t){let s,n=t,r=t.split("."),i=r[r.length-1];for(s=1;s<i.length&&!e.__isUpper(i.substring(s,s+1));s++);return s<i.length&&(n=i.substring(0,s).toLowerCase()+"-"+i.substring(s).toLowerCase()),n}static parseURL(e){var t=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),s=e.match(t);let n={protocol:s[2],hostname:s[4],pathname:s[5],path:"",filename:"",filenameWithoutExtension:"",extension:"",query:s[7],hash:s[8]};n.path=(n.protocol?n.protocol+"://":"")+(n.hostname?n.hostname:"");let r=s[5].lastIndexOf("/");r>-1?(n.path+=s[5].substr(0,r+1),n.filename=s[5].substr(r+1)):n.filename=s[5];let i=n.filename.lastIndexOf(".");return i?(n.filenameWithoutExtension=n.filename.substr(0,i),n.extension=n.filename.substr(i+1)):n.filenameWithoutExtension=n.filename,n}static assert(e,t,s,n){if(!e){let e=new(s=s||Error)(t),n=e.stack.split("\n");throw n.splice(1,1),e.stack=n.join("\n"),e}}static warn(e,t,s,n){let r=!0;return e||(s=s||"warn",r=!1),r}static randomWait(e,t){let s=t?e:Math.floor(Math.random()*e);return new Promise(((e,t)=>{setTimeout((()=>{e()}),s)}))}static scopedSelectorAll(e,t,s){let n=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16);e.setAttribute("__bm_tempid",n);let r="[__bm_tempid='"+n+"'] ",i=r+t.replace(",",","+r),a=e.querySelectorAll(i),o=new Set(a);if(s&&!s.penetrate){let s=r+"[bm-powered] "+t.replace(",",", "+r+"[bm-powered] "),n=e.querySelectorAll(s);new Set(n).forEach((e=>{o.delete(e)}))}return e.removeAttribute("__bm_tempid"),Array.from(o)}static getUUID(){let e="";for(let t=0;t<32;t++){let s=16*Math.random()|0;8!=t&&12!=t&&16!=t&&20!=t||(e+="-"),e+=(12==t?4:16==t?3&s|8:s).toString(16)}return e}static __isUpper(e){return e===e.toUpperCase()&&e!==e.toLowerCase()}static __createIntermediateObject(t,s){let n=t;for(let t=0;t<s.length-1;t++)e.assert(null!==n&&"object"==typeof n,`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. existingKey=${t>0?s[t-1]:""}, existingValue=${n}`,TypeError),s[t]in n||(n[s[t]]={}),n=n[s[t]];return n}static __cloneObj(t){let s={};return Object.keys(t).forEach((n=>{s[n]=e.deepClone(t[n])})),s}static __cloneArr(t){let s=[];for(let n=0;n<t.length;n++)s.push(e.deepClone(t[n]));return s}static __isObject(e){let t=typeof e,s=e&&e.constructor&&e.constructor.name;return null!==e&&"Object"===s&&"function"!==t}static __isMergeable(t){return e.__isObject(t)||Array.isArray(t)}}class t{static newComponent(e,s,n,r){n=n||BITSMIST.v1.Component;let i=Function("superClass","return function "+t.__validateClassName(e)+"(){ return Reflect.construct(superClass, [], this.constructor); }")(n);return t.inherit(i,n),(s=s||{}).settings=s.settings?s.settings:{},s.settings.name=e,i.prototype._getSettings=function(){return s},window[e]=i,r&&customElements.define(r.toLowerCase(),i),i}static inherit(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e}static createObject(s,...n){let r=t.getClass(s);return e.assert(r,`ClassUtil.createObject(): Class '${s}' is not defined.`,ReferenceError),new r(...n)}static getClass(e){let s;try{s=Function("return ("+t.__validateClassName(e)+")")()}catch(e){if(!(e instanceof ReferenceError))throw e}return s}static __validateClassName(t){let s=/^[a-zA-Z0-9\-\._]+$/.test(t);return e.assert(s,`ClassUtil.__validateClassName(): Class name '${t}' is not valid.`,TypeError),t}}class s{static ajaxRequest(t){return new Promise(((s,n)=>{let r=e.safeGet(t,"url"),i=e.safeGet(t,"method"),a=e.safeGet(t,"data",""),o=e.safeGet(t,"headers"),l=e.safeGet(t,"options"),g=new XMLHttpRequest;g.open(i,r,!0),l&&Object.keys(l).forEach((e=>{g[e]=l[e]})),o&&Object.keys(o).forEach((e=>{g.setRequestHeader(e,o[e])})),g.addEventListener("load",(()=>{200===g.status||201===g.status?s(g):n(g)})),g.addEventListener("error",(()=>{n(g)})),g.send(a)}))}static loadScript(e){return new Promise(((t,s)=>{let n=document.createElement("script");n.src=e,n.async=!0,n.onload=()=>{t()},n.onerror=e=>{s(e)},document.getElementsByTagName("head")[0].appendChild(n)}))}}class n{constructor(t){this._options=t||{},this._items=e.safeGet(t,"items",{}),this.merger=e.safeGet(t,"merger",e.deepMerge)}get options(){return this._options}set options(e){this._options=e}get items(){return this.clone()}set items(e){this._items=e}get merger(){this._merger}set merger(t){e.assert("function"==typeof t,`Store.merger(setter): Merger is not a function. merger=${t}`,TypeError),this._merger=t}clear(){this._items={}}clone(){return e.deepMerge({},this._items)}merge(e,t){t=t||this._merger;let s=Array.isArray(e)?e:[e];for(let e=0;e<s.length;e++)this._items=t(this._items,s[e])}get(t,s){return e.safeGet(this._items,t,s)}set(t,s,n){if(n&&n.merge)return e.safeMerge(this._items,t,defaultValue);e.safeSet(this._items,t,s)}remove(t){e.safeRemove(this._items,t)}has(t){return e.safeHas(this._items,t)}}class r extends n{constructor(t){super(t),this._chain;let s=e.safeGet(this._options,"chain");s&&this.chain(s)}get localItems(){return n.prototype.clone.call(this)}clone(){return this._chain?e.deepMerge(this._chain.clone(),this._items):n.prototype.clone.call(this)}chain(t){e.assert(t instanceof r,'ChainableStore.chain(): "store" parameter must be a ChainableStore.',TypeError),this._chain=t}get(e,t){let s=t;return n.prototype.has.call(this,e)?s=n.prototype.get.call(this,e,t):this._chain&&(s=this._chain.get(e,t)),s}merge(e,t){this._options.writeThrough?this._chain.merge(e,t):n.prototype.merge.call(this,e,t)}set(t,s,r){e.safeGet(r,"writeThrough",this._options.writeThrough)?this._chain.set(t,s,r):n.prototype.set.call(this,t,s,r)}has(t){let s=e.safeHas(this._items,t);return!1===s&&this._chain&&(s=e.safeHas(this._chain._items,t)),s}}class i{static get name(){return"Organizer"}static getInfo(){return{}}static globalInit(){}static init(e,t){}static deinit(e,t){}static getEditor(){return""}static _addOrganizerHandler(e,t,s){e.addEventHandler(t,{handler:s,order:this.getInfo().order})}}class a extends i{static get name(){return"OrganizerOrganizer"}static get organizers(){return a._organizers}static getInfo(){return{sections:"organizers",order:0}}static globalInit(){Object.defineProperty(BITSMIST.v1.Component.prototype,"organizers",{get(){return this._organizers}})}static init(e,t){BITSMIST.v1.Component.prototype.attachOrganizers=function(...e){return a._attachOrganizers(this,...e)}}static attach(e,t,s){if(e._organizers=e._organizers||{},!e._organizers[t.name]){let n=a._organizers[t.name].depends;for(let t=0;t<n.length;t++)a.attach(e,a._organizers[n[t]].object,s);return e._organizers[t.name]={object:t},t.init(e,s)}}static register(e){let t=e.getInfo();t.sections=t.sections||[],t.sections=Array.isArray(t.sections)?t.sections:[t.sections],t.order="order"in t?t.order:500,t.depends=t.depends||[],t.depends=Array.isArray(t.depends)?t.depends:[t.depends],a._organizers[e.name]={name:e.name,object:e,sections:t.sections,order:t.order,depends:t.depends},e.globalInit();for(let s=0;s<t.sections.length;s++)a._sections[t.sections[s]]=a._organizers[e.name]}static _attachOrganizers(e,t){let s=t.settings,n=Promise.resolve(),r=a.__listNewOrganizers(e,s);return a.__sortItems(r).forEach((s=>{n=n.then((()=>a.attach(e,a._organizers[s].object,t)))})),n}static __listNewOrganizers(t,s){let n={};Promise.resolve();let r=s.organizers;return r&&Object.keys(r).forEach((s=>{e.assert(a._organizers[s],`OrganizerOrganizer.__listNewOrganizer(): Organizer not found. name=${t.name}, organizerName=${s}`),e.safeGet(r[s],"settings.attach")&&!t._organizers[s]&&(n[s]=a._organizers[s])})),Object.keys(s).forEach((e=>{let s=a._sections[e];s&&!t._organizers[s.name]&&(n[s.name]=s)})),n}static __sortItems(e){return Object.keys(e).sort(((t,s)=>e[t].order-e[s].order))}}a._organizers={},a._sections={};class o extends i{static get name(){return"SettingOrganizer"}static SettingOrganizer_onDoOrganize(t,s,n){this._name=e.safeGet(s.detail.settings,"settings.name",this._name),this._rootElement=e.safeGet(s.detail.settings,"settings.rootElement",this._rootElement)}static getInfo(){return{sections:"settings",order:10}}static globalInit(){Object.defineProperty(BITSMIST.v1.Component.prototype,"settings",{get(){return this._settings}}),BITSMIST.v1.Component.prototype.loadSettings=function(...e){return o._loadSettings(this,...e)},BITSMIST.v1.Component.prototype._enumSettings=function(...e){return o._enumSettings(...e)}}static init(e,t){let s=t.settings||{};return e._settings=new r({items:s}),this._addOrganizerHandler(e,"doOrganize",o.SettingOrganizer_onDoOrganize),e._settings.get("settings.useGlobalSettings")&&e._settings.chain(BITSMIST.v1.settings),Promise.resolve().then((()=>o._loadExternalSetting(e,"setting"))).then((()=>{o._loadAttrSettings(e)})).then((()=>e.attachOrganizers({settings:e._settings.items}))).then((()=>e.trigger("doOrganize",{settings:e._settings.items}))).then((()=>e.trigger("afterLoadSettings",{settings:e._settings.items})))}static loadFile(t,n,r){let i,a=e.safeGet(r,"type","js"),o=e.safeGet(r,"query"),l=e.concatPath([n,t+"."+a])+(o?"?"+o:"");return s.ajaxRequest({url:l,method:"GET"}).then((t=>{if("json"===a)try{i=JSON.parse(t.responseText)}catch(e){throw e instanceof SyntaxError?new SyntaxError(`Illegal json string. url=${l}, message=${e.message}`):e}else{let s=e.safeGet(r,"bindTo");i=Function('"use strict";return ('+t.responseText+")").call(s)}return i}))}static _loadSettings(t,s,n){let r;return Promise.resolve().then((()=>(r=e.safeGet(n,"path",e.concatPath([t.settings.get("system.appBaseUrl"),t.settings.get("system.componentPath"),t.settings.get("settings.path","")])),o.loadFile(s,r,Object.assign({type:"js",bindTo:t},n))))).then((e=>{e&&t.settings.merge(e)}))}static _loadExternalSetting(t,s){let n,r={};if(t.hasAttribute("bm-"+s+"ref")){let i=e.parseURL(t.getAttribute("bm-"+s+"ref"));n=i.filenameWithoutExtension,r.path=i.path,r.query=i.query}else{let e=t.hasAttribute("bm-"+s+"path")?t.getAttribute("bm-"+s+"path"):"";n=t.hasAttribute("bm-"+s+"name")?t.getAttribute("bm-"+s+"name"):"",e&&!n&&(n="settings"),r.path=e}if(n||r.path)return o._loadSettings(t,n,r)}static _loadAttrSettings(e){let t=document.querySelector(e._settings.get("settings.rootNode"))?document.querySelector(e._settings.get("settings.rootNode")).getAttribute("bm-settings"):e.getAttribute("bm-settings");if(t){let s={settings:JSON.parse(t)};e._settings.merge(s)}}static _enumSettings(t,s){e.assert("function"==typeof s,"not function"),t&&Object.keys(t).forEach((e=>{"settings"!==e&&s(e,t[e])}))}}function l(){return Reflect.construct(HTMLElement,[],this.constructor)}t.inherit(l,HTMLElement),l.prototype.connectedCallback=function(){this._ready||(this._ready=Promise.resolve(),this.setAttribute("bm-powered",""),this._uniqueId=e.getUUID(),this._name=this.constructor.name,this._rootElement=this),this._ready=this._ready.then((()=>this.changeState("connected"))).then((()=>!this._initialized||this.settings.get("settings.autoRestart")?(this._initialized=!0,this.start()):this.changeState("ready")))},l.prototype.disconnectedCallback=function(){this._ready=this._ready.then((()=>{if(this.settings.get("settings.autoStop"))return this.stop()})).then((()=>this.changeState("disconnected")))},l.prototype.adoptedCallback=function(){},l.prototype.attributeChangedCallback=function(){},Object.defineProperty(l.prototype,"name",{get(){return this._name}}),Object.defineProperty(l.prototype,"uniqueId",{get(){return this._uniqueId}}),Object.defineProperty(l.prototype,"rootElement",{get(){return this._rootElement}}),l.prototype.start=function(t){return t=e.deepMerge({settings:{autoClear:!0,autoFetch:!0,autoFill:!0,autoRefresh:!0,autoRestart:!1,autoSetup:!0,autoStop:!0,autoTransform:!0,useGlobalSettings:!0},organizers:{StateOrganizer:{settings:{attach:!0}},EventOrganizer:{settings:{attach:!0}},TemplateOrganizer:{settings:{attach:!0}},ComponentOrganizer:{settings:{attach:!0}}}},t),Promise.resolve().then((()=>a.attach(this,a))).then((()=>this._injectSettings(t))).then((e=>this.__mergeSettings(e))).then((e=>a.attach(this,o,{settings:e}))).then((()=>this.trigger("beforeStart"))).then((()=>this.changeState("starting"))).then((()=>{if(this.settings.get("settings.autoTransform"))return this.transform()})).then((()=>{if(this.settings.get("settings.autoRefresh"))return this.refresh()})).then((()=>this.trigger("doStart"))).then((()=>(window.getComputedStyle(this).getPropertyValue("visibility"),this.changeState("started")))).then((()=>this.trigger("afterStart"))).then((()=>this.changeState("ready"))).then((()=>this.trigger("afterReady")))},l.prototype.stop=function(e){return e=e||{},Promise.resolve().then((()=>this.changeState("stopping"))).then((()=>this.trigger("beforeStop",e))).then((()=>this.trigger("doStop",e))).then((()=>this.changeState("stopped"))).then((()=>this.trigger("afterStop",e)))},l.prototype.transform=function(t){t=t||{};e.safeGet(t,"templateName","");return Promise.resolve().then((()=>this.trigger("beforeTransform",t))).then((()=>this.trigger("doTransform",t))).then((()=>{if(this.settings.get("settings.autoSetup"))return this.setup(t)})).then((()=>this.loadTags(this.rootElement))).then((()=>this.trigger("afterTransform",t)))},l.prototype.setup=function(e){return e=e||{},Promise.resolve().then((()=>this.trigger("beforeSetup",e))).then((()=>this.trigger("doSetup",e))).then((()=>this.trigger("afterSetup",e)))},l.prototype.refresh=function(t){return t=t||{},Promise.resolve().then((()=>this.trigger("beforeRefresh",t))).then((()=>{if(e.safeGet(t,"autoClear",this.settings.get("settings.autoClear")))return this.clear()})).then((()=>this.trigger("doTarget",t))).then((()=>{if(e.safeGet(t,"autoFetch",this.settings.get("settings.autoFetch")))return this.fetch(t)})).then((()=>{if(e.safeGet(t,"autoFill",this.settings.get("settings.autoFill")))return this.fill(t)})).then((()=>this.trigger("doRefresh",t))).then((()=>this.trigger("afterRefresh",t)))},l.prototype.fetch=function(e){return e=e||{},Promise.resolve().then((()=>this.trigger("beforeFetch",e))).then((()=>this.trigger("doFetch",e))).then((()=>this.trigger("afterFetch",e))).then((()=>{}))},l.prototype.fill=function(e){return e=e||{},Promise.resolve().then((()=>this.trigger("beforeFill",e))).then((()=>this.trigger("doFill",e))).then((()=>this.trigger("afterFill",e)))},l.prototype.clear=function(e){return Promise.resolve().then((()=>this.trigger("beforeClear",e))).then((()=>this.trigger("doClear",e))).then((()=>this.trigger("afterClear",e)))},l.prototype.scopedSelectorAll=function(t){return e.scopedSelectorAll(this,t)},l.prototype._injectSettings=function(e){return e},l.prototype._getSettings=function(){return{}},l.prototype.__mergeSettings=function(t){let s,n=Object.getPrototypeOf(this),r={};for(;"function"==typeof Object.getPrototypeOf(n)._getSettings;)s=Object.getPrototypeOf(n)._getSettings(),Object.keys(s).length>0&&(e.deepMerge(s,r),r=s),n=Object.getPrototypeOf(n);return e.deepMerge(t,r),e.deepMerge(t,this._getSettings()),t},customElements.define("bm-component",l);class g extends i{static get name(){return"StateOrganizer"}static StateOrganizer_onDoOrganize(e,t,s){this._enumSettings(t.detail.settings.waitFor,((e,t)=>{this.addEventHandler(e,{handler:g.StateOrganizer_onDoProcess,options:t})}))}static StateOrganizer_onDoProcess(e,t,s){return g._waitFor(this,s.options)}static getInfo(){return{sections:"waitFor",order:100}}static globalInit(){Object.defineProperty(BITSMIST.v1.Component.prototype,"state",{get(){return this._state},set(e){this._state=e}}),BITSMIST.v1.Component.prototype.changeState=function(...e){return g._changeState(this,...e)},BITSMIST.v1.Component.prototype.waitFor=function(...e){return g._waitFor(this,...e)},BITSMIST.v1.Component.prototype.suspend=function(...e){return g._suspend(this,...e)},BITSMIST.v1.Component.prototype.resume=function(...e){return g._resume(this,...e)},BITSMIST.v1.Component.prototype.pause=function(...e){return g._pause(this,...e)},g._components=new n,g._waitingList=new n,g.__suspends={},g.waitFor=function(e,t){return g._waitFor(null,e,t)}}static init(e,t){e._state="",e._suspends={},g._loadAttrSettings(e),this._addOrganizerHandler(e,"doOrganize",g.StateOrganizer_onDoOrganize)}static globalSuspend(e){g.__suspends[e]=g.__createSuspendInfo(e),g.__suspends[e].state="pending"}static globalResume(e){g.__suspends[e].resolve(),g.__suspends[e].state="resolved"}static _waitFor(t,s,n){let r,i=n&&n.timeout||t&&t.settings.get("system.waitForTimeout")||BITSMIST.v1.settings.get("system.waitForTimeout",1e4),a={waiter:n&&n.waiter?n.waiter:t,waitlist:e.deepClone(s)};return g.__isAllReady(a)?r=Promise.resolve():(r=new Promise(((e,n)=>{a.resolve=e,a.reject=n,a.timer=setTimeout((()=>{let e=t&&t.name||a.waiter&&a.waiter.tagName||"";n(`StateOrganizer._waitFor(): Timed out after ${i} milliseconds waiting for ${g.__dumpWaitlist(s)}, name=${e}, uniqueId=${t.uniqueId}.`)}),i)})),a.promise=r,g.__addToWaitingList(a)),r}static _changeState(t,s){e.assert(g.__isTransitionable(t._state,s),`StateOrganizer._changeState(): Illegal transition. name=${t.name}, fromState=${t._state}, toState=${s}, id=${t.id}`,Error),t._state=s,g._components.set(t.uniqueId,{object:t,state:s}),g.__processWaitingList()}static _suspend(e,t){e._suspends[t]=g.__createSuspendInfo(),e._suspends[t].state="pending"}static _resume(e,t){e._suspends[t].resolve(),e._suspends[t].state="resolved"}static _pause(e,t){let s=[];return g.__suspends[t]&&"pending"===g.__suspends[t].state&&!e.settings.get("settings.ignoreGlobalSuspend")&&s.push(g.__suspends[t].promise),e._suspends[t]&&"pending"===e._suspends[t].state&&s.push(e._suspends[t].promise),Promise.all(s)}static _loadAttrSettings(e){if(e.hasAttribute("bm-waitfor")){let t={name:e.getAttribute("bm-waitfor"),state:"ready"};e.settings.merge({waitFor:[t]})}if(e.hasAttribute("bm-waitfornode")){let t={rootNode:e.getAttribute("bm-waitfornode"),state:"ready"};e.settings.merge({waitFor:[t]})}}static __processWaitingList(){let e=[];Object.keys(g._waitingList.items).forEach((t=>{g.__isAllReady(g._waitingList.get(t))&&(clearTimeout(g._waitingList.get(t).timer),g._waitingList.get(t).resolve(),e.push(t))}));for(let t=0;t<e.length;t++)g._waitingList.remove(e[t])}static __addToWaitingList(t){let s=e.getUUID();g._waitingList.set(s,t)}static __isTransitionable(e,t){let s=!0;return e&&"ing"===e.slice(-3)&&("stopping"===e&&"stopped"!==t||"starting"===e&&"started"!==t)&&(s=!1),s}static __getComponentInfo(e){let t;if(e.id)t=g._components.get(e.id);else if(e.name)Object.keys(g._components.items).forEach((s=>{e.name===g._components.get(s).object.name&&(t=g._components.get(s))}));else if(e.rootNode){let s=document.querySelector(e.rootNode);s&&s.uniqueId&&(t=g._components.get(s.uniqueId))}else if(e.object){let s=e.object;s.uniqueId&&(t=g._components.get(s.uniqueId))}return t}static __isAllReady(e){let t=!0,s=e.waitlist;for(let e=0;e<s.length;e++){let n=!1,r=this.__getComponentInfo(s[e]);if(r&&g.__isReady(s[e],r)&&(n=!0),!n){t=!1;break}}return t}static __isReady(e,t){let s=g.__isComponentMatch(t,e);return s&&(s=g.__isStateMatch(t.state,e.state)),s}static __isComponentMatch(e,t){let s=!0;return(t.object&&e.object!==t.object||t.name&&e.object.name!==t.name||t.id&&e.object.uniqueId!==t.id||t.rootNode&&!document.querySelector(t.rootNode))&&(s=!1),s}static __isStateMatch(e,t){t=t||"ready";let s=!1;switch(e){case"ready":"ready"!==t&&"started"!==t&&"starting"!==t||(s=!0);break;case"started":"started"!==t&&"starting"!==t||(s=!0);break;case"stopped":"stopped"!==t&&"stopping"!==t||(s=!0);break;default:e===t&&(s=!0)}return s}static __dumpWaitlist(e){let t="";for(let s=0;s<e.length;s++){t+="\n\t{"+(e[s].id?"id:"+e[s].id+",":"")+(e[s].name?"name:"+e[s].name+",":"")+(e[s].object?"element:"+e[s].object.tagName+",":"")+(e[s].rootNode?"node:"+e[s].rootNode+",":"")+(e[s].state?"state:"+e[s].state:"")+"},"}return"["+t+"\n]"}static __createSuspendInfo(){let e={},t=new Promise(((t,s)=>{e.resolve=t,e.reject=s,e.state="pending"}));return e.promise=t,e}}class c extends i{static get name(){return"TemplateOrganizer"}static TemplateOrganizer_onDoOrganize(e,t,s){let n=[];this._enumSettings(t.detail.settings.templates,((e,t)=>{"html"!==t.type&&"url"!==t.type||n.push(this.loadTemplate(e))}))}static TemplateOrganizer_onDoTransform(e,t,s){if(this.settings.get("templates.settings.hasTemplate",!0)){let e=this.settings.get("templates.settings.templateName");return Promise.resolve().then((()=>this.loadTemplate(e))).then((()=>this.applyTemplate(e)))}}static TemplateOrganizer_onAfterTransform(e,t,s){let n=[];return this._enumSettings(this.settings.get("templates"),((e,t)=>{"node"===t.type&&n.push(this.loadTemplate(e))})),Promise.all(n)}static getInfo(){return{sections:"templates",order:200}}static globalInit(){Object.defineProperty(BITSMIST.v1.Component.prototype,"templates",{get(){return this._templates}}),Object.defineProperty(BITSMIST.v1.Component.prototype,"activeTemplateName",{get(){return this._activeTemplateName},set(e){this._activeTemplateName=e}}),BITSMIST.v1.Component.prototype.loadTemplate=function(...e){return c._loadTemplate(this,...e)},BITSMIST.v1.Component.prototype.applyTemplate=function(...e){return c._applyTemplate(this,...e)},BITSMIST.v1.Component.prototype.cloneTemplate=function(...e){return c._clone(this,...e)}}static init(e,t){if(e._templates={},e._activeTemplateName="",!e.settings.get("templates.settings.templateName")){let t=e.settings.get("settings.fileName",e.tagName.toLowerCase());e.settings.set("templates.settings.templateName",t)}this._addOrganizerHandler(e,"doOrganize",c.TemplateOrganizer_onDoOrganize),this._addOrganizerHandler(e,"doTransform",c.TemplateOrganizer_onDoTransform),this._addOrganizerHandler(e,"afterTransform",c.TemplateOrganizer_onAfterTransform)}static loadFile(t,n,r){let i=e.safeGet(r,"query"),a=e.concatPath([n,t])+".html"+(i?"?"+i:"");return s.ajaxRequest({url:a,method:"GET"}).then((e=>e.responseText))}static _loadTemplate(t,s,n){let r,i=t._templates[s]||c.__createTemplateInfo(t,s);if(i.isLoaded)return Promise.resolve();let a=t.settings.get("templates."+s,{});switch(a.type){case"html":i.html=a.html,r=Promise.resolve();break;case"node":i.html=t.querySelector(a.rootNode).innerHTML,r=Promise.resolve();break;default:let s=e.safeGet(n,"path",e.concatPath([t.settings.get("system.appBaseUrl",""),t.settings.get("system.templatePath",t.settings.get("system.componentPath","")),t.settings.get("settings.path","")]));r=c.loadFile(i.name,s,n).then((e=>{i.html=e}))}return r.then((()=>{i.isLoaded=!0}))}static _applyTemplate(t,s){if(t._activeTemplateName===s)return Promise.resolve();let n=t._templates[s];if(e.assert(n,`TemplateOrganizer._applyTemplate(): Template not loaded. name=${t.name}, templateName=${s}, id=${t.id}, uniqueId=${t.uniqueId}`,ReferenceError),n.node){let e=c.clone(t,n.name);t.insertBefore(e,t.firstChild)}else t.innerHTML=n.html;t._activeTemplateName=s}static _clone(t,s){s=s||t.settings.get("settings.templateName");let n,r=t._templates[s];if(e.assert(r,`TemplateOrganizer._clone(): Template not loaded. name=${t.name}, templateName=${s}, id=${t.id}, uniqueId=${t.uniqueId}`,ReferenceError),r.node)n=document.importNode(r.node,!0);else{let e=document.createElement("div");e.innerHTML=r.html,n=e.firstElementChild}return n}static __createTemplateInfo(e,t){return e._templates[t]||(e._templates[t]={},e._templates[t].name=t,e._templates[t].html="",e._templates[t].isLoaded=!1),e._templates[t]}}class m extends i{static get name(){return"EventOrganizer"}static EventOrganizer_onDoOrganize(e,t,s){this._enumSettings(t.detail.settings.events,((e,t)=>{m._initEvents(this,e,t)}))}static EventOrganizer_onAfterTransform(e,t,s){this._enumSettings(this.settings.get("events"),((e,t)=>{m.__isTargetSelf(e,t)||m._initEvents(this,e,t)}))}static getInfo(){return{sections:"events",order:210}}static globalInit(){BITSMIST.v1.Component.prototype.initEvents=function(...e){m._initEvents(this,...e)},BITSMIST.v1.Component.prototype.addEventHandler=function(...e){m._addEventHandler(this,...e)},BITSMIST.v1.Component.prototype.trigger=function(...e){return m._trigger(this,...e)},BITSMIST.v1.Component.prototype.triggerAsync=function(...e){return m._triggerAsync(this,...e)},BITSMIST.v1.Component.prototype.removeEventHandler=function(...e){return m._removeEventHandler(this,...e)}}static init(e,t){this._addOrganizerHandler(e,"doOrganize",m.EventOrganizer_onDoOrganize),this._addOrganizerHandler(e,"afterTransform",m.EventOrganizer_onAfterTransform)}static deinit(e,t){let s=this.settings.get("events");s&&Object.keys(s).forEach((t=>{m._removeEvents(e,t,s[eventName])}))}static _addEventHandler(t,s,n,r,i){r=r||t;let a="object"==typeof n?n:{},o=m._getEventHandler(t,n);e.assert(o,`EventOrganizer._addEventHandler(): handler not found. name=${t.name}, eventName=${s}`),r.__bm_eventinfo||(r.__bm_eventinfo={component:t,listeners:{},promises:{},statuses:{}});let l=r.__bm_eventinfo.listeners;l[s]||(l[s]=[],r.addEventListener(s,m.__callEventHandler,a.listnerOptions));let g=e.safeGet(a,"order",1e3);l[s].push({handler:o,options:a.options,bindTo:i,order:g}),l[s].sort(((e,t)=>e.order===t.order?0:e.order>t.order?1:-1))}static _removeEventHandler(t,s,n,r){s=s||t;let i=m._getEventHandler(t,r);e.assert(i,`EventOrganizer._removeEventHandler(): handler not found. name=${t.name}, eventName=${n}`);let a=e.safeGet(s,"__bm_eventinfo.listeners."+n);if(a)for(let e=a.length-1;e>=0;e--)if(a[e].handler===i){a.splice(e,1);break}}static _initEvents(e,t,s,n){n=n||e,s=s||e.settings.get("events."+t);let r=m.__getTargetElements(e,n,t,s);Object.keys(s.handlers).forEach((t=>{let n=Array.isArray(s.handlers[t])?s.handlers[t]:[s.handlers[t]];for(let s=0;s<n.length;s++)for(let i=0;i<r.length;i++)e.addEventHandler(t,n[s],r[i])}))}static _removeEvents(e,t,s,n){n=n||e;let r=m.__getTargetElements(e,n,t,s);Object.keys(s.handlers).forEach((t=>{let n=Array.isArray(s.handlers[t])?s.handlers[t]:[s.handlers[t]];for(let s=0;s<n.length;s++)for(let i=0;i<r.length;i++)e.removeEventHandler(t,n[s],r[i])}))}static _trigger(t,s,n,r){n=n||{},r=r||t;let i=null;try{i=new CustomEvent(s,{detail:n})}catch(e){i=document.createEvent("CustomEvent"),i.initCustomEvent(s,!1,!1,n)}return r.dispatchEvent(i),e.safeGet(r,"__bm_eventinfo.promises."+s)||Promise.resolve()}static _triggerAsync(e,t,s,n){return(s=s||{}).async=!0,m._trigger.call(e,e,t,s,n)}static _getEventHandler(e,t){return"object"==typeof t?t.handler:t}static __isTargetSelf(e,t){let s=!1;return("this"===e||t&&"this"===t.rootNode)&&(s=!0),s}static __getTargetElements(t,s,n,r){let i;return i=m.__isTargetSelf(n,r)?[s]:r&&r.rootNode?e.scopedSelectorAll(s,r.rootNode):e.scopedSelectorAll(s,"#"+n),i}static __isHandlerInstalled(t,s,n){let r=!1,i=e.safeGet(t.__bm_eventinfo,"listeners."+s);if(i)for(let e=0;e<i.length;e++)if(i[e].handler===n){r=!0;break}return r}static __callEventHandler(t){let s=e.safeGet(this,"__bm_eventinfo.listeners."+t.type),n=e.safeGet(t,"detail.sender",this),r=e.safeGet(this,"__bm_eventinfo.component");if(e.warn("handling"!==e.safeGet(this,"__bm_eventinfo.statuses."+t.type),`EventOrganizer.__callEventHandler(): Event handler is already running. name=${this.tagName}, eventName=${t.type}`),e.safeSet(this,"__bm_eventinfo.statuses."+t.type,"handling"),!1===e.safeGet(t,"detail.async",!1))this.__bm_eventinfo.promises[t.type]=m.__handle(t,n,r,s).then((()=>{e.safeSet(this,"__bm_eventinfo.promises."+t.type,null),e.safeSet(this,"__bm_eventinfo.statuses."+t.type,"")})).catch((s=>{throw e.safeSet(this,"__bm_eventinfo.promises."+t.type,null),e.safeSet(this,"__bm_eventinfo.statuses."+t.type,""),s}));else try{this.__bm_eventinfo.promises[t.type]=m.__handleAsync(t,n,r,s),e.safeSet(this,"__bm_eventinfo.promises."+t.type,null),e.safeSet(this,"__bm_eventinfo.statuses."+t.type,"")}catch(s){throw e.safeSet(this,"__bm_eventinfo.promises."+t.type,null),e.safeSet(this,"__bm_eventinfo.statuses."+t.type,""),s}}static __handle(t,s,n,r){let i=Promise.resolve(),a=!1;for(let o=0;o<r.length;o++){let l={component:n,options:r[o].options?r[o].options:{}};i=i.then((()=>{let i=r[o].handler;i="string"==typeof i?n[i]:i,e.assert("function"==typeof i,`EventOrganizer._addEventHandler(): Event handler is not a function. name=${n.name}, eventName=${t.type}`,TypeError);let a=r[o].bindTo?r[o].bindTo:n;return i.call(a,s,t,l)})),a=!(!r[o].options||!r[o].options.stopPropagation)||a}return a&&t.stopPropagation(),i}static __handleAsync(t,s,n,r){let i=!1;for(let a=0;a<r.length;a++){let o={component:n,options:r[a].options?r[a].options:{}},l=r[a].handler;l="string"==typeof l?n[l]:l,e.assert("function"==typeof l,`EventOrganizer._addEventHandler(): Event handler is not a function. name=${n.name}, eventName=${t.type}`,TypeError);let g=r[a].bindTo?r[a].bindTo:n;l.call(g,s,t,o),i=!(!r[a].options||!r[a].options.stopPropagation)||i}return i&&t.stopPropagation(),Promise.resolve()}}class p extends i{static get name(){return"ComponentOrganizer"}static ComponentOrganizer_onDoOrganize(e,t,s){let n=Promise.resolve();return this._enumSettings(t.detail.settings.molds,((e,t)=>{n=n.then((()=>{if(!this.components[e])return p._loadComponent(this,e,t,{syncOnAdd:!0})}))})),this._enumSettings(t.detail.settings.components,((e,t)=>{n=n.then((()=>{if(!this.components[e])return p._loadComponent(this,e,t)}))})),n}static getInfo(){return{sections:["molds","components"],order:400}}static globalInit(){Object.defineProperty(BITSMIST.v1.Component.prototype,"components",{get(){return this._components}}),BITSMIST.v1.Component.prototype.loadTags=function(...e){return p._loadTags(...e)},BITSMIST.v1.Component.prototype.loadComponent=function(...e){return p._loadComponent(this,...e)},p.__classes=new n,document.addEventListener("DOMContentLoaded",(()=>{BITSMIST.v1.settings.get("organizers.ComponentOrgaznier.settings.autoLoadOnStartup",!0)&&p._loadTags(document.body,{waitForTags:!1})}))}static init(e,t){e._components={},this._addOrganizerHandler(e,"doOrganize",p.ComponentOrganizer_onDoOrganize)}static loadFile(t,n,r){let i=e.safeGet(r,"query"),a=e.concatPath([n,t+".js"])+(i?"?"+i:""),o=e.concatPath([n,t+".settings.js"])+(i?"?"+i:"");return Promise.resolve().then((()=>s.loadScript(a))).then((()=>{if(r.splitComponent)return s.loadScript(o)})).then((()=>{}))}static _loadTags(t,s){let n=[];return e.scopedSelectorAll(t,"[bm-autoload]:not([bm-autoloading]):not([bm-powered]),[bm-automorph]:not([bm-autoloading]):not([bm-powered])").forEach((t=>{t.setAttribute("bm-autoloading","");let s=this._loadAttrSettings(t),r=e.safeGet(s,"settings.className",e.getClassNameFromTagName(t.tagName));t._injectSettings=function(t){return e.deepMerge(t,s)},n.push(p._loadClass(t.tagName.toLowerCase(),r,s).then((()=>{t.removeAttribute("bm-autoloading")})))})),Promise.all(n).then((()=>{if(e.safeGet(s,"waitForTags"))return p.__waitForChildren(t)}))}static _loadClass(s,n,r,i){if(customElements.get(s))return Promise.resolve();i=i||{};let a=e.safeGet(r,"settings.autoLoad");if(a=!0===a?"":a,a){let t=e.parseURL(a);r.system=r.system||{},r.system.appBaseUrl="",r.system.componentPath="",r.system.templatePath="",r.settings=r.settings||{},r.settings.path=t.path,r.settings.fileName=t.filenameWithoutExtension,"html"===t.extension&&(r.settings.autoMorph=!r.settings.autoMorph||r.settings.autoMorph),i.query=t.query}let o=e.safeGet(r,"settings.autoMorph",n);o=!0===o?"BITSMIST.v1.Component":o;let l=e.safeGet(i,"path",e.concatPath([e.safeGet(r,"system.appBaseUrl",BITSMIST.v1.settings.get("system.appBaseUrl","")),e.safeGet(r,"system.componentPath",BITSMIST.v1.settings.get("system.componentPath","")),e.safeGet(r,"settings.path","")])),g=e.safeGet(r,"settings.fileName",s.toLowerCase());return i.splitComponent=e.safeGet(i,"splitComponent",e.safeGet(r,"settings.splitComponent",BITSMIST.v1.settings.get("system.splitComponent",!1))),i.query=e.safeGet(i,"query",e.safeGet(r,"settings.query"),""),p.__autoloadClass(o,g,l,i).then((()=>{if(o!==n){let e=t.getClass(o);t.newComponent(n,r,e,s)}if(!customElements.get(s)){let r=t.getClass(n);e.assert(r,`ComponentOrganizer_loadClass(): Class does not exists. tagName=${s}, className=${n}`),customElements.define(s,r)}}))}static _loadComponent(t,s,n,r){let i,a,o=e.safeGet(n,"settings.tag");if(o){let e=/([\w-]+)\s+\w+.*?>/;i=o.match(e)[1]}else i=e.safeGet(n,"settings.tagName",e.getTagNameFromClassName(s)).toLowerCase();return Promise.resolve().then((()=>{if(e.safeGet(n,"settings.autoLoad")||e.safeGet(n,"settings.autoMorph")){let t=e.safeGet(n,"settings.className",s);return p._loadClass(i,t,n)}})).then((()=>{t._components[s]||(a=p.__insertTag(t,i,n),t._components[s]=a)})).then((()=>{let i=e.safeGet(r,"syncOnAdd",e.safeGet(n,"settings.syncOnAdd"));if(i){let e=!0===i?"ready":i;return t.waitFor([{id:t._components[s].uniqueId,state:e}])}})).then((()=>a))}static _loadAttrSettings(e){let t={settings:{}};return e.hasAttribute("bm-classname")&&(t.settings.className=e.getAttribute("bm-classname")),e.hasAttribute("bm-split")&&(t.system.splitComponent=!0),e.hasAttribute("bm-path")&&(t.settings.path=e.getAttribute("bm-path")),e.hasAttribute("bm-filename")&&(t.settings.fileName=e.getAttribute("bm-filename")),e.hasAttribute("bm-automorph")&&(t.settings.autoMorph=!e.getAttribute("bm-automorph")||e.getAttribute("bm-automorph")),e.hasAttribute("bm-autoload")&&(t.settings.autoLoad=!e.getAttribute("bm-autoload")||e.getAttribute("bm-autoload")),t}static __autoloadClass(e,t,s,n){let r;return p.__isLoadedClass(e)?(p.__classes.set(e+".state","loaded"),r=Promise.resolve()):"loading"===p.__classes.get(e,{}).state?r=p.__classes.get(e).promise:(p.__classes.set(e+".state","loading"),r=p.loadFile(t,s,n).then((()=>{p.__classes.set(e,{state:"loaded",promise:null})})),p.__classes.set(e+".promise",r)),r}static __insertTag(t,s,n){let r,i;i=e.safeGet(n,"settings.parentNode")?e.scopedSelectorAll(t.rootElement,e.safeGet(n,"settings.parentNode"),{penetrate:!0})[0]:t,e.assert(i,`ComponentOrganizer.__insertTag(): Root node does not exist. name=${t.name}, tagName=${s}, Ntrentode=${e.safeGet(n,"settings.parentNode")}`,ReferenceError);let a=e.safeGet(n,"settings.tag")?e.safeGet(n,"settings.tag"):"<"+s+"></"+s+">";if(e.safeGet(n,"settings.replaceParent"))i.outerHTML=a,r=i;else{let t=e.safeGet(n,"settings.adjacentPosition","afterbegin");switch(i.insertAdjacentHTML(t,a),t){case"beforebegin":r=i.previousSibling;break;case"afterbegin":r=i.children[0];break;case"beforeend":r=i.lastChild;break;case"afterend":r=i.nextSibling}}return r._injectSettings=function(t){return e.deepMerge(t,n)},r}static __waitForChildren(t){let s=[];return e.scopedSelectorAll(t,"[bm-powered],[bm-autoloading]").forEach((e=>{if(t!=e.rootElement&&!e.hasAttribute("bm-nowait")){let t={object:e,state:"ready"};s.push(t)}})),g.waitFor(s,{waiter:t})}static __isLoadedClass(e){let s=!1;return("loaded"===p.__classes.get(e,{}).state||t.getClass(e))&&(s=!0),s}}window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},window.BITSMIST.v1.Util=e,window.BITSMIST.v1.ClassUtil=t,window.BITSMIST.v1.AjaxUtil=s,window.BITSMIST.v1.Store=n,window.BITSMIST.v1.ChainableStore=r,window.BITSMIST.v1.settings=new r,window.BITSMIST.v1.Component=l,window.BITSMIST.v1.Organizer=i,window.BITSMIST.v1.OrganizerOrganizer=a,a.register(a),window.BITSMIST.v1.SettingOrganizer=o,a.register(o),window.BITSMIST.v1.StateOrganizer=g,a.register(g),window.BITSMIST.v1.TemplateOrganizer=c,a.register(c),window.BITSMIST.v1.EventOrganizer=m,a.register(m),window.BITSMIST.v1.ComponentOrganizer=p,a.register(p)}();
