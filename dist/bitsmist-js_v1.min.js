!function(){"use strict";class Util{static safeGet(t,e,s){let i=t,n=!0,r=e.split(".");for(let t=0;t<r.length;t++){if(null===i||"object"!=typeof i||!(r[t]in i)){n=!1;break}i=i[r[t]]}return n?i:s}static safeSet(t,e,s){let i=e.split("."),n=Util.__createIntermediateObject(t,i);return Util.assert(null!==n&&"object"==typeof n,`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${e}, existingKey=${i.length>1?i[i.length-2]:""}, existingValue=${n}`,TypeError),n[i[i.length-1]]=s,t}static safeRemove(t,e){let s=!0,i=t,n=e.split(".");for(let t=0;t<n.length-1;t++){if(!(n[t]in i)){s=!1;break}i=i[n[t]]}return s&&delete i[n[n.length-1]],t}static safeMerge(t,e,s){let i=e.split("."),n=Util.__createIntermediateObject(t,i);Util.assert(n&&"object"==typeof n,`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. key=${e}, existingKey=${i.length>1?i[i.length-2]:""}, existingValue=${n}`,TypeError);let r=i[i.length-1];return n[r]=Util.deepMerge(n[r],s),t}static safeHas(t,e){let s=t,i=!0,n=e.split(".");for(let t=0;t<n.length;t++){if(!s||"object"!=typeof s||!(n[t]in s)){i=!1;break}s=s[n[t]]}return i}static safeEval(t,e){let s=!1;try{s=Function(`"use strict";return (${t})`).apply(e)}catch(t){}return s}static concatPath(t){let e=t[0]||"";for(let s=1;s<t.length;s++)t[s]&&("/"===e.slice(e.length-1)&&"/"===t[s].slice(0,1)?e+=t[s].slice(1):"/"===e.slice(e.length-1)||"/"===t[s].slice(0,1)?e+=t[s]:e?e+="/"+t[s]:e=t[s]);return e}static deepMerge(t,e){let s=t;return Array.isArray(t)?Array.isArray(e)?Array.prototype.push.apply(s,Util.__cloneArr(e)):s.push(Util.deepClone(e)):Util.__isObject(t)&&Util.__isMergeable(e)?Object.keys(e).forEach((i=>{s[i]=Util.deepMerge(t[i],e[i])})):void 0===e||(s=Util.deepClone(e)),s}static deepClone(t){return Array.isArray(t)?Util.__cloneArr(t):Util.__isObject(t)?Util.__cloneObj(t):t}static getClassNameFromTagName(t){let e=t.split("-");return e[0].charAt(0).toUpperCase()+e[0].slice(1).toLowerCase()+e[1].charAt(0).toUpperCase()+e[1].slice(1).toLowerCase()}static getTagNameFromClassName(t){let e,s=t,i=t.split("."),n=i[i.length-1];for(e=1;e<n.length&&!Util.__isUpper(n.substring(e,e+1));e++);return e<n.length&&(s=n.substring(0,e).toLowerCase()+"-"+n.substring(e).toLowerCase()),s}static assert(t,e,s,i){if(!t){let t=new(s=s||Error)(e),i=t.stack.split("\n");throw i.splice(1,1),t.stack=i.join("\n"),t}}static warn(t,e,s,i){let n=!0;return t||(s=s||"warn",n=!1),n}static randomWait(t,e){let s=e?t:Math.floor(Math.random()*t);return new Promise(((t,e)=>{setTimeout((()=>{t()}),s)}))}static scopedSelectorAll(t,e,s){let i=t.unitRoot||t,n=i instanceof DocumentFragment?e:":scope "+e.replace(",",",:scope "),r=i.querySelectorAll(n),a=new Set(r);if(!s||!s.penetrate){let t=i instanceof DocumentFragment?"[bm-powered] "+e.replace(",",", [bm-powered] "):":scope [bm-powered] "+e.replace(",",", :scope [bm-powered] "),s=i.querySelectorAll(t);new Set(s).forEach((t=>{a.delete(t)}))}return Array.from(a)}static getUUID(){let t="";for(let e=0;e<32;e++){let s=16*Math.random()|0;8!=e&&12!=e&&16!=e&&20!=e||(t+="-"),t+=(12==e?4:16==e?3&s|8:s).toString(16)}return t}static getObject(t,e){let s;return Util.__isObject(t)?s=t:"string"==typeof t&&(s=e&&"js"===e.format?Util.safeEval(t,e&&e.bindTo):JSON.parse(t)),s}static __isUpper(t){return t===t.toUpperCase()&&t!==t.toLowerCase()}static __createIntermediateObject(t,e){let s=t;for(let t=0;t<e.length-1;t++)Util.assert(null!==s&&"object"==typeof s,`Util.safeSet(): Can't create an intermediate object. Non-object value already exists. existingKey=${t>0?e[t-1]:""}, existingValue=${s}`,TypeError),e[t]in s||(s[e[t]]={}),s=s[e[t]];return s}static __cloneObj(t){let e={};return Object.keys(t).forEach((s=>{e[s]=Util.deepClone(t[s])})),e}static __cloneArr(t){let e=[];for(let s=0;s<t.length;s++)e.push(Util.deepClone(t[s]));return e}static __isObject(t){let e=typeof t,s=t&&t.constructor&&t.constructor.name;return null!==t&&"Object"===s&&"function"!==e}static __isMergeable(t){return Util.__isObject(t)||Array.isArray(t)}}class ClassUtil{static newUnit(t,e,s,i){s=s||BITSMIST.v1.Unit;let n=Function("superClass",`return function ${ClassUtil.__validateClassName(t)}(){ return Reflect.construct(superClass, [], this.constructor); }`)(s);return ClassUtil.inherit(n,s),(e=e||{}).setting=e.setting?e.setting:{},n.prototype._getSettings=function(){return e},i&&customElements.define(i.toLowerCase(),n),n}static inherit(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}static createObject(t,...e){let s=ClassUtil.getClass(t);return Util.assert(s,`ClassUtil.createObject(): Class '${t}' is not defined.`,ReferenceError),new s(...e)}static getClass(t){let e;try{e=Function(`return (${ClassUtil.__validateClassName(t)})`)()}catch(t){if(!(t instanceof ReferenceError))throw t}return e}static __validateClassName(t){let e=/^[a-zA-Z0-9\-\._]+$/.test(t);return Util.assert(e,`ClassUtil.__validateClassName(): Class name '${t}' is not valid.`,TypeError),t}}class AjaxUtil{static ajaxRequest(t){return new Promise(((e,s)=>{let i=Util.safeGet(t,"URL"),n=Util.safeGet(t,"method"),r=Util.safeGet(t,"data",""),a=Util.safeGet(t,"headers"),l=Util.safeGet(t,"options"),o=new XMLHttpRequest;o.open(n,i,!0),l&&Object.keys(l).forEach((t=>{o[t]=l[t]})),a&&Object.keys(a).forEach((t=>{o.setRequestHeader(t,a[t])})),o.addEventListener("load",(()=>{200===o.status||201===o.status?e(o):s(o)})),o.addEventListener("error",(()=>{s(o)})),o.send(r)}))}static loadScript(t){return new Promise(((e,s)=>{let i=document.createElement("script");i.src=t,i.async=!0,i.onload=()=>{e()},i.onerror=t=>{s(t)},document.getElementsByTagName("head")[0].appendChild(i)}))}static loadJSON(t,e){let s=Util.safeGet(e,"format",t.split("?")[0].split(".").pop());return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>Util.getObject(t.responseText,{format:s})))}static loadText(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadHTML(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadCSS(t,e){return AjaxUtil.ajaxRequest({URL:t,method:"GET"}).then((t=>t.responseText))}static loadClass(t,e){let s=t+".js";return Promise.resolve().then((()=>AjaxUtil.loadScript(s))).then((()=>{if(e.splitClass){let e=t+".settings.js";return AjaxUtil.loadScript(e)}})).then((()=>{}))}}class URLUtil{static loadParameters(t){t=t||window.location.href;let e,s,i={};if(window.location.href.indexOf("?")>-1){let n=t.slice(t.indexOf("?")+1).split("&");for(let t=0;t<n.length;t++)e=n[t].split("="),s=e[1]?e[1].split("#")[0]:e[1],i[e[0]]=decodeURIComponent(s)}return i}static buildURL(t,e){let s=Object.assign({},URLUtil.parseURL(),t),i=t.URL?t.URL:Util.concatPath([s.protocol+"//",s.host,s.pathname]);if(s.queryParameters){let t={};e&&e.mergeParameters&&(t=Object.assign(t,URLUtil.loadParameters())),t=Object.assign(t,s.queryParameters),i+=URLUtil.buildQuery(t)}else i+=s.query;return i||"/"}static buildQuery(t){let e="";return t&&(e=Object.keys(t).reduce(((e,s)=>(Array.isArray(t[s])?e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s].join())}&`:t[s]&&(e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s])}&`),e)),"")),e?`?${e.slice(0,-1)}`:""}static parseURL(t){t=t||window.location.href;let e=new URL(t,window.location.href),s={protocol:e.protocol,username:e.username,password:e.password,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,path:e.pathname.substring(0,e.pathname.lastIndexOf("/")+1),search:e.search,query:e.search,hash:e.hash,filename:e.pathname.split("/").pop(),queryParameters:URLUtil.loadParameters(t)};return s.filenameWithoutExtension=s.filename.split(".")[0],s.extension=s.filename.split(".").pop(),s}}class Store{constructor(t){this._options=t||{},this._items=Util.safeGet(t,"items",{}),this.merger=Util.safeGet(t,"merger",Util.deepMerge)}get options(){return this._options}set options(t){this._options=t}get items(){return this.clone()}set items(t){this._items=t}get merger(){this._merger}set merger(t){Util.assert("function"==typeof t,`Store.merger(setter): Merger is not a function. merger=${t}`,TypeError),this._merger=t}clear(){this._items={}}clone(){return Util.deepMerge({},this._items)}merge(t,e){e=e||this._merger;let s=Array.isArray(t)?t:[t];for(let t=0;t<s.length;t++)this._items=e(this._items,s[t])}get(t,e){return Util.deepClone(Util.safeGet(this._items,t,e))}set(t,e,s){s&&s.merge?Util.safeMerge(this._items,t,defaultValue):Util.safeSet(this._items,t,e)}remove(t){Util.safeRemove(this._items,t)}has(t){return Util.safeHas(this._items,t)}}class ChainableStore extends Store{constructor(t){super(t),this._chain;let e=Util.safeGet(this._options,"chain");e&&this.chain(e)}get localItems(){return Store.prototype.clone.call(this)}clone(){return this._chain?Util.deepMerge(this._chain.clone(),this._items):Store.prototype.clone.call(this)}chain(t){this._chain=t}get(t,e){let s=e;return Store.prototype.has.call(this,t)&&this._chain&&Store.prototype.has.call(this._chain,t)?s=Util.deepMerge(Store.prototype.get.call(this._chain,t),Store.prototype.get.call(this,t)):Store.prototype.has.call(this,t)?s=Store.prototype.get.call(this,t,e):this._chain&&(s=this._chain.get(t,e)),s}merge(t,e){this._options.writeThrough?this._chain.merge(t,e):Store.prototype.merge.call(this,t,e)}set(t,e,s){Util.safeGet(s,"writeThrough",this._options.writeThrough)?this._chain.set(t,e,s):Store.prototype.set.call(this,t,e,s)}has(t){let e=Util.safeHas(this._items,t);return!1===e&&this._chain&&(e=this._chain.has(t)),e}}class Unit extends HTMLElement{connectedCallback(){this._connectedHandler(this)}disconnectedCallback(){this._disconnectedHandler(this)}adoptedCallback(){this._adoptedHandler(this)}attributeChangedCallback(t,e,s){this._attributeChangedHandler(this,t,e,s)}}customElements.define("bm-unit",Unit);class Perk{static get info(){return{}}static globalInit(){}static init(t,e){}static deinit(t,e){}static getEditor(){return""}static upgrade(t,e,s,i){switch(e){case"asset":t.__bm_assets[s]=i;break;case"method":t[s]=i;break;case"property":Object.defineProperty(t,s,i);break;case"event":t.use("skill","event.add",s,{handler:i,order:this.info.order});break;default:t.__bm_assets[e].set(s,i)}}}class StatusPerk extends Perk{static get info(){return{section:"status",order:100}}static globalInit(){StatusPerk._unitInfo=BITSMIST.v1.BasicPerk._unitInfo,StatusPerk._waitingList=new Store,StatusPerk.__suspends={},StatusPerk.waitFor=function(t,e){return StatusPerk._waitFor(BITSMIST.v1.Unit,t,e)},this.upgrade(BITSMIST.v1.Unit,"skill","status.change",(function(...t){return StatusPerk._changeStatus(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","status.wait",(function(...t){return StatusPerk._waitFor(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","status.suspend",(function(...t){return StatusPerk._suspend(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","status.resume",(function(...t){return StatusPerk._resume(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","status.pause",(function(...t){return StatusPerk._pause(...t)}))}static init(t,e){this.upgrade(t,"state","status.status","connected"),this.upgrade(t,"inventory","status.suspends",{}),this.upgrade(t,"event","doApplySettings",StatusPerk.StatusPerk_onDoApplySettings)}static globalSuspend(t){StatusPerk.__suspends[t]=StatusPerk.__createSuspendInfo(t),StatusPerk.__suspends[t].status="pending"}static globalResume(t){StatusPerk.__suspends[t].resolve(),StatusPerk.__suspends[t].status="resolved"}static StatusPerk_onDoApplySettings(t,e,s){Object.entries(Util.safeGet(e.detail,"settings.status.waitFor",{})).forEach((([t,e])=>{this.addEventHandler(t,{handler:StatusPerk.StatusPerk_onDoProcess,options:e})}))}static StatusPerk_onDoProcess(t,e,s){return StatusPerk._waitFor(this,s.options)}static _changeStatus(t,e){Util.assert(StatusPerk.__isTransitionable(t.get("state","status.status"),e),`StatusPerk._changeStatus(): Illegal transition. name=${t.tagName}, fromStatus=${t.get("state","status.status")}, toStatus=${e}, id=${t.id}`,Error),t.set("state","status.status",e),StatusPerk._unitInfo[t.uniqueId].status=e,StatusPerk.__processWaitingList()}static _waitFor(t,e,s){let i,n=s&&s.timeout||t.get("setting","status.options.waitForTimeout",t.get("setting","system.status.options.waitForTimeout",1e4)),r={waiter:s&&s.waiter?s.waiter:t,waitlist:Util.deepClone(e)};return StatusPerk.__isAllReady(r)?i=Promise.resolve():(i=new Promise(((s,i)=>{r.resolve=s,r.reject=i,r.timer=setTimeout((()=>{let s=t&&t.tagName||r.waiter&&r.waiter.tagName||"",a=t&&t.uniqueId||"";i(`StatusPerk._waitFor(): Timed out after ${n} milliseconds waiting for ${StatusPerk.__dumpWaitlist(e)}, name=${s}, uniqueId=${a}.`)}),n)})),r.promise=i,StatusPerk.__addToWaitingList(r)),i}static _suspend(t,e){}static _resume(t,e){}static _pause(t,e){}static __processWaitingList(){let t=[];Object.keys(StatusPerk._waitingList.items).forEach((e=>{StatusPerk.__isAllReady(StatusPerk._waitingList.get(e))&&(clearTimeout(StatusPerk._waitingList.get(e).timer),StatusPerk._waitingList.get(e).resolve(),t.push(e))}));for(let e=0;e<t.length;e++)StatusPerk._waitingList.remove(t[e])}static __addToWaitingList(t){let e=Util.getUUID();StatusPerk._waitingList.set(e,t)}static __isTransitionable(t,e){let s=!0;return t&&"ing"===t.slice(-3)&&("stopping"===t&&"stopped"!==e||"starting"===t&&"started"!==e)&&(s=!1),s}static __getUnitInfo(t,e){let s,i=t.use("skill","basic.locate",e);return i&&(s=BITSMIST.v1.BasicPerk._unitInfo[i.uniqueId]),s}static __isAllReady(t){let e=!0,s=t.waitlist;for(let i=0;i<s.length;i++){let n=!1,r=this.__getUnitInfo(t.waiter,s[i]);if(r&&StatusPerk.__isStatusMatch(r.status,s[i].status)&&(n=!0),!n){e=!1;break}}return e}static __isStatusMatch(t,e){e=e||"ready";let s=!1;switch(t){case"ready":"ready"!==e&&"started"!==e&&"starting"!==e||(s=!0);break;case"started":"started"!==e&&"starting"!==e||(s=!0);break;case"stopped":"stopped"!==e&&"stopping"!==e||(s=!0);break;default:t===e&&(s=!0)}return s}static __dumpWaitlist(t){let e="";for(let s=0;s<t.length;s++)if("string"==typeof t[s])e+=`\n\t{"${t[s]}", status:ready},`;else{e+=`\n\t{${t[s].id?`uniqueId:${t[s].uniqueId}, `:""}${t[s].id?`id:${t[s].id}, `:""}${t[s].tagName?`tagName:${t[s].tagName}, `:""}${t[s].object?`object:${t[s].object.tagName}, `:""}${t[s].selector?`selector:${t[s].selector}, `:""}${t[s].status?`status:${t[s].status}`:"status:ready"}},`}return`[${e}\n]`}static __createSuspendInfo(){let t={},e=new Promise(((e,s)=>{t.resolve=e,t.reject=s,t.status="pending"}));return t.promise=e,t}}class UnitPerk extends Perk{static get info(){return{section:"unit",order:400}}static globalInit(){UnitPerk._classInfo=BITSMIST.v1.BasicPerk._classInfo,this.upgrade(BITSMIST.v1.Unit,"spell","unit.materializeAll",(function(...t){return UnitPerk._loadTags(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","unit.materialize",(function(...t){return UnitPerk._loadUnit(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","unit.summon",(function(...t){return UnitPerk._loadClass(...t)}))}static init(t,e){this.upgrade(t,"inventory","unit.units",{}),this.upgrade(t,"event","doApplySettings",UnitPerk.UnitPerk_onDoApplySettings)}static UnitPerk_onDoApplySettings(t,e,s){let i=Promise.resolve();return Object.entries(Util.safeGet(e.detail,"settings.unit.units",{})).forEach((([t,e])=>{i=i.then((()=>{if(!this.get("inventory",`unit.units.${t}.object`)){let s=Util.safeGet(e,"unit.options.parentUnit");return(s?this.use("skill","basic.locate",s):this).use("spell","unit.materialize",t,e)}}))})),i}static _loadClass(t,e){let s=Util.safeGet(e,"unit.options.autoLoad");if(s&&!0!==s){e.system=e.system||{},e.system.appBaseURL="",e.system.unitPath="",e.system.skinPath="",e.unit=e.unit||{},e.unit.options=e.unit.options||{};let t=URLUtil.parseURL(s);e.unit.options.path=t.path,e.unit.options.fileName=t.filenameWithoutExtension,"html"===t.extension&&(e.unit.options.autoMorph=!e.unit.options.autoMorph||e.unit.options.autoMorph)}t=t.toLowerCase();let i=Util.safeGet(e,"unit.options.className",Util.getClassNameFromTagName(t)),n=Util.safeGet(e,"unit.options.autoMorph",i);n=!0===n?"BITSMIST.v1.Unit":n;let r=Promise.resolve();if(UnitPerk.__hasExternalClass(t,n,e))if(UnitPerk._classInfo[n]&&"loading"===UnitPerk._classInfo[n].status)r=UnitPerk._classInfo[n].promise;else{UnitPerk._classInfo[n]={status:"loading"};let s={splitClass:Util.safeGet(e,"unit.options.splitClass",BITSMIST.v1.Unit.get("setting","system.unit.options.splitClass",!1))};r=AjaxUtil.loadClass(UnitPerk.__getClassURL(t,e),s).then((()=>{UnitPerk._classInfo[n]={status:"loaded"}})),UnitPerk._classInfo[n].promise=r}return r.then((()=>{if(n!==i){let s=ClassUtil.getClass(n);ClassUtil.newUnit(i,e,s,t)}if(!customElements.get(t)){let e=ClassUtil.getClass(i);Util.assert(e,`UnitPerk_loadClass(): Class does not exists. tagName=${t}, className=${i}`),customElements.define(t,e)}}))}static _loadUnit(t,e,s,i){if(t.get("inventory",`unit.units.${e}.object`))return Promise.resolve(t.get("inventory",`unit.units.${e}.object`));let n,r=Util.safeGet(s,"unit.options.tag");if(r){let t=/([\w-]+)\s+\w+.*?>/;e=r.match(t)[1]}return Promise.resolve().then((()=>UnitPerk._loadClass(e,s))).then((()=>{n=UnitPerk.__insertTag(t,e,s),t.set("inventory",`unit.units.${e}.object`,n)})).then((()=>{let e=Util.safeGet(i,"syncOnAdd",Util.safeGet(s,"unit.options.syncOnAdd"));if(e){let s=!0===e?"ready":e;return t.use("spell","status.wait",[{uniqueId:n.uniqueId,status:s}])}})).then((()=>n))}static _loadTags(t,e,s){let i=[];return Util.scopedSelectorAll(e,"[bm-autoload]:not([bm-autoloading]):not([bm-powered]),[bm-automorph]:not([bm-autoloading]):not([bm-powered]),[bm-classref]:not([bm-autoloading]):not([bm-powered]),[bm-htmlref]:not([bm-autoloading]):not([bm-powered])").forEach((t=>{let e=this.__loadAttrSettings(t);t.setAttribute("bm-autoloading",""),t._injectSettings=function(t){return Util.deepMerge(t,e)},i.push(UnitPerk._loadClass(t.tagName,e).then((()=>{t.removeAttribute("bm-autoloading")})))})),Promise.all(i).then((()=>{if(Util.safeGet(s,"waitForTags"))return UnitPerk.__waitForChildren(e)}))}static __loadAttrSettings(t){let e={unit:{options:{}}};if(t.hasAttribute("bm-classname")&&(e.unit.options.className=t.getAttribute("bm-classname")),t.hasAttribute("bm-splitclass")){let t=unit.getAttribute("bm-splitclass")||!0;"false"===t&&(t=!1),e.unit.options.splitClass=t}return t.hasAttribute("bm-path")&&(e.unit.options.path=t.getAttribute("bm-path")),t.hasAttribute("bm-filename")&&(e.unit.options.fileName=t.getAttribute("bm-filename")),t.hasAttribute("bm-automorph")&&(e.unit.options.autoMorph=!t.getAttribute("bm-automorph")||t.getAttribute("bm-automorph")),t.hasAttribute("bm-htmlref")&&(e.unit.options.autoMorph=!t.getAttribute("bm-htmlref")||t.getAttribute("bm-htmlref")),t.hasAttribute("bm-autoload")&&(e.unit.options.autoLoad=!t.getAttribute("bm-autoload")||t.getAttribute("bm-autoload")),t.hasAttribute("bm-classref")&&(e.unit.options.autoLoad=!t.getAttribute("bm-classref")||t.getAttribute("bm-classref")),e}static __hasExternalClass(t,e,s){let i=!1;return(Util.safeGet(s,"unit.options.classRef")||Util.safeGet(s,"unit.options.htmlRef")||Util.safeGet(s,"unit.options.autoLoad")||Util.safeGet(s,"unit.options.autoMorph"))&&(i=!0,(customElements.get(t)||UnitPerk._classInfo[e]&&"loaded"===UnitPerk._classInfo[e].status||ClassUtil.getClass(e))&&(i=!1)),i}static __insertTag(t,e,s){let i,n;n=Util.safeGet(s,"unit.options.parentNode")?t.use("skill","basic.scan",Util.safeGet(s,"unit.options.parentNode")):t.unitRoot,Util.assert(n,`UnitPerk.__insertTag(): Root node does not exist. name=${t.tagName}, tagName=${e}, parentNode=${Util.safeGet(s,"unit.options.parentNode")}`,ReferenceError);let r=Util.safeGet(s,"unit.options.tag")?Util.safeGet(s,"unit.options.tag"):`<${e}></${e}>`;if(Util.safeGet(s,"unit.options.replaceParent"))n.outerHTML=r,i=n;else{let t=Util.safeGet(s,"unit.options.adjacentPosition","afterbegin");switch(n.insertAdjacentHTML(t,r),t){case"beforebegin":i=n.previousSibling;break;case"afterbegin":i=n.children[0];break;case"beforeend":i=n.lastChild;break;case"afterend":i=n.nextSibling}}return i._injectSettings=function(t){return Util.deepMerge(t,s)},i}static __waitForChildren(t){let e=[];return Util.scopedSelectorAll(t,"[bm-powered],[bm-autoloading]").forEach((s=>{if(t!=s.rootElement&&!s.hasAttribute("bm-nowait")){let t={object:s,status:"ready"};e.push(t)}})),StatusPerk.waitFor(e,{waiter:t})}static __getClassURL(t,e){let s=Util.concatPath([Util.safeGet(e,"system.unit.options.path",BITSMIST.v1.Unit.get("setting","system.unit.options.path","")),Util.safeGet(e,"unit.options.path","")]),i=Util.safeGet(e,"unit.options.fileName",t),n=Util.safeGet(e,"unit.options.query");return Util.concatPath([s,i])+(n?`?${n}`:"")}}class BasicPerk extends Perk{static get info(){return{section:"basic",order:0}}static globalInit(){BasicPerk._classInfo={},BasicPerk._unitInfo={},BasicPerk._indexes={tagName:{},className:{},id:{}},BITSMIST.v1.Unit.__bm_assets={},this.upgrade(BITSMIST.v1.Unit,"asset","state",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"asset","vault",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"asset","inventory",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"asset","skill",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"asset","spell",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"method","get",this._get),this.upgrade(BITSMIST.v1.Unit,"method","set",this._set),this.upgrade(BITSMIST.v1.Unit,"method","use",this._use),this.upgrade(BITSMIST.v1.Unit,"property","uniqueId",{get:()=>"00000000-0000-0000-0000-000000000000"}),this.upgrade(BITSMIST.v1.Unit,"property","tagName",{get:()=>"BODY"}),this.upgrade(BITSMIST.v1.Unit,"property","unitRoot",{get:()=>document.body}),this.upgrade(BITSMIST.v1.Unit,"spell","basic.start",(function(...t){return BasicPerk._start(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.stop",(function(...t){return BasicPerk._stop(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.transform",(function(...t){return BasicPerk._transform(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.setup",(function(...t){return BasicPerk._setup(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.refresh",(function(...t){return BasicPerk._refresh(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.fetch",(function(...t){return BasicPerk._fetch(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.fill",(function(...t){return BasicPerk._fill(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","basic.clear",(function(...t){return BasicPerk._clear(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","basic.scan",(function(...t){return BasicPerk._scan(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","basic.scanAll",(function(...t){return BasicPerk._scanAll(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","basic.locate",(function(...t){return BasicPerk._locate(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","basic.locateAll",(function(...t){return BasicPerk._locateAll(...t)})),this.upgrade(BITSMIST.v1.Unit.prototype,"method","_connectedHandler",this._connectedHandler),this.upgrade(BITSMIST.v1.Unit.prototype,"method","_disconnectedHandler",this._disconnectedHandler),this.upgrade(BITSMIST.v1.Unit.prototype,"method","_adoptedHandler",this._connectedHandler),this.upgrade(BITSMIST.v1.Unit.prototype,"method","_attributeChangedHandler",this._attributeChangedHandler),this.upgrade(BITSMIST.v1.Unit.prototype,"method","get",this._get),this.upgrade(BITSMIST.v1.Unit.prototype,"method","set",this._set),this.upgrade(BITSMIST.v1.Unit.prototype,"method","has",this._has),this.upgrade(BITSMIST.v1.Unit.prototype,"method","use",this._use),this.upgrade(BITSMIST.v1.Unit.prototype,"property","uniqueId",{get(){return this.__bm_uniqueid}}),this.upgrade(BITSMIST.v1.Unit.prototype,"property","unitRoot",{get(){return this.__bm_unitroot},set(t){this.__bm_unitroot=t}}),BITSMIST.v1.Unit.set("inventory","promise.documentReady",new Promise(((t,e)=>{"interactive"===document.readyState||"complete"===document.readyState?t():document.addEventListener("DOMContentLoaded",(()=>{t()}))}))),BITSMIST.v1.Unit.get("inventory","promise.documentReady").then((()=>{BITSMIST.v1.Unit.get("setting","system.unit.options.autoLoadOnStartup",!0)&&BITSMIST.v1.UnitPerk._loadTags(null,document.body,{waitForTags:!1})}))}static _connectedHandler(t){this.__bm_uniqueid||(this.__bm_initialized=!1,this.__bm_ready=Promise.resolve(),this.__bm_uniqueid=Util.getUUID(),this.__bm_unitroot=this,this.setAttribute("bm-powered",""),BasicPerk._register(this)),this.__bm_ready=this.__bm_ready.then((()=>{if(!this.__bm_initialized||this.get("setting","basic.options.autoRestart",!1))return this.__bm_initialized=!0,t.__bm_assets={},Perk.upgrade(t,"asset","state",new ChainableStore({chain:BITSMIST.v1.Unit.__bm_assets.state})),Perk.upgrade(t,"asset","vault",new ChainableStore),Perk.upgrade(t,"asset","inventory",new ChainableStore({chain:BITSMIST.v1.Unit.__bm_assets.inventory})),Perk.upgrade(t,"asset","skill",new ChainableStore({chain:BITSMIST.v1.Unit.__bm_assets.skill})),Perk.upgrade(t,"asset","spell",new ChainableStore({chain:BITSMIST.v1.Unit.__bm_assets.spell})),Promise.resolve().then((()=>this.use("spell","perk.attach",BITSMIST.v1.BasicPerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.SettingPerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.PerkPerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.StatusPerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.EventPerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.SkinPerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.StylePerk))).then((()=>this.use("spell","perk.attach",BITSMIST.v1.UnitPerk))).then((()=>this.use("spell","basic.start")))}))}static _disconnectedHandler(t){this.__bm_ready=this.__bm_ready.then((()=>this.use("spell","basic.stop"))).then((()=>{}))}static _adoptedHandler(t){return t.use("spell","event.trigger","afterAdopt")}static _attributeChangedHandler(t,e,s,i){if(this.__bm_initialized)return t.use("spell","event.trigger","afterAttributeChange",{name:e,oldValue:s,newValue:i})}static _get(t,e,...s){return this.__bm_assets[t].get(e,...s)}static _set(t,e,s){this.__bm_assets[t].set(e,s)}static _has(t,e){this.__bm_assets[t].has(e)}static _use(t,e,...s){let i=this.__bm_assets[t].get(e);return Util.assert("function"==typeof i,`${t} is not available. ${t}Name=${e}`),i.call(this,this,...s)}static _start(t,e){return Promise.resolve().then((()=>t.use("spell","setting.apply",{settings:t.__bm_assets.setting.items}))).then((()=>t.use("spell","event.trigger","beforeStart"))).then((()=>t.use("skill","status.change","starting"))).then((()=>{if(t.get("setting","basic.options.autoTransform",!0))return t.use("spell","basic.transform")})).then((()=>t.use("spell","event.trigger","doStart"))).then((()=>{if(t.get("setting","basic.options.autoRefresh",!0))return t.use("spell","basic.refresh")})).then((()=>t.use("skill","status.change","started"))).then((()=>t.use("spell","event.trigger","afterStart"))).then((()=>t.use("skill","status.change","ready"))).then((()=>t.use("spell","event.trigger","afterReady")))}static _stop(t,e){return e=e||{},Promise.resolve().then((()=>t.use("skill","status.change","stopping"))).then((()=>t.use("spell","event.trigger","beforeStop",e))).then((()=>t.use("spell","event.trigger","doStop",e))).then((()=>t.use("skill","status.change","stopped"))).then((()=>t.use("spell","event.trigger","afterStop",e)))}static _transform(t,e){return e=e||{},Promise.resolve().then((()=>t.use("spell","event.trigger","beforeTransform",e))).then((()=>{if(t.get("setting","basic.options.autoSetup",!0))return t.use("spell","basic.setup",e)})).then((()=>t.use("spell","event.trigger","doTransform",e))).then((()=>t.use("spell","unit.materializeAll",t))).then((()=>t.use("spell","event.trigger","afterTransform",e)))}static _setup(t,e){return e=e||{},Promise.resolve().then((()=>t.use("spell","event.trigger","beforeSetup",e))).then((()=>t.use("spell","event.trigger","doSetup",e))).then((()=>t.use("spell","event.trigger","afterSetup",e)))}static _refresh(t,e){return e=e||{},Promise.resolve().then((()=>t.use("spell","event.trigger","beforeRefresh",e))).then((()=>{if(Util.safeGet(e,"autoClear",t.get("setting","basic.options.autoClear",!0)))return t.use("spell","basic.clear",e)})).then((()=>{if(Util.safeGet(e,"autoFetch",t.get("setting","basic.options.autoFetch",!0)))return t.use("spell","basic.fetch",e)})).then((()=>{if(Util.safeGet(e,"autoFill",t.get("setting","basic.options.autoFill",!0)))return t.use("spell","basic.fill",e)})).then((()=>t.use("spell","event.trigger","doRefresh",e))).then((()=>t.use("spell","event.trigger","afterRefresh",e)))}static _fetch(t,e){return e=e||{},Promise.resolve().then((()=>t.use("spell","event.trigger","beforeFetch",e))).then((()=>t.use("spell","event.trigger","doFetch",e))).then((()=>t.use("spell","event.trigger","afterFetch",e))).then((()=>{}))}static _fill(t,e){return e=e||{},Promise.resolve().then((()=>t.use("spell","event.trigger","beforeFill",e))).then((()=>t.use("spell","event.trigger","doFill",e))).then((()=>t.use("spell","event.trigger","afterFill",e)))}static _clear(t,e){return e=e||{},Promise.resolve().then((()=>t.use("spell","event.trigger","beforeClear",e))).then((()=>t.use("spell","event.trigger","doClear",e))).then((()=>t.use("spell","event.trigger","afterClear",e)))}static _scanAll(t,e,s){return Util.scopedSelectorAll(t,e,s)}static _scan(t,e,s){let i=Util.scopedSelectorAll(t,e,s);return i?i[0]:null}static _register(t,e){let s=customElements.get(t.tagName.toLowerCase());BasicPerk._unitInfo[t.uniqueId]={object:t,class:s,classInfo:BasicPerk._classInfo[s.name]},BasicPerk._indexes.tagName[t.tagName]=BasicPerk._indexes.tagName[t.tagName]||[],BasicPerk._indexes.tagName[t.tagName].push(t),BasicPerk._indexes.className[s.name]=BasicPerk._indexes.className[s.name]||[],BasicPerk._indexes.className[s.name].push(t),t.id&&(BasicPerk._indexes.id[t.id]=BasicPerk._indexes.id[t.id]||[],BasicPerk._indexes.id[t.id].push(t))}static _locateAll(t,e){return"object"!=typeof e?"string"==typeof e?BasicPerk._indexes.tagName[e.toUpperCase()]:[e]:"selector"in e?document.querySelectorAll(e.selector):"scan"in e?(t.use("skill","basic.scan",e.scan),t.use("skill","basic.scanAll",e.scan)):"uniqueId"in e?[BasicPerk._unitInfo[e.uniqueId].object]:"tagName"in e?BasicPerk._indexes.tagName[e.tagName.toUpperCase()]:"object"in e?[e.object]:"id"in e?BasicPerk._indexes.id[e.id]:"className"in e?BasicPerk._indexes.className[e.className]:void 0}static _locate(t,e){let s=BasicPerk._locateAll(t,e);if(s)return s[0]}}class PerkPerk extends Perk{static get info(){return{section:"perk",order:0}}static globalInit(){this.upgrade(BITSMIST.v1.Unit,"spell","perk.attachPerks",(function(...t){return PerkPerk._attachPerks(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","perk.attach",(function(...t){return PerkPerk._attach(...t)}))}static init(t,e){this.upgrade(t,"inventory","perk.perks.PerkPerk",{object:this})}static register(t){let e=t.info;e.section=e.section,e.order="order"in e?e.order:500,e.depends=e.depends||[],e.depends=Array.isArray(e.depends)?e.depends:[e.depends],this._perks[t.name]={name:t.name,object:t,section:e.section,order:e.order,depends:e.depends},t.globalInit(),PerkPerk._sections[e.section]=this._perks[t.name]}static _attachPerks(t,e){let s=e.settings,i=Promise.resolve(),n=PerkPerk.__listNewPerks(t,s);return PerkPerk.__sortItems(n).forEach((s=>{i=i.then((()=>PerkPerk._attach(t,this._perks[s].object,e)))})),i}static _attach(t,e,s){if(!t.get("inventory",`perk.perks.${e.name}`)){let i=this._perks[e.name].depends;for(let e=0;e<i.length;e++)PerkPerk._attach(t,this._perks[i[e]].object,s);return t.set("inventory",`perk.perks.${e.name}`,{object:e}),e.init(t,s)}}static __listNewPerks(t,e){let s={};Promise.resolve();let i=Util.safeGet(e,"perk.options.apply");if(i)for(let e=0;e<i.length;e++){let n=i[e];Util.assert(this._perks[n],`PerkPerk.__listNewPerk(): Perk not found. name=${t.tagName}, perkName=${n}`),t.get("inventory",`perk.perks.${n}`)||(s[n]=this._perks[n])}return Object.keys(e).forEach((e=>{let i=PerkPerk._sections[e];i&&!t.get("inventory",`perk.perks.${i.name}`)&&(s[i.name]=i)})),s}static __sortItems(t){return Object.keys(t).sort(((e,s)=>t[e].order-t[s].order))}}PerkPerk._perks={},PerkPerk._sections={};class SettingPerk extends Perk{static get info(){return{section:"setting",order:10}}static globalInit(){this.upgrade(BITSMIST.v1.Unit,"asset","setting",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"skill","setting.get",(function(...t){return SettingPerk._getSettings(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","setting.set",(function(...t){return SettingPerk._setSettings(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","setting.merge",(function(...t){return SettingPerk._mergeSettings(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","setting.summon",(function(...t){return SettingPerk._loadSettings(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","setting.apply",(function(...t){return SettingPerk._applySettings(...t)}))}static init(t,e){let s=e&&e.settings||{};return s=SettingPerk.__injectSettings(t,s),s=SettingPerk.__mergeSettings(t,s),this.upgrade(t,"asset","setting",new ChainableStore({items:s,chain:BITSMIST.v1.Unit.__bm_assets.setting})),Promise.resolve().then((()=>{SettingPerk.__loadAttrSettings(t)})).then((()=>{if(SettingPerk.__hasExternalSettings(t))return SettingPerk._loadSettings(t)})).then((()=>{SettingPerk.__loadAttrSettings(t)}))}static _applySettings(t,e){return Promise.resolve().then((()=>t.use("spell","event.trigger","beforeApplySettings",e))).then((()=>t.use("spell","perk.attachPerks",e))).then((()=>t.use("spell","event.trigger","doApplySettings",e))).then((()=>t.use("spell","event.trigger","afterApplySettings",e)))}static _loadSettings(t,e){return AjaxUtil.loadJSON(SettingPerk.__getSettingsURL(t),Object.assign({bindTo:t},e)).then((e=>{e&&t.use("skill","setting.merge",e)}))}static _getSettings(t,e,s){return t.get("setting",e,s)}static _setSettings(t,e,s){return t.set("setting",e,s)}static _mergeSettings(t,e,s){return t.__bm_assets.setting.merge(e,s)}static __loadAttrSettings(t){if(t.hasAttribute("bm-settingsref")){let e=t.getAttribute("bm-settingsref")||!0;"false"===e&&(e=!1),t.set("setting","setting.options.settingsRef",e)}if(t.hasAttribute("bm-options")){let e={options:JSON.parse(t.getAttribute("bm-options"))};t.use("skill","setting.merge",e)}}static __hasExternalSettings(t){let e=!1;return t.get("setting","setting.options.settingsRef")&&(e=!0),e}static __getSettingsURL(t){let e,s,i,n=t.get("setting","setting.options.settingsRef");if(n&&!0!==n){let t=URLUtil.parseURL(n);e=t.path,s=t.filename,i=t.query}else{e=Util.concatPath([t.get("setting","system.unit.options.path"),t.get("setting","unit.options.path","")]);let n=t.get("setting","setting.options.settingFormat",t.get("setting","system.setting.options.settingFormat","json"));s=t.get("setting","unit.options.fileName",t.tagName.toLowerCase())+".settings."+n,i=t.get("setting","unit.options.query")}return Util.concatPath([e,s])+(i?`?${i}`:"")}static __injectSettings(t,e){return"function"==typeof t._injectSettings&&(e=t._injectSettings.call(t,e)),e}static _getSettings(t){return{}}static __mergeSettings(t,e){let s,i=Object.getPrototypeOf(t),n={};for(;"function"==typeof Object.getPrototypeOf(i)._getSettings;)s=Object.getPrototypeOf(i)._getSettings.call(t),Object.keys(s).length>0&&(Util.deepMerge(s,n),n=s),i=Object.getPrototypeOf(i);return Util.deepMerge(e,n),Util.deepMerge(e,t._getSettings.call(t)),e}}class SkinPerk extends Perk{static get info(){return{section:"skin",order:210}}static globalInit(){this.upgrade(BITSMIST.v1.Unit,"skill","skin.apply",(function(...t){return SkinPerk._applySkin(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","skin.clone",(function(...t){return SkinPerk._cloneSkin(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","skin.summon",(function(...t){return SkinPerk._loadSkin(...t)}))}static init(t,e){switch(this.upgrade(t,"inventory","skin.skins",{}),this.upgrade(t,"state","skin.active.skinName",""),this.upgrade(t,"event","beforeTransform",SkinPerk.SkinPerk_onBeforeTransform),this.upgrade(t,"event","doTransform",SkinPerk.SkinPerk_onDoTransform),SkinPerk.__loadAttrSettings(t),t.get("setting","skin.options.shadowDOM",t.get("setting","system.skin.options.shadowDOM"))){case"open":t.set("state","skin.shadowRoot",t.attachShadow({mode:"open"}));break;case"closed":t.set("state","skin.shadowRoot",t.attachShadow({mode:"closed"}))}t.unitRoot=t.get("state","skin.shadowRoot",t)}static SkinPerk_onBeforeTransform(t,e,s){if(e.detail.skinName||SkinPerk.__hasDefaultSkin(this)){let t=e.detail.skinName||"default";return SkinPerk._loadSkin(this,t).then((t=>{this.unitRoot.textContent="",this.unitRoot=t.template.content.cloneNode(!0)}))}}static SkinPerk_onDoTransform(t,e,s){if(e.detail.skinName||SkinPerk.__hasDefaultSkin(this)){let t=e.detail.skinName||"default";return SkinPerk._applySkin(this,t,this.unitRoot)}}static _loadSkin(t,e,s){let i=Promise.resolve(),n=t.get("inventory",`skin.skins.${e}`)||SkinPerk.__createSkinInfo(t,e),r=s||t.get("setting",`skin.skins.${e}`,{});if("loaded"===n.status)return i.then((()=>n));switch(r.type){case"HTML":n.HTML=r.HTML,n.template=document.createElement("template"),n.template.innerHTML=n.HTML,n.status="loaded",t.set("inventory",`skin.skins.${e}`,n);break;case"node":let s=t.use("skill","basic.scan",r.rootNode||"");Util.assert(s,`SkinPerk._loadSkin(): Root node does not exist. name=${t.tagName}, skinName=${e}, rootNode=${r.rootNode}`),n.HTML=s.innerHTML,n.template=document.createElement("template"),n.template.innerHTML=n.HTML,n.status="loaded",t.set("inventory",`skin.skins.${e}`,n);break;default:let a=r.URL||"default"===e&&SkinPerk.__getSkinURL(t);Util.assert(a,`SkinPerk._loadSkin(): Skin URL is not speicified. name=${t.tagName}, skinName=${e}`),i=AjaxUtil.loadHTML(a).then((s=>{n.HTML=s,n.template=document.createElement("template"),n.template.innerHTML=n.HTML,n.status="loaded",t.set("inventory",`skin.skins.${e}`,n)}))}return i.then((()=>n))}static _applySkin(t,e,s){let i=t.get("inventory",`skin.skins.${e}`);Util.assert(i,`SkinPerk._applySkin(): Skin not loaded. name=${t.tagName}, skinName=${e}, id=${t.id}, uniqueId=${t.uniqueId}`,ReferenceError),s=s||i.template.content.cloneNode(!0),t.unitRoot=t.get("state","skin.shadowRoot",t),t.unitRoot.innerHTML="",t.unitRoot.appendChild(s),t.set("state","skin.active.skinName",e)}static __loadAttrSettings(t){if(t.hasAttribute("bm-skinref")){let e=t.getAttribute("bm-styleref")||!0;"false"===e&&(e=!1),t.set("setting","skin.options.skinRef",e)}}static __createSkinInfo(t,e){return{name:e,HTML:"",template:null,status:""}}static __hasDefaultSkin(t){let e=!1;return t.get("setting","skin.options.skinRef",!0)&&(e=!0),e}static __getSkinURL(t){let e,s,i,n=t.get("setting","skin.options.skinRef");if(n&&!0!==n){let t=URLUtil.parseURL(n);e=t.path,s=t.filename,i=t.query}else e=Util.concatPath([t.get("setting","system.skin.options.path",t.get("setting","system.unit.options.path","")),t.get("setting","style.options.path",t.get("setting","unit.options.path",""))]),s=SkinPerk.__getDefaultFilename(t)+".html",i=t.get("setting","unit.options.query");return Util.concatPath([e,s])+(i?`?${i}`:"")}static __getDefaultFilename(t){return t.get("setting","skin.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase()))}}class StylePerk extends Perk{static get info(){return{section:"style",order:200}}static globalInit(){this.upgrade(BITSMIST.v1.Unit,"vault","style.applied",[]),this.upgrade(BITSMIST.v1.Unit,"inventory","style.styles",new ChainableStore),this.upgrade(BITSMIST.v1.Unit,"spell","style.summon",(function(...t){return StylePerk._loadCSS(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","style.apply",(function(...t){return StylePerk._applyCSS(...t)})),this._cssReady={},this._cssReady.promise=new Promise(((t,e)=>{this._cssReady.resolve=t,this._cssReady.reject=e})),Promise.resolve(),BITSMIST.v1.Unit.get("inventory","promise.documentReady").then((()=>{let t=[];Object.entries(BITSMIST.v1.Unit.get("setting","system.style.styles",{})).forEach((([e,s])=>{t.push(StylePerk._loadCSS(BITSMIST.v1.Unit,e,s))})),Promise.all(t).then((()=>{let t=Promise.resolve(),e=BITSMIST.v1.Unit.get("setting","system.style.options.apply",[]);for(let s=0;s<e.length;s++)t=t.then((()=>StylePerk._applyCSS(BITSMIST.v1.Unit,e[s])));return t.then((()=>{this._cssReady.resolve()}))}))}))}static init(t,e){this.upgrade(t,"vault","style.applied",[]),this.upgrade(t,"inventory","style.styles",new ChainableStore({chain:BITSMIST.v1.Unit.get("inventory","style.styles")})),this.upgrade(t,"event","doTransform",StylePerk.StylePerk_onDoTransform),StylePerk.__loadAttrSettings(t)}static StylePerk_onDoTransform(t,e,s){return StylePerk._cssReady.promise.then((()=>{let t=this.get("setting","style.options.apply",[]);if(e.detail.styleName||StylePerk.__hasDefaultCSS(this)){let s=e.detail.styleName||"default";t=t.concat(this.get("setting",`style.styles.${s}.apply`,[])),t.push(s)}let s=[];for(let e=0;e<t.length;e++)s.push(StylePerk._loadCSS(this,t[e]));return Promise.all(s).then((()=>{StylePerk._clearCSS(this);let e=Promise.resolve();for(let s=0;s<t.length;s++)e=e.then((()=>StylePerk._applyCSS(this,t[s])));return e}))}))}static _loadCSS(t,e,s){let i=Promise.resolve(),n=t.get("inventory","style.styles").get(e)||StylePerk.__createStyleInfo(t,e),r=s||t.get("setting",`style.styles.${e}`,{});if("loaded"===n.status)return i.then((()=>n));if("CSS"===r.type)n.CSS=r.CSS,n.status="loaded",t.get("inventory","style.styles").set(e,n);else if("loading"===n.status)i=n.promise;else{let s=r.URL||"default"===e&&StylePerk.__getCSSURL(t);Util.assert(s,`StylePerk._loadCSS(): CSS URL is not speicified. name=${t.tagName}, styleName=${e}`),i=AjaxUtil.loadCSS(s).then((s=>{let i=t.get("inventory","style.styles").get(e);i.CSS=s,i.status="loaded",t.get("inventory","style.styles").set(e,i)})),n.promise=i,n.status="loading",t.get("inventory","style.styles").set(e,n)}return i.then((()=>n))}static _applyCSS(t,e){let s=t.get("inventory","style.styles").get(e),i=new CSSStyleSheet;return Util.assert(s,`StylePerk._applyCSS(): CSS not loaded. name=${t.tagName||"Global"}, styleName=${e}, id=${t.id}, uniqueId=${t.uniqueId}`,ReferenceError),Promise.resolve().then((()=>i.replace(`${s.CSS}`))).then((()=>{let s=t.get("state","skin.shadowRoot");if(s)s.adoptedStyleSheets=[...s.adoptedStyleSheets,i];else{!((e=t.tagName+"."+e)in StylePerk.__applied)||StylePerk.__applied[e].count<=0?(StylePerk.__applied[e]=StylePerk.__applied[e]||{},document.adoptedStyleSheets=[...document.adoptedStyleSheets,i],StylePerk.__applied[e].object=i,StylePerk.__applied[e].count=1):StylePerk.__applied[e].count++;let s=t.get("vault","style.applied");s.push(e),t.set("vault","style.applied",s)}}))}static _clearCSS(t){let e=t.get("state","skin.shadowRoot");if(e)e.adoptedStyleSheets=[];else{let e=t.get("vault","style.applied");if(e.length>0){for(let t=0;t<e.length;t++)StylePerk.__applied[e[t]].count--;t.set("vault","style.applied",[]),document.adoptedStyleSheets=[],Object.keys(StylePerk.__applied).forEach((t=>{StylePerk.__applied[t].count>0&&(document.adoptedStyleSheets=[...document.adoptedStyleSheets,StylePerk.__applied[t].object])}))}}}static __loadAttrSettings(t){if(t.hasAttribute("bm-styleref")){let e=t.getAttribute("bm-styleref")||!0;"false"===e&&(e=!1),t.set("setting","style.options.styleRef",e)}}static __createStyleInfo(t,e){return{name:e,CSS:"",status:""}}static __hasDefaultCSS(t){let e=!1;return t.get("setting","style.options.styleRef",!0)&&(e=!0),e}static __getCSSURL(t){let e,s,i,n=t.get("setting","style.options.styleRef");if(n&&!0!==n){let t=URLUtil.parseURL(n);e=t.path,s=t.filename,i=t.query}else e=Util.concatPath([t.get("setting","system.style.options.path",t.get("setting","system.unit.options.path","")),t.get("setting","skin.options.path",t.get("setting","unit.options.path",""))]),s=StylePerk.__getDefaultFilename(t)+".css",i=t.get("setting","unit.options.query");return Util.concatPath([e,s])+(i?`?${i}`:"")}static __getDefaultFilename(t){return t.get("setting","style.options.fileName",t.get("setting","unit.options.fileName",t.tagName.toLowerCase()))}}StylePerk.__applied={};class EventPerk extends Perk{static get info(){return{section:"event",order:210}}static globalInit(){this.upgrade(BITSMIST.v1.Unit,"skill","event.add",(function(...t){return EventPerk._addEventHandler(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","event.remove",(function(...t){return EventPerk._removeEventHandler(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","event.init",(function(...t){return EventPerk._initEvents(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","event.reset",(function(...t){return EventPerk._removeEvents(...t)})),this.upgrade(BITSMIST.v1.Unit,"spell","event.trigger",(function(...t){return EventPerk._trigger(...t)})),this.upgrade(BITSMIST.v1.Unit,"skill","event.triggerSync",(function(...t){return EventPerk._triggerSync(...t)}))}static init(t,e){this.upgrade(t,"event","doApplySettings",EventPerk.EventPerk_onDoApplySettings),this.upgrade(t,"event","afterTransform",EventPerk.EventPerk_onAfterTransform)}static deinit(t,e){let s=this.get("setting","event");s&&Object.keys(s).forEach((e=>{EventPerk._removeEvents(t,e,s[eventName])}))}static EventPerk_onDoApplySettings(t,e,s){Object.entries(Util.safeGet(e.detail,"settings.event.events",{})).forEach((([t,e])=>{EventPerk._initEvents(this,t,e)}))}static EventPerk_onAfterTransform(t,e,s){Object.entries(this.get("setting","event.events",{})).forEach((([t,e])=>{EventPerk.__isTargetSelf(t,e)||EventPerk._initEvents(this,t,e)}))}static _addEventHandler(t,e,s,i,n){i=i||t;let r="object"==typeof s?s:{},a=EventPerk.__getEventHandler(t,s);Util.assert(a,`EventPerk._addEventHandler(): handler not found. name=${t.tagName}, eventName=${e}`),i.__bm_eventinfo||(i.__bm_eventinfo={unit:t,listeners:{},promises:{},statuses:{}});let l=i.__bm_eventinfo.listeners;l[e]||(l[e]=[],i.addEventListener(e,EventPerk.__callEventHandler,r.listnerOptions));let o=Util.safeGet(r,"order",1e3);l[e].push({handler:a,options:r.options,bindTo:n,order:o}),l[e].sort(((t,e)=>t.order===e.order?0:t.order>e.order?1:-1))}static _removeEventHandler(t,e,s,i){i=i||t;let n=EventPerk.__getEventHandler(t,s);Util.assert(n,`EventPerk._removeEventHandler(): handler not found. name=${t.tagName}, eventName=${e}`);let r=Util.safeGet(i,`__bm_eventinfo.listeners.${e}`);if(r)for(let t=r.length-1;t>=0;t--)if(r[t].handler===n){r.splice(t,1);break}}static _initEvents(t,e,s,i){s=s||t.get("setting",`event.events.${e}`);let n=EventPerk.__getTargetElements(t,i,e,s);Object.keys(s.handlers).forEach((e=>{let i=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<i.length;s++)for(let r=0;r<n.length;r++)EventPerk._addEventHandler(t,e,i[s],n[r])}))}static _removeEvents(t,e,s,i){s=s||t.get("setting",`event.events.${e}`);let n=EventPerk.__getTargetElements(t,i,e,s);Object.keys(s.handlers).forEach((e=>{let i=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<i.length;s++)for(let r=0;r<n.length;r++)t.removeEventHandler(e,i[s],n[r])}))}static _trigger(t,e,s,i){return s=s||{},(i=i||t).dispatchEvent(new CustomEvent(e,{detail:s})),Util.safeGet(i,`__bm_eventinfo.promises.${e}`)||Promise.resolve()}static _triggerSync(t,e,s,i){return(s=s||{}).async=!0,EventPerk._trigger.call(t,t,e,s,i)}static __getEventHandler(t,e){return"object"==typeof e?e.handler:e}static __isTargetSelf(t,e){let s=!1;return("this"===t||e&&"this"===e.rootNode)&&(s=!0),s}static __getTargetElements(t,e,s,i){let n;return e=e||t,n=EventPerk.__isTargetSelf(s,i)?[e]:i&&i.rootNode?Util.scopedSelectorAll(e,i.rootNode):Util.scopedSelectorAll(e,`#${s}`),n}static __isHandlerInstalled(t,e,s){let i=!1,n=Util.safeGet(t.__bm_eventinfo,`listeners.${e}`);if(n)for(let t=0;t<n.length;t++)if(n[t].handler===s){i=!0;break}return i}static __callEventHandler(t){let e=Util.safeGet(this,`__bm_eventinfo.listeners.${t.type}`),s=Util.safeGet(t,"detail.sender",this),i=Util.safeGet(this,"__bm_eventinfo.unit"),n=`__bm_eventinfo.statuses.${t.type}`,r=`__bm_eventinfo.promises.${t.type}`;if(Util.safeSet(this,n,"handling"),!1===Util.safeGet(t,"detail.async",!1))this.__bm_eventinfo.promises[t.type]=EventPerk.__handle(t,s,i,e).then((()=>{Util.safeSet(this,r,null),Util.safeSet(this,n,"")})).catch((t=>{throw Util.safeSet(this,r,null),Util.safeSet(this,n,""),t}));else try{this.__bm_eventinfo.promises[t.type]=EventPerk.__handleSync(t,s,i,e),Util.safeSet(this,r,null),Util.safeSet(this,n,"")}catch(t){throw Util.safeSet(this,r,null),Util.safeSet(this,n,""),t}}static __handle(t,e,s,i){let n=Promise.resolve(),r=!1;for(let a=0;a<i.length;a++){let l={unit:s,options:i[a].options?i[a].options:{}};n=n.then((()=>{let n=i[a].handler;n="string"==typeof n?s[n]:n,Util.assert("function"==typeof n,`EventPerk._addEventHandler(): Event handler is not a function. name=${s.tagName}, eventName=${t.type}`,TypeError);let r=i[a].bindTo?i[a].bindTo:s;return n.call(r,e,t,l)})),r=!(!i[a].options||!i[a].options.stopPropagation)||r}return r&&t.stopPropagation(),n}static __handleSync(t,e,s,i){let n=!1;for(let r=0;r<i.length;r++){let a={unit:s,options:i[r].options?i[r].options:{}},l=i[r].handler;l="string"==typeof l?s[l]:l,Util.assert("function"==typeof l,`EventPerk._addEventHandler(): Event handler is not a function. name=${s.tagName}, eventName=${t.type}`,TypeError);let o=i[r].bindTo?i[r].bindTo:s;l.call(o,e,t,a),n=!(!i[r].options||!i[r].options.stopPropagation)||n}return n&&t.stopPropagation(),Promise.resolve()}}window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},window.BITSMIST.v1.Util=Util,window.BITSMIST.v1.ClassUtil=ClassUtil,window.BITSMIST.v1.AjaxUtil=AjaxUtil,window.BITSMIST.v1.URLUtil=URLUtil,window.BITSMIST.v1.Store=Store,window.BITSMIST.v1.ChainableStore=ChainableStore,window.BITSMIST.v1.Unit=Unit,window.BITSMIST.v1.Perk=Perk,window.BITSMIST.v1.BasicPerk=BasicPerk,PerkPerk.register(BasicPerk),window.BITSMIST.v1.PerkPerk=PerkPerk,PerkPerk.register(PerkPerk),window.BITSMIST.v1.SettingPerk=SettingPerk,PerkPerk.register(SettingPerk),window.BITSMIST.v1.StatusPerk=StatusPerk,PerkPerk.register(StatusPerk),window.BITSMIST.v1.SkinPerk=SkinPerk,PerkPerk.register(SkinPerk),window.BITSMIST.v1.StylePerk=StylePerk,PerkPerk.register(StylePerk),window.BITSMIST.v1.EventPerk=EventPerk,PerkPerk.register(EventPerk),window.BITSMIST.v1.UnitPerk=UnitPerk,PerkPerk.register(UnitPerk)}();
