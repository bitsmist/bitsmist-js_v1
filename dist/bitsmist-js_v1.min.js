!function(){"use strict";class t{static safeGet(t,e,s){let n=t,r=!0,a=e.split(".");for(let t=0;t<a.length;t++){if(!n||"object"!=typeof n||!(a[t]in n)){r=!1;break}n=n[a[t]]}return r?n:s}static safeSet(e,s,n){let r=e,a=s.split(".");for(let e=0;e<a.length-1;e++)t.assert(r&&"object"==typeof r,`Util.safeSet(): Key already exists. key=${s}, existingKey=${e>0?a[e-1]:""}, existingValue=${r}`,TypeError),a[e]in r||(r[a[e]]={}),r=r[a[e]];return r[a[a.length-1]]=n,e}static safeMerge(e,s,n){let r=e,a=s.split(".");for(let e=0;e<a.length-1;e++)t.assert(r&&"object"==typeof r,`Util.safeSet(): Key already exists. key=${s}, existingKey=${e>0?a[e-1]:""}, existingValue=${r}`,TypeError),a[e]in r||(r[a[e]]={}),r=r[a[e]];let i=a[a.length-1];return r[i]&&"object"==typeof r[i]&&n&&"object"==typeof n?t.deepMerge(r[i],n):r[i]=n,e}static safeHas(t,e){let s=t,n=!0,r=e.split(".");for(let t=0;t<r.length;t++){if(!s||"object"!=typeof s||!(r[t]in s)){n=!1;break}s=s[r[t]]}return n}static safeEval(t,e,s){let n,r=[];s&&(n=Object.keys(s).join(","),Object.keys(s).forEach((t=>{r.push(s[t])})));let a=!1;try{a=Function(n,'"use strict";return ('+t+")").apply(e,r)}catch(t){}return a}static concatPath(t){let e=t[0]||"";for(let s=1;s<t.length;s++)t[s]&&("/"===e.slice(e.length-1)&&"/"===t[s].slice(0,1)?e+=t[s].slice(1):"/"===e.slice(e.length-1)||"/"===t[s].slice(0,1)?e+=t[s]:e?e+="/"+t[s]:e=t[s]);return e}static deepMerge(e,s){return t.assert(e&&"object"==typeof e&&s&&"object"==typeof s,'Util.deepMerge(): "obj1" and "obj2" parameters must be an object.',TypeError),Object.keys(s).forEach((n=>{Array.isArray(e[n])?e[n]=e[n].concat(s[n]):!(e.hasOwnProperty(n)&&e[n]&&"object"==typeof e[n]&&s[n]&&"object"==typeof s[n])||e[n]instanceof HTMLElement||s[n]instanceof HTMLElement?e[n]=s[n]:t.deepMerge(e[n],s[n])})),e}static deepClone(e,s){return t.assert(e&&"object"==typeof e&&s&&"object"==typeof s,'Util.deepMerge(): "obj1" and "obj2" parameters must be an object.',TypeError),Object.keys(s).forEach((n=>{Array.isArray(e[n])?e[n]=e[n].concat(s[n]):!(e.hasOwnProperty(n)&&e[n]&&"object"==typeof e[n]&&s[n]&&"object"==typeof s[n])||e[n]instanceof HTMLElement||s[n]instanceof HTMLElement?Array.isArray(s[n])?e[n]=t.deepCloneArray(s[n]):!s[n]||"object"!=typeof s[n]||s[n]instanceof HTMLElement?e[n]=s[n]:(e[n]={},t.deepClone(e[n],s[n])):t.deepClone(e[n],s[n])})),e}static deepCloneArray(e){t.assert(Array.isArray(e),'Util.deepCloneArray(): "arr" parameter must be an array.',TypeError);let s=[];for(let n=0;n<e.length;n++)!e[n]||"object"!=typeof e[n]||e[n]instanceof HTMLElement?s.push(e[n]):s.push(t.deepClone({},e[n]));return s}static getClassNameFromTagName(t){let e=t.split("-");return e[0].charAt(0).toUpperCase()+e[0].slice(1).toLowerCase()+e[1].charAt(0).toUpperCase()+e[1].slice(1).toLowerCase()}static getTagNameFromClassName(e){let s,n=e,r=e.split("."),a=r[r.length-1];for(s=1;s<a.length&&!t.__isUpper(a.substring(s,s+1));s++);return s<a.length&&(n=a.substring(0,s).toLowerCase()+"-"+a.substring(s).toLowerCase()),n}static getFilenameAndPathFromUrl(t){let e=t.lastIndexOf("/");return[t.substr(0,e),t.substr(e+1)]}static __isUpper(t){return t===t.toUpperCase()&&t!==t.toLowerCase()}static assert(t,e,s,n){if(!t){let t=new(s=s||Error)(e),n=t.stack.split("\n");throw n.splice(1,1),t.stack=n.join("\n"),t}}static warn(t,e,s,n){let r=!0;return t||(s=s||"warn",r=!1),r}static randomWait(t,e){let s=e?t:Math.floor(Math.random()*t);return new Promise(((t,e)=>{setTimeout((()=>{t()}),s)}))}static scopedSelectorAll(t,e){let s=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16);t.setAttribute("__bm_tempid",s);let n="[__bm_tempid='"+s+"'] ",r=n+e.replace(",",","+n),a=t.querySelectorAll(r),i=n+"[bm-powered] "+e.replace(",",", "+n+"[bm-powered] "),o=t.querySelectorAll(i),l=new Set(a);return new Set(o).forEach((t=>{l.delete(t)})),t.removeAttribute("__bm_tempid"),Array.from(l)}}class e{static newComponent(s,n,r,a){a=a||t.getClassNameFromTagName(r);let i=Function("superClass","return function "+e.__validateClassName(a)+"(){ { return Reflect.construct(superClass, [], this.constructor); } }")(s);return e.inherit(i,s),(n=Object.assign({},n)).settings=n.settings?n.settings:{},n.settings.name=a,i.prototype._getSettings=function(){return n},window.BITSMIST.v1[a]=i,r&&customElements.define(r.toLowerCase(),i),i}static inherit(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype._super=e,Object.setPrototypeOf(t,e)}static createObject(s,...n){let r=e.getClass(s);return t.assert(r,`ClassUtil.createObject(): Class '${s}' is not defined.`,ReferenceError),new r(...n)}static getClass(t){let s;try{s=Function("return ("+e.__validateClassName(t)+")")()}catch(t){if(!(t instanceof ReferenceError))throw t}return s}static __validateClassName(e){let s=/^[a-zA-Z0-9\-\._]+$/.test(e);return t.assert(s,`ClassUtil.__validateClassName(): Class name '${e}' is not valid.`,TypeError),e}}class s{static globalInit(t){}static init(t,e,s){}static organize(t,e,s){}static unorganize(t,e,s){}static clear(t){}static isTarget(t,e,s){return e.targetEvents.indexOf("*")>-1||e.targetEvents.indexOf(t)>-1}static getEditor(){return""}}class n extends s{static globalInit(t){Object.defineProperty(t.prototype,"organizers",{get(){return this._organizers}}),t.prototype.addOrganizers=function(t){return n._addOrganizers(this,t)},t.prototype.initOrganizers=function(t){return n._initOrganizers(this,t)},t.prototype.callOrganizers=function(t,e){return n._callOrganizers(this,t,e)},t.prototype.clearOrganizers=function(t,e){return n._clearOrganizers(this,t,e)},n._organizers={},n._targetWords={},Object.defineProperty(n,"organizers",{get:()=>n._organizers})}static organize(t,e,s){return n._addOrganizers(e,s)}static clear(t){t._organizers={}}static register(t,e){(e=Object.assign({},e)).name=e.name?e.name:t,e.targetWords=e.targetWords?e.targetWords:[],e.targetWords=Array.isArray(e.targetWords)?e.targetWords:[e.targetWords],e.targetEvents=e.targetEvents?e.targetEvents:[],e.targetEvents=Array.isArray(e.targetEvents)?e.targetEvents:[e.targetEvents],n._organizers[t]=e,e.object.globalInit(e.targetClassName);for(let t=0;t<e.targetWords.length;t++)n._targetWords[e.targetWords[t]]=e}static addTarget(e,s,r){let a=n._organizers[e],i=t.warn(a,`Organizer not found. organizerName=${e}`),o=t.warn(["targetEvents","targetWords"].indexOf(s)>-1,`Target name is invalid. targetName=${s}`);i&&o&&(Array.isArray(r)?a[s]=a[s].concat(r):a[s].push(r))}static _addOrganizers(e,s){let r={},a=Promise.resolve(),i=s.organizers;return i&&Object.keys(i).forEach((s=>{t.safeGet(i[s],"settings.attach")&&!e._organizers[s]&&n._organizers[s]&&(r[s]=n._organizers[s])})),Object.keys(s).forEach((t=>{let s=n._targetWords[t];s&&(e._organizers[s.name]||(r[s.name]=s.object))})),n._sortItems(r).forEach((r=>{a=a.then((()=>(e._organizers[r]=Object.assign({},n._organizers[r],t.safeGet(s,"organizers."+r)),e._organizers[r].object.init(e,s))))})),a}static _initOrganizers(t,e){return t._organizers={},n.organize("*",t,e)}static _callOrganizers(t,e,s){let r=Promise.resolve();return n._sortItems(t._organizers).forEach((n=>{t._organizers[n].object.isTarget(e,t._organizers[n],t)&&(r=r.then((()=>t._organizers[n].object.organize(e,t,s))))})),r}static _clearOrganizers(t,e,s){let r=Promise.resolve();return n._sortItems(t._organizers).forEach((n=>{t._organizers[n].object.isTarget(e,t._organizers[n],t)&&(r=r.then((()=>t._organizers[n].object.unorganize(e,t,s))))})),r}static _sortItems(t){return Object.keys(t).sort(((e,s)=>t[e].order-t[s].order))}}class r{static ajaxRequest(e){return new Promise(((s,n)=>{let r=t.safeGet(e,"url"),a=t.safeGet(e,"method"),i=t.safeGet(e,"data",""),o=t.safeGet(e,"headers"),l=t.safeGet(e,"options"),g=new XMLHttpRequest;g.open(a,r,!0),l&&Object.keys(l).forEach((t=>{g[t]=l[t]})),o&&Object.keys(o).forEach((t=>{g.setRequestHeader(t,o[t])})),g.addEventListener("load",(()=>{200===g.status||201===g.status?s(g):n(g)})),g.addEventListener("error",(()=>{n(g)})),g.send(i)}))}static loadScript(t){return new Promise(((e,s)=>{let n=t,r=document.createElement("script"),a=document.getElementsByTagName("script")[0];r.async=1,r.onload=r.onreadystatechange=(t,s)=>{(s||!r.readyState||/loaded|complete/.test(r.readyState))&&(r.onload=r.onreadystatechange=null,r=void 0,s||e())},r.src=n,a.parentNode.insertBefore(r,a)}))}}class a{constructor(e){this._options=Object.assign({},e),this.items=t.safeGet(this._options,"items"),this.merger=t.safeGet(this._options,"merger",t.deepMerge)}get items(){return this.clone()}set items(t){this._items=Object.assign({},t)}get merger(){this._merger}set merger(e){t.assert("function"==typeof e,`Store.merger(setter): Merger is not a function. merger=${e}`,TypeError),this._merger=e}clear(){this._items={}}clone(){return t.deepClone({},this._items)}merge(t,e){e=e||this._merger;let s=Array.isArray(t)?t:[t];for(let t=0;t<s.length;t++)s[t]&&"object"==typeof s[t]&&e(this._items,s[t])}get(e,s){return t.safeGet(this._items,e,s)}set(e,s,n){t.safeMerge(this._items,e,s)}remove(t){delete this._items[t]}has(e){return t.safeHas(this._items,e)}}class i extends a{constructor(e){super(e),this.chain;let s=t.safeGet(this._options,"chain");s&&this.chain(s)}get items(){let e;return e=this._chain?t.deepClone(this._chain.clone(),this._items):this.clone(),e}set items(t){this._items=Object.assign({},t)}get localItems(){return this.clone()}clone(){return this._chain?t.deepClone(this._chain.clone(),this._items):a.prototype.clone.call(this)}chain(e){t.assert(e instanceof i,'ChainableStore.chain(): "store" parameter must be a ChainableStore.',TypeError),this._chain=e}get(t,e){let s=e;return this.has(t)?s=a.prototype.get.call(this,t,e):this._chain&&(s=this._chain.get(t,e)),s}merge(t,e){this._options.writeThrough?this._chain.merge(t,e):a.prototype.merge.call(this,t,e)}set(e,s,n){t.safeGet(n,"writeThrough",this._options.writeThrough)?this._chain.set(e,s,n):a.prototype.set.call(this,e,s)}}class o extends s{static globalInit(t){Object.defineProperty(t.prototype,"settings",{get(){return this._settings}}),o.__globalSettings=new i,Object.defineProperty(o,"globalSettings",{get:()=>o.__globalSettings})}static init(t,e){return t._settings=new i({items:e}),t._settings.merge(t._getSettings()),t._settings.get("settings.useGlobalSettings")&&t._settings.chain(o.globalSettings),Promise.resolve().then((()=>o._loadExternalSetting(t,"setting"))).then((()=>{o._loadAttrSettings(t)}))}static _loadExternalSetting(e,s){let n,r;if(e.hasAttribute("bm-"+s+"ref")){let a=t.getFilenameAndPathFromUrl(e.getAttribute("bm-"+s+"ref"));r=a[0],n=a[1].slice(0,-3)}else r=e.hasAttribute("bm-"+s+"path")?e.getAttribute("bm-"+s+"path"):"",n=e.hasAttribute("bm-"+s+"name")?e.getAttribute("bm-"+s+"name"):"",r&&!n&&(n="settings");if(n||r)return e.loadSetting(n,{path:r})}static _loadAttrSettings(t){let e=document.querySelector(t._settings.get("settings.rootNode"))?document.querySelector(t._settings.get("settings.rootNode")).getAttribute("bm-settings"):t.getAttribute("bm-settings");if(e){let s={settings:JSON.parse(e)};t._settings.merge(s)}}}function l(){return Reflect.construct(HTMLElement,[],this.constructor)}e.inherit(l,HTMLElement),l.prototype.connectedCallback=function(){this._ready||(this._ready=Promise.resolve()),this._ready=this._ready.then((()=>!this._initialized||this.settings.get("settings.autoRestart")?(this._initialized=!0,this.start()):this.changeState("started")))},l.prototype.disconnectedCallback=function(){this.settings.get("settings.autoStop")&&(this._ready=this._ready.then((()=>this.stop())))},l.prototype.adoptedCallback=function(){},l.prototype.attributeChangedCallback=function(){},Object.defineProperty(l.prototype,"name",{get(){return this._name}}),Object.defineProperty(l.prototype,"uniqueId",{get(){return this._uniqueId}}),Object.defineProperty(l.prototype,"rootElement",{get(){return this._rootElement}}),l.prototype.start=function(e){let s={settings:{autoFetch:!0,autoFill:!0,autoPostStart:!0,autoRefresh:!0,autoRestart:!1,autoSetup:!0,autoStop:!0,hasTemplate:!0,useGlobalSettings:!0},organizers:{OrganizerOrganizer:{settings:{attach:!0}},SettingOrganizer:{settings:{attach:!0}},StateOrganizer:{settings:{attach:!0}},EventOrganizer:{settings:{attach:!0}},LoaderOrganizer:{settings:{attach:!0}},TemplateOrganizer:{settings:{attach:!0}}}};return e=e?t.deepMerge(s,e):s,this.setAttribute("bm-powered",""),this._uniqueId=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16),this._name=this.constructor.name,this._rootElement=t.safeGet(e,"settings.rootElement",this),Promise.resolve().then((()=>this._initStart(e))).then((()=>this._preStart())).then((()=>{if(this.settings.get("settings.autoPostStart"))return this._postStart()}))},l.prototype.stop=function(t){return t=Object.assign({},t),Promise.resolve().then((()=>this.changeState("stopping"))).then((()=>this.trigger("beforeStop",t))).then((()=>this.trigger("doStop",t))).then((()=>this.changeState("stopped"))).then((()=>this.trigger("afterStop",t)))},l.prototype.switchTemplate=function(t,e){return e=Object.assign({},e),this.activeTemplateName===t?Promise.resolve():Promise.resolve().then((()=>this.addTemplate(t))).then((()=>this.applyTemplate(t))).then((()=>{if(this.settings.get("settings.autoSetup"))return this.setup(this.settings.items);this.hideConditionalElements()})).then((()=>this.callOrganizers("afterAppend",this.settings.items))).then((()=>this.trigger("afterAppend",e))).then((()=>{}))},l.prototype.setup=function(t){return t=Object.assign({},t),Promise.resolve().then((()=>this.trigger("beforeSetup",t))).then((()=>this.trigger("doSetup",t))).then((()=>this.trigger("afterSetup",t))).then((()=>{}))},l.prototype.refresh=function(e){return e=Object.assign({},e),Promise.resolve().then((()=>this.trigger("beforeRefresh",e))).then((()=>this.trigger("doTarget",e))).then((()=>{if(t.safeGet(e,"autoFetch",this.settings.get("settings.autoFetch")))return this.fetch(e)})).then((()=>{this.showConditionalElements(this.item)})).then((()=>{if(t.safeGet(e,"autoFill",this.settings.get("settings.autoFill")))return this.fill(e)})).then((()=>this.trigger("doRefresh",e))).then((()=>this.trigger("afterRefresh",e))).then((()=>{}))},l.prototype.fetch=function(t){return t=Object.assign({},t),Promise.resolve().then((()=>this.trigger("beforeFetch",t))).then((()=>this.callOrganizers("doFetch",t))).then((()=>this.trigger("doFetch",t))).then((()=>this.trigger("afterFetch",t))).then((()=>{}))},l.prototype.fill=function(t){},l.prototype.clear=function(t){},l.prototype.scopedSelectorAll=function(e){return t.scopedSelectorAll(this,e)},l.prototype._injectSettings=function(t){return t},l.prototype._getSettings=function(){return{}},l.prototype._initStart=function(t){return Promise.resolve().then((()=>this._injectSettings(t))).then((t=>o.init(this,t))).then((()=>(this._adjustSettings(),this.initOrganizers(this.settings.items))))},l.prototype._preStart=function(){return Promise.resolve().then((()=>this.changeState("starting"))).then((()=>this.addOrganizers(this.settings.items))).then((()=>this.callOrganizers("beforeStart",this.settings.items))).then((()=>this.trigger("beforeStart"))).then((()=>{if(this.settings.get("settings.hasTemplate"))return this.switchTemplate(this.settings.get("settings.templateName"));if(this.settings.get("settings.autoSetup"))return this.setup(this.settings.items)})).then((()=>{if(this.settings.get("settings.autoRefresh"))return this.refresh()}))},l.prototype._postStart=function(){return Promise.resolve().then((()=>this.changeState("started"))).then((()=>this.callOrganizers("afterStart",this.settings.items))).then((()=>this.trigger("afterStart")))},l.prototype._adjustSettings=function(){this._rootElement=this.settings.get("settings.rootElement",this);let t=this.settings.get("settings.name");t&&(this._name=t),this.settings.get("settings.autoMorph")&&(this.settings.set("settings.autoRefresh",!1),this.settings.set("settings.autoSetup",!1))},customElements.define("bm-component",l);class g extends s{static globalInit(){Object.defineProperty(l.prototype,"state",{get(){return this._state},set(t){this._state=t}}),l.prototype.changeState=function(t){return g._changeState(this,t)},l.prototype.waitFor=function(t,e){return g._waitFor(this,t,e)},l.prototype.suspend=function(t){return g._suspend(this,t)},l.prototype.resume=function(t){return g._resume(this,t)},l.prototype.pause=function(t){return g._pause(this,t)},g.__suspends={},g.__components=new a,g.__waitingList=new a,g.__waitingListIndexName=new Map,g.__waitingListIndexId=new Map,g.__waitingListIndexNone=new Map,g.waitFor=function(t,e){return g._waitFor(null,t,e)}}static init(t,e){t._state="",t._suspends={},g.__loadAttrSettings(t)}static organize(t,e,s){let n=Promise.resolve(),r=s.waitFor;return r&&r[t]&&(n=g._waitFor(e,r[t],e.settings.get("system.waitforTimeout"))),n}static clear(){this.__waitingList.clear()}static globalSuspend(t){g.__suspends[t]=g._createSuspendInfo(t),g.__suspends[t].state="pending"}static globalResume(t){g.__suspends[t].resolve(),g.__suspends[t].state="resolved"}static _waitFor(t,e,s){let n,r=s&&s.timeout?s.timeout:1e4,a={waiter:s&&s.waiter?s.waiter:t,waitlist:e.slice()};return g.__isAllReady(a)?n=Promise.resolve():(n=new Promise(((s,n)=>{a.resolve=s,a.reject=n,setTimeout((()=>{let s=t&&t.name||a.waiter&&a.waiter.tagName||"";n(`StateOrganizer._waitFor(): Timed out after ${r} milliseconds waiting for ${g.__dumpWaitlist(e)}, name=${s}.`)}),r)})),a.promise=n,g.__addToWaitingList(a,t)),n}static _waitForSingle(t,e,s){let n=g.__components.get(t.uniqueId),r={id:t.uniqueId,state:e};return g.__isReady(r,n)?Promise.resolve():g.waitFor(t,[r],s)}static _changeState(e,s){t.assert(g.__isTransitionable(e._state,s),`StateOrganizer._changeState(): Illegal transition. name=${e.name}, fromState=${e._state}, toState=${s}, id=${e.id}`,Error),e._state=s,g.__components.set(e.uniqueId,{object:e,state:s}),g.__processWaitingList(e,s)}static _suspend(t,e){t._suspends[e]=g._createSuspendInfo(),t._suspends[e].state="pending"}static _resume(t,e){t._suspends[e].resolve(),t._suspends[e].state="resolved"}static _pause(t,e){let s=[];return g.__suspends[e]&&"pending"===g.__suspends[e].state&&!t.settings.get("settings.ignoreGlobalSuspend")&&s.push(g.__suspends[e].promise),t._suspends[e]&&"pending"===t._suspends[e].state&&s.push(t._suspends[e].promise),Promise.all(s)}static __isTransitionable(t,e){let s=!0;return t&&"ing"===t.slice(-3)&&("stopping"===t&&"stopped"!==e||"starting"===t&&"started"!==e)&&(s=!1),s}static __processWaitingList(t,e){let s=g.__waitingListIndexName.get(t.name+"."+e);s&&s.length>0&&g.__processIndex(s);let n=g.__waitingListIndexId.get(t.uniqueId+"."+e);n&&n.length>0&&g.__processIndex(n);let r=g.__waitingListIndexNone.get("none");r&&r.length>0&&g.__processIndex(r)}static __processIndex(t){let e=[];for(let s=0;s<t.length;s++){let n=t[s];g.__waitingList.get(n),g.__isAllReady(g.__waitingList.get(n))&&(g.__waitingList.get(n).resolve(),g.__waitingList.remove(n),e.push(n))}for(let s=e.length-1;s>=0;s--)g.__removeFromIndex(t,e[s])}static __addToWaitingList(t){let e=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16);g.__waitingList.set(e,t);let s=t.waitlist;for(let t=0;t<s.length;t++)s[t].state=s[t].state||"started",s[t].id?g.__addToIndex(g.__waitingListIndexId,s[t].id+"."+s[t].state,e):s[t].name?g.__addToIndex(g.__waitingListIndexName,s[t].name+"."+s[t].state,e):g.__addToIndex(g.__waitingListIndexNone,"none",e)}static __addToIndex(t,e,s){let n=t.get(e);n||(n=[],t.set(e,n)),-1===n.indexOf(s)&&n.push(s)}static __removeFromIndex(t,e){let s=t.indexOf(e);s>-1&&t.splice(s,1)}static __getComponentInfo(t){let e;if(t.id)e=g.__components.get(t.id);else if(t.name)Object.keys(g.__components.items).forEach((s=>{t.name===g.__components.get(s).object.name&&(e=g.__components.get(s))}));else if(t.rootNode){let s=document.querySelector(t.rootNode);s&&s.uniqueId&&(e=g.__components.get(s.uniqueId))}else if(t.object){let s=t.object;s.uniqueId&&(e=g.__components.get(s.uniqueId))}return e}static __isAllReady(t){let e=!0,s=t.waitlist;for(let t=0;t<s.length;t++){let n=!1,r=this.__getComponentInfo(s[t]);if(r&&g.__isReady(s[t],r)&&(n=!0),!n){e=!1;break}}return e}static __isReady(t,e){let s=g.__isComponentMatch(e,t);return s&&(s=g.__isStateMatch(e.state,t.state)),s}static __isComponentMatch(t,e){let s=!0;return e.component&&t.object!==e.component&&(s=!1),e.name&&t.object.name!==e.name&&(s=!1),e.id&&t.object.uniqueId!==e.id&&(s=!1),e.rootNode&&!document.querySelector(e.rootNode)&&(s=!1),s}static __isStateMatch(t,e){let s=!0;if("started"===(e=e||"started"))"started"!==t&&(s=!1);else t!==e&&(s=!1);return s}static __loadAttrSettings(t){if(t.hasAttribute("bm-waitfor")){let e={name:t.getAttribute("bm-waitfor"),state:"started"};t.settings.merge({waitFor:[e]})}if(t.hasAttribute("bm-waitfornode")){let e={rootNode:t.getAttribute("bm-waitfornode"),state:"started"};t.settings.merge({waitFor:[e]})}}static __dumpWaitlist(t){let e="";for(let s=0;s<t.length;s++){e+="\n\t{"+(t[s].id?"id:"+t[s].id+",":"")+(t[s].name?"name:"+t[s].name+",":"")+(t[s].object?"element:"+t[s].object.tagName+",":"")+(t[s].rootNode?"node:"+t[s].rootNode+",":"")+(t[s].state?"state:"+t[s].state:"")+"},"}return"["+e+"\n]"}static _createSuspendInfo(){let t={},e=new Promise(((e,s)=>{t.resolve=e,t.reject=s,t.state="pending"}));return t.promise=e,t}}class c extends s{static globalInit(){Object.defineProperty(l.prototype,"templates",{get(){return this._templates}}),Object.defineProperty(l.prototype,"activeTemplateName",{get(){return this._activeTemplateName},set(t){this._activeTemplateName=t}}),l.prototype.addTemplate=function(t,e){return c._addTemplate(this,t,e)},l.prototype.applyTemplate=function(t){return c._applyTemplate(this,t)},l.prototype.cloneTemplate=function(t){return c._clone(this,t)},l.prototype.showConditionalElements=function(t){return c._showConditionalElements(this,t)},l.prototype.hideConditionalElements=function(){return c._hideConditionalElements(this)}}static init(t,e){if(t._templates={},t._activeTemplateName="",!t.settings.get("settings.templateName")){let e=t.settings.get("settings.fileName")||t.tagName.toLowerCase();t.settings.set("settings.templateName",e)}}static organize(t,e,s){let n=[],r=s.templates;return r&&Object.keys(r).forEach((s=>{if("beforeStart"===t)switch(r[s].type){case"html":case"url":n.push(c._addTemplate(e,s))}else if("afterAppend"===t&&"node"===r[s].type)n.push(c._addTemplate(e,s))})),Promise.all(n)}static clear(t){t._templates={}}static _addTemplate(t,e,s){return(t._templates[e]||c.__createTemplateInfo(t,e)).isLoaded?Promise.resolve():t.loadTemplate(e)}static _applyTemplate(e,s){if(e._activeTemplateName===s)return Promise.resolve();let n=e._templates[s];if(t.assert(n,`TemplateOrganizer._applyTemplate(): Template not loaded. name=${e.name}, templateName=${s}`,ReferenceError),n.node){let t=c.clone(e,n.name);e.insertBefore(t,e.firstChild)}else e.innerHTML=n.html;e._activeTemplateName=s}static _clone(e,s){s=s||e.settings.get("settings.templateName");let n,r=e._templates[s];if(t.assert(r,`TemplateOrganizer._addTemplate(): Template not loaded. name=${e.name}, templateName=${s}`,ReferenceError),r.node)n=document.importNode(r.node,!0);else{let t=document.createElement("div");t.innerHTML=r.html,n=t.firstElementChild}return n}static _showConditionalElements(e,s){t.scopedSelectorAll(e,"[bm-visible]").forEach((e=>{let n=e.getAttribute("bm-visible");t.safeEval(n,s,s)?e.style.removeProperty("display"):e.style.display="none"}))}static _hideConditionalElements(e){t.scopedSelectorAll(e,"[bm-visible]").forEach((t=>{t.style.display="none"}))}static __createTemplateInfo(t,e){return t._templates[e]||(t._templates[e]={},t._templates[e].name=e,t._templates[e].html="",t._templates[e].isLoaded=!1),t._templates[e]}}class p extends s{static globalInit(){l.prototype.initEvents=function(t,e,s){p._initEvents(this,t,e,s)},l.prototype.addEventHandler=function(t,e,s,n){p._addEventHandler(this,s,t,e,n)},l.prototype.trigger=function(t,e,s){return p._trigger(this,t,e,s)},l.prototype.triggerAsync=function(t,e,s){return p._triggerAsync(this,t,e,s)},l.prototype.getEventHandler=function(t){return p._getEventHandler(this,t)},l.prototype.removeEventHandler=function(t,e,s){return p._removeEventHandler(this,s,t,e)},Object.defineProperty(l.prototype,"eventResult",{get(){return this._eventResult}})}static init(t,e){t._eventResult={}}static organize(t,e,s){let n=s.events;if(n){let s=p.__filterElements(e,n,t);Object.keys(s).forEach((t=>{p._initEvents(e,t,n[t])}))}}static unorganize(t,e,s){let n=s.events;n&&Object.keys(n).forEach((t=>{p._removeEvents(e,t,n[t])}))}static _addEventHandler(e,s,n,r,a){s=s||e;let i="object"==typeof r?r:{},o=p._getEventHandler(e,r);t.assert(o,`EventOrganizer._addEventHandler(): handler not found. name=${e.name}, eventName=${n}`),s.__bm_eventinfo||(s.__bm_eventinfo={component:e,listeners:{},promises:{},statuses:{}});let l=s.__bm_eventinfo.listeners;l[n]||(l[n]=[],s.addEventListener(n,p.__callEventHandler,i.listnerOptions)),l[n].push({handler:o,options:i.options,bindTo:a}),t.safeGet(i,"order"),l[n].sort(((t,e)=>t.order===e.order?0:t.order>e.order?1:-1))}static _removeEventHandler(e,s,n,r){s=s||e;let a=p._getEventHandler(e,r);t.assert(a,`EventOrganizer._removeEventHandler(): handler not found. name=${e.name}, eventName=${n}`);let i=t.safeGet(s,"__bm_eventinfo.listeners."+n);if(i)for(let t=i.length-1;t>=0;t--)if(i[t].handler===a){i.splice(t,1);break}}static _initEvents(t,e,s,n){n=n||t;let r=p.__getTargetElements(t,n,e,s);Object.keys(s.handlers).forEach((e=>{let n=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<n.length;s++)for(let a=0;a<r.length;a++)t.addEventHandler(e,n[s],r[a])}))}static _removeEvents(t,e,s,n){n=n||t;let r=p.__getTargetElements(t,n,e,s);Object.keys(s.handlers).forEach((e=>{let n=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<n.length;s++)for(let a=0;a<r.length;a++)t.removeEventHandler(e,n[s],r[a])}))}static _trigger(e,s,n,r){(n=Object.assign({},n)).sender=n.sender||e,e._eventResult={},n.result=e._eventResult,r=r||e;let a=null;try{a=new CustomEvent(s,{detail:n})}catch(t){a=document.createEvent("CustomEvent"),a.initCustomEvent(s,!1,!1,n)}return r.dispatchEvent(a),t.safeGet(r,"__bm_eventinfo.promises."+s)||Promise.resolve()}static _triggerAsync(t,e,s,n){return(s=s||{}).async=!0,p._trigger.call(t,t,e,s,n)}static _getEventHandler(t,e){return"object"==typeof e?e.handler:e}static __filterElements(t,e,s){let n;switch(s){case"beforeStart":n=Object.keys(e).filter((t=>p.__isTargetSelf(t,e[t])));break;case"afterAppend":n=Object.keys(e).filter((t=>!p.__isTargetSelf(t,e[t])));break;case"afterSpecLoad":n=Object.keys(e)}return n.reduce(((t,s)=>(t[s]=e[s],t)),{})}static __isTargetSelf(t,e){let s=!1;return("this"===t||e&&"this"===e.rootNode)&&(s=!0),s}static __getTargetElements(e,s,n,r){let a;return a=p.__isTargetSelf(n,r)?[s]:r&&r.rootNode?t.scopedSelectorAll(s,r.rootNode):t.scopedSelectorAll(s,"#"+n),a}static __isHandlerInstalled(e,s,n){let r=!1,a=t.safeGet(e.__bm_eventinfo,"listeners."+s);if(a)for(let t=0;t<a.length;t++)if(a[t].handler===n){r=!0;break}return r}static __callEventHandler(e){let s=t.safeGet(this,"__bm_eventinfo.listeners."+e.type),n=t.safeGet(e,"detail.sender",this),r=t.safeGet(this,"__bm_eventinfo.component");t.warn("handling"!==t.safeGet(this,"__bm_eventinfo.statuses."+e.type),`EventOrganizer.__callEventHandler(): Event handler is already running. name=${this.tagName}, eventName=${e.type}`),t.safeSet(this,"__bm_eventinfo.statuses."+e.type,"handling"),!1===t.safeGet(e,"detail.async",!1)?this.__bm_eventinfo.promises[e.type]=p.__handle(e,n,r,s).then((s=>{t.safeSet(this,"__bm_eventinfo.promises."+e.type,null),t.safeSet(this,"__bm_eventinfo.statuses."+e.type,"")})):(this.__bm_eventinfo.promises[e.type]=p.__handleAsync(e,n,r,s),t.safeSet(this,"__bm_eventinfo.promises."+e.type,null),t.safeSet(this,"__bm_eventinfo.statuses."+e.type,""))}static __handle(e,s,n,r){let a=Promise.resolve(),i=!1;for(let o=0;o<r.length;o++){let l={component:n,options:r[o].options?r[o].options:{}};a=a.then((()=>{let a=r[o].handler;a="string"==typeof a?n[a]:a,t.assert("function"==typeof a,`EventOrganizer._addEventHandler(): Event handler is not a function. name=${n.name}, eventName=${e.type}`,TypeError);let i=r[o].bindTo?r[o].bindTo:n;return a.call(i,s,e,l)})),i=!(!r[o].options||!r[o].options.stopPropagation)||i}return i&&e.stopPropagation(),a}static __handleAsync(e,s,n,r){let a=!1;for(let i=0;i<r.length;i++){let o={component:n,options:r[i].options?r[i].options:{}},l=r[i].handler;l="string"==typeof l?n[l]:l,t.assert("function"==typeof l,`EventOrganizer._addEventHandler(): Event handler is not a function. name=${n.name}, eventName=${e.type}`,TypeError);let g=r[i].bindTo?r[i].bindTo:n;l.call(g,s,e,o),a=!(!r[i].options||!r[i].options.stopPropagation)||a}return a&&e.stopPropagation(),Promise.resolve()}}class d extends s{static globalInit(){BITSMIST.v1.Component.prototype.getLoader=function(...t){return d._getLoader(this,...t)},BITSMIST.v1.Component.prototype.loadTags=function(...t){return this.getLoader().loadTags(this,...t)},BITSMIST.v1.Component.prototype.loadTag=function(...t){return this.getLoader().loadTag(this,...t)},BITSMIST.v1.Component.prototype.loadComponent=function(...t){return this.getLoader().loadComponent(this,...t)},BITSMIST.v1.Component.prototype.loadTemplate=function(...t){return this.getLoader().loadTemplate(this,...t)},BITSMIST.v1.Component.prototype.loadSetting=function(...t){return this.getLoader().loadSetting(this,...t)},BITSMIST.v1.Component.prototype.loadSettingFile=function(...t){return this.getLoader().loadSettingFile(this,...t)},d._loaders={},Object.defineProperty(d,"loaders",{get:()=>d._loaders}),d._loaders.DefaultLoader=BITSMIST.v1.DefaultLoader,document.addEventListener("DOMContentLoaded",(()=>{if(BITSMIST.v1.settings.get("organizers.LoaderOrgaznier.settings.autoLoadOnStartup",!0)){e.newComponent(BITSMIST.v1.Component,{settings:{autoRefresh:!1,autoSetup:!1,hasTemplate:!1,rootElement:document.body}},"bm-app","BmApp");let t=document.createElement("bm-app");t.start().then((()=>{t.getLoader(BITSMIST.v1.settings.get("system.loaderName")).loadTags(t,t.rootElement,{waitForTags:!1})}))}}))}static init(t,e){t.getLoader().init(t)}static organize(t,e,s){if("afterAppend"===t)return e.loadTags(e.rootElement)}static register(t,e){(e=Object.assign({},e)).name=e.name?e.name:t,d._loaders[t]=e}static _getLoader(e,s){return s=s||e.settings.get("settings.loaderName","DefaultLoader"),t.assert(d.loaders[s],`Loader doesn't exist. loaderName=${s}`),d._loaders[s].object}}class m extends s{static init(t,e){Object.defineProperty(t,"components",{get(){return this._components}}),t.addComponent=function(t,e,s){return m._addComponent(this,t,e,s)},t._components={}}static organize(t,e,s){let n=Promise.resolve(),r=s.molds;r&&Object.keys(r).forEach((t=>{n=n.then((()=>m._addComponent(e,t,r[t],!0)))}));let a=s.components;return a&&Object.keys(a).forEach((t=>{n=n.then((()=>m._addComponent(e,t,a[t])))})),n}static unorganize(t,e,s){m.clear(e)}static clear(t){Object.keys(t._components).forEach((e=>{t._components[e].parentNode.removeChild(t._components[e])})),t._components={}}static _addComponent(e,s,n,r){let a=t.safeGet(n,"settings.className")||s,i=t.safeGet(n,"settings.tagName")||t.getTagNameFromClassName(a);return Promise.resolve().then((()=>{let s={splitComponent:t.safeGet(n,"settings.splitComponent",e.settings.get("system.splitComponent",!1))};return e.loadComponent(a,n,s,i)})).then((()=>{t.safeGet(n,"settings.rootNode")&&!e._components[s]&&(e._components[s]=m.__insertTag(e,i,n))})).then((()=>{if(r||t.safeGet(n,"settings.sync")){let s=!0===(r=r||t.safeGet(n,"settings.sync"))?"started":r,i=a.split(".");return e.waitFor([{name:i[i.length-1],state:s}])}}))}static __insertTag(e,s,n){let r,a=e.rootElement.querySelector(t.safeGet(n,"settings.rootNode"));t.assert(a,`ComponentOrganizer.__insertTag(): Root node does not exist. name=${e.name}, tagName=${s}, rootNode=${t.safeGet(n,"settings.rootNode")}`,ReferenceError);let i=t.safeGet(n,"settings.tag")?t.safeGet(n,"settings.tag"):"<"+s+"></"+s+">";return t.safeGet(n,"settings.overwrite")?(a.outerHTML=i,r=a):(a.insertAdjacentHTML("afterbegin",i),r=a.children[0]),r._injectSettings=function(e){return r._super&&r._super.prototype._injectSettings&&(e=r._super.prototype._injectSettings.call(r,e)),t.deepMerge(e,n)},r}}class h{static init(t,e){this._loadAttrSettings(t)}static loadTags(e,s,n){let r=[],a=[],i=t.scopedSelectorAll(s,"[bm-autoload]:not([bm-autoloading]):not([bm-powered]),[bm-automorph]:not([bm-autoloading]):not([bm-powered])");return i.forEach((t=>{t.setAttribute("bm-autoloading","");let s=t.hasAttribute("bm-loader")?d.getLoader(t.getAttribute("bm-loader")).object:this;r.push(s.loadTag(e,t,n).then((()=>{t.removeAttribute("bm-autoloading")})))})),i=t.scopedSelectorAll(s,"[bm-powered],[bm-autoloading]"),i.forEach((t=>{if(s!=t.rootElement&&!t.hasAttribute("bm-nowait")){let e={object:t,state:"started"};a.push(e)}})),Promise.all(r).then((()=>{if(t.safeGet(n,"waitForTags")&&a.length>0)return BITSMIST.v1.StateOrganizer.waitFor(a,{waiter:s})}))}static loadTag(e,s,n){let r=s.getAttribute("bm-autoload"),a=s.getAttribute("bm-classname")||t.getClassNameFromTagName(s.tagName),i=s.getAttribute("bm-path")||"",o=t.safeGet(n,"splitComponent",e.settings.get("system.splitComponent",!1)),l={settings:{autoMorph:!!s.hasAttribute("bm-automorph")&&(!s.getAttribute("bm-automorph")||s.getAttribute("bm-automorph")),path:i}},g={splitComponent:o};if(r){let e=t.getFilenameAndPathFromUrl(r);g.path=e[0],".js"===r.slice(-3).toLowerCase()?l.settings.fileName=e[1].substring(0,e[1].length-3):".html"===r.slice(-5).toLowerCase()&&(l.settings.autoMorph=!0,l.settings.fileName=e[1].substring(0,e[1].length-5))}return this.loadComponent(e,a,l,g,s.tagName)}static loadComponent(s,n,r,a,i){let o;i=i.toLowerCase();let l=t.safeGet(a,"path",t.concatPath([s.settings.get("system.appBaseUrl",""),s.settings.get("system.componentPath",""),t.safeGet(r,"settings.path")]));if(customElements.get(i))return Promise.resolve();let g=t.safeGet(r,"settings.autoMorph");if(g){let t=!0===g?BITSMIST.v1.Component:e.getClass(g);e.newComponent(t,r,i,n)}else{let e=t.safeGet(r,"settings.fileName",i);o=this._autoloadComponent(n,e,l,a)}return Promise.all([o]).then((()=>{if(!customElements.get(i)){let t=e.getClass(n);customElements.define(i,t)}}))}static loadTemplate(t,e,s){let n,r=t._templates[e],a=t.settings.get("templates."+e,{});switch(a.type){case"html":r.html=a.html,n=Promise.resolve();break;case"node":r.html=t.querySelector(a.rootNode).innerHTML,n=Promise.resolve();break;default:n=this._loadTemplateFile(t,r.name,s).then((t=>{r.html=t}))}return n.then((()=>{r.isLoaded=!0}))}static loadSetting(e,s,n){let r;return Promise.resolve().then((()=>(r=t.safeGet(n,"path",t.concatPath([e.settings.get("system.appBaseUrl",""),e.settings.get("system.componentPath",""),e.settings.get("settings.componentPath","")])),this.loadSettingFile(e,s,r,"js")))).then((t=>{t&&e.settings.merge(t)}))}static loadSettingFile(e,s,n,a){a=a||"js";let i,o=t.concatPath([n,s+"."+a]);return r.ajaxRequest({url:o,method:"GET"}).then((t=>{if("json"===a)try{i=JSON.parse(t.responseText)}catch(t){throw t instanceof SyntaxError?new SyntaxError(`Illegal json string. url=${o}, message=${t.message}`):t}else i=Function('"use strict";return ('+t.responseText+")").call(e);return i}))}static _isLoadedClass(t){let s=!1;return("loaded"===h._classes.get(t,{}).state||e.getClass(t))&&(s=!0),s}static _autoloadComponent(t,e,s,n){let r;return this._isLoadedClass(t)?(h._classes.set(t,{state:"loaded"}),r=Promise.resolve()):"loading"===h._classes.get(t,{}).state?r=h._classes.get(t).promise:(h._classes.set(t,{state:"loading"}),r=this._loadComponentScript(e,s,n).then((()=>{h._classes.set(t,{state:"loaded",promise:null})})),h._classes.set(t,{promise:r})),r}static _loadComponentScript(e,s,n){let a=t.concatPath([s,e+".js"]),i=t.concatPath([s,e+".settings.js"]);return Promise.resolve().then((()=>r.loadScript(a))).then((()=>{if(n.splitComponent)return r.loadScript(i)})).then((()=>{}))}static _loadTemplateFile(e,s,n){let a=t.concatPath([e.settings.get("system.appBaseUrl",""),e.settings.get("system.templatePath",""),e.settings.get("settings.path","")]),i=t.concatPath([a,s])+".html";return r.ajaxRequest({url:i,method:"GET"}).then((t=>t.responseText))}static _loadAttrSettings(e){if(e.getAttribute("bm-autoload")){let s=t.getFilenameAndPathFromUrl(e.getAttribute("bm-autoload"));e._settings.set("system.appBaseUrl",""),e._settings.set("system.templatePath",s[0]),e._settings.set("system.componentPath",s[0]),e._settings.set("settings.path",""),".js"===s[1].slice(-3).toLowerCase()?e._settings.set("settings.fileName",s[1].substring(0,s[1].length-3)):".html"===s[1].slice(-5).toLowerCase()&&e._settings.set("settings.fileName",s[1].substring(0,s[1].length-5))}e.hasAttribute("bm-path")&&e._settings.set("settings.path",e.getAttribute("bm-path"))}}h._classes=new a,window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},window.BITSMIST.v1.Component=l,window.BITSMIST.v1.Organizer=s,window.BITSMIST.v1.OrganizerOrganizer=n,n.globalInit(l),window.BITSMIST.v1.SettingOrganizer=o,o.globalInit(l),window.BITSMIST.v1.settings=o.globalSettings,n.register("StateOrganizer",{object:g,targetWords:"waitFor",targetEvents:"*",order:100}),window.BITSMIST.v1.StateOrganizer=g,n.register("TemplateOrganizer",{object:c,targetWords:"templates",targetEvents:["beforeStart","afterAppend"],order:200}),window.BITSMIST.v1.TemplateOrganizer=c,n.register("EventOrganizer",{object:p,targetWords:"events",targetEvents:["beforeStart","afterAppend","afterSpecLoad"],order:210}),window.BITSMIST.v1.EventOrganizer=p,n.register("LoaderOrganizer",{object:d,targetEvents:["afterAppend"],order:400}),window.BITSMIST.v1.LoaderOrganizer=d,n.register("ComponentOrganizer",{object:m,targetWords:["molds","components"],targetEvents:["afterStart"],order:410}),window.BITSMIST.v1.ComponentOrganizer=m,d.register("DefaultLoader",{object:h}),window.BITSMIST.v1.DefaultLoader=h,window.BITSMIST.v1.Store=a,window.BITSMIST.v1.ChainableStore=i,window.BITSMIST.v1.AjaxUtil=r,window.BITSMIST.v1.ClassUtil=e,window.BITSMIST.v1.Util=t}();
