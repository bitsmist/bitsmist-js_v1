!function(){"use strict";class t{static safeGet(t,e,s){let r=t,n=!0,a=e.split(".");for(let t=0;t<a.length;t++){if(!r||"object"!=typeof r||!(a[t]in r)){n=!1;break}r=r[a[t]]}return n?r:s}static safeSet(e,s,r){let n=e,a=s.split(".");for(let e=0;e<a.length-1;e++)t.assert(n&&"object"==typeof n,`Util.safeSet(): Key already exists. key=${s}, existingKey=${e>0?a[e-1]:""}, existingValue=${n}`,TypeError),a[e]in n||(n[a[e]]={}),n=n[a[e]];return n[a[a.length-1]]=r,e}static safeMerge(e,s,r){let n=e,a=s.split(".");for(let e=0;e<a.length-1;e++)t.assert(n&&"object"==typeof n,`Util.safeSet(): Key already exists. key=${s}, existingKey=${e>0?a[e-1]:""}, existingValue=${n}`,TypeError),a[e]in n||(n[a[e]]={}),n=n[a[e]];let i=a[a.length-1];return n[i]&&"object"==typeof n[i]&&r&&"object"==typeof r?t.deepMerge(n[i],r):n[i]=r,e}static safeHas(t,e){let s=t,r=!0,n=e.split(".");for(let t=0;t<n.length;t++){if(!s||"object"!=typeof s||!(n[t]in s)){r=!1;break}s=s[n[t]]}return r}static safeEval(t,e,s){let r,n=[];s&&(r=Object.keys(s).join(","),Object.keys(s).forEach((t=>{n.push(s[t])})));let a=!1;try{a=Function(r,'"use strict";return ('+t+")").apply(e,n)}catch(t){}return a}static concatPath(t){let e=t[0]||"";for(let s=1;s<t.length;s++)t[s]&&("/"===e.slice(e.length-1)&&"/"===t[s].slice(0,1)?e+=t[s].slice(1):"/"===e.slice(e.length-1)||"/"===t[s].slice(0,1)?e+=t[s]:e?e+="/"+t[s]:e=t[s]);return e}static deepMerge(e,s){return t.assert(e&&"object"==typeof e&&s&&"object"==typeof s,'Util.deepMerge(): "obj1" and "obj2" parameters must be an object.',TypeError),Object.keys(s).forEach((r=>{Array.isArray(e[r])?e[r]=e[r].concat(s[r]):!(e.hasOwnProperty(r)&&e[r]&&"object"==typeof e[r]&&s[r]&&"object"==typeof s[r])||e[r]instanceof HTMLElement||s[r]instanceof HTMLElement?e[r]=s[r]:t.deepMerge(e[r],s[r])})),e}static deepClone(e,s){return t.assert(e&&"object"==typeof e&&s&&"object"==typeof s,'Util.deepMerge(): "obj1" and "obj2" parameters must be an object.',TypeError),Object.keys(s).forEach((r=>{Array.isArray(e[r])?e[r]=e[r].concat(s[r]):!(e.hasOwnProperty(r)&&e[r]&&"object"==typeof e[r]&&s[r]&&"object"==typeof s[r])||e[r]instanceof HTMLElement||s[r]instanceof HTMLElement?Array.isArray(s[r])?e[r]=t.deepCloneArray(s[r]):!s[r]||"object"!=typeof s[r]||s[r]instanceof HTMLElement?e[r]=s[r]:(e[r]={},t.deepClone(e[r],s[r])):t.deepClone(e[r],s[r])})),e}static deepCloneArray(e){t.assert(Array.isArray(e),'Util.deepCloneArray(): "arr" parameter must be an array.',TypeError);let s=[];for(let r=0;r<e.length;r++)!e[r]||"object"!=typeof e[r]||e[r]instanceof HTMLElement?s.push(e[r]):s.push(t.deepClone({},e[r]));return s}static getClassNameFromTagName(t){let e=t.split("-");return e[0].charAt(0).toUpperCase()+e[0].slice(1).toLowerCase()+e[1].charAt(0).toUpperCase()+e[1].slice(1).toLowerCase()}static getTagNameFromClassName(e){let s,r=e,n=e.split("."),a=n[n.length-1];for(s=1;s<a.length&&!t.__isUpper(a.substring(s,s+1));s++);return s<a.length&&(r=a.substring(0,s).toLowerCase()+"-"+a.substring(s).toLowerCase()),r}static getFilenameAndPathFromUrl(t){let e=t.lastIndexOf("/");return[t.substr(0,e),t.substr(e+1)]}static __isUpper(t){return t===t.toUpperCase()&&t!==t.toLowerCase()}static assert(t,e,s,r){if(!t){let t=new(s=s||Error)(e),r=t.stack.split("\n");throw r.splice(1,1),t.stack=r.join("\n"),t}}static warn(t,e,s,r){let n=!0;return t||(s=s||"warn",n=!1),n}static randomWait(t,e){let s=e?t:Math.floor(Math.random()*t);return new Promise(((t,e)=>{setTimeout((()=>{t()}),s)}))}static scopedSelectorAll(t,e){let s=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16);t.setAttribute("__bm_tempid",s);let r="[__bm_tempid='"+s+"'] ",n=r+e.replace(",",","+r),a=t.querySelectorAll(n),i=r+"[bm-powered] "+e.replace(",",", "+r+"[bm-powered] "),o=t.querySelectorAll(i),l=new Set(a);return new Set(o).forEach((t=>{l.delete(t)})),t.removeAttribute("__bm_tempid"),Array.from(l)}}class e{static newComponent(s,r,n,a){a=a||t.getClassNameFromTagName(n);let i=Function("superClass","return function "+e.__validateClassName(a)+"(){ { return Reflect.construct(superClass, [], this.constructor); } }")(s);return e.inherit(i,s),(r=Object.assign({},r)).settings=r.settings?r.settings:{},r.settings.name=a,i.prototype._getSettings=function(){return r},window.BITSMIST.v1[a]=i,n&&customElements.define(n.toLowerCase(),i),i}static inherit(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype._super=e,Object.setPrototypeOf(t,e)}static createObject(s,...r){let n=e.getClass(s);return t.assert(n,`ClassUtil.createObject(): Class '${s}' is not defined.`,ReferenceError),new n(...r)}static getClass(t){let s;try{s=Function("return ("+e.__validateClassName(t)+")")()}catch(t){if(!(t instanceof ReferenceError))throw t}return s}static __validateClassName(e){let s=/^[a-zA-Z0-9\-\._]+$/.test(e);return t.assert(s,`ClassUtil.__validateClassName(): Class name '${e}' is not valid.`,TypeError),e}}class s{static globalInit(t){}static init(t,e,s){}static organize(t,e,s){}static unorganize(t,e,s){}static clear(t){}static isTarget(t,e,s){return e.targetEvents.indexOf("*")>-1||e.targetEvents.indexOf(t)>-1}static getEditor(){return""}}class r extends s{static globalInit(t){Object.defineProperty(t.prototype,"organizers",{get(){return this._organizers}}),t.prototype.addOrganizers=function(t){return r._addOrganizers(this,t)},t.prototype.initOrganizers=function(t){return r._initOrganizers(this,t)},t.prototype.callOrganizers=function(t,e){return r._callOrganizers(this,t,e)},t.prototype.clearOrganizers=function(t,e){return r._clearOrganizers(this,t,e)},r._organizers={},r._targetWords={},Object.defineProperty(r,"organizers",{get:()=>r._organizers})}static organize(t,e,s){return r._addOrganizers(e,s)}static clear(t){t._organizers={}}static register(t,e){(e=Object.assign({},e)).name=e.name?e.name:t,e.targetWords=e.targetWords?e.targetWords:[],e.targetWords=Array.isArray(e.targetWords)?e.targetWords:[e.targetWords],e.targetEvents=e.targetEvents?e.targetEvents:[],e.targetEvents=Array.isArray(e.targetEvents)?e.targetEvents:[e.targetEvents],r._organizers[t]=e,e.object.globalInit(e.targetClassName);for(let t=0;t<e.targetWords.length;t++)r._targetWords[e.targetWords[t]]=e}static addTarget(e,s,n){let a=r._organizers[e],i=t.warn(a,`Organizer not found. organizerName=${e}`),o=t.warn(["targetEvents","targetWords"].indexOf(s)>-1,`Target name is invalid. targetName=${s}`);i&&o&&(Array.isArray(n)?a[s]=a[s].concat(n):a[s].push(n))}static _addOrganizers(e,s){let n={},a=Promise.resolve(),i=s.organizers;return i&&Object.keys(i).forEach((s=>{t.safeGet(i[s],"settings.attach")&&!e._organizers[s]&&r._organizers[s]&&(n[s]=r._organizers[s])})),Object.keys(s).forEach((t=>{let s=r._targetWords[t];s&&(e._organizers[s.name]||(n[s.name]=s.object))})),r._sortItems(n).forEach((n=>{a=a.then((()=>(e._organizers[n]=Object.assign({},r._organizers[n],t.safeGet(s,"organizers."+n)),e._organizers[n].object.init(e,s))))})),a}static _initOrganizers(t,e){return t._organizers={},r.organize("*",t,e)}static _callOrganizers(t,e,s){let n=Promise.resolve();return r._sortItems(t._organizers).forEach((r=>{t._organizers[r].object.isTarget(e,t._organizers[r],t)&&(n=n.then((()=>t._organizers[r].object.organize(e,t,s))))})),n}static _clearOrganizers(t,e,s){let n=Promise.resolve();return r._sortItems(t._organizers).forEach((r=>{t._organizers[r].object.isTarget(e,t._organizers[r],t)&&(n=n.then((()=>t._organizers[r].object.unorganize(e,t,s))))})),n}static _sortItems(t){return Object.keys(t).sort(((e,s)=>t[e].order-t[s].order))}}class n{static ajaxRequest(e){return new Promise(((s,r)=>{let n=t.safeGet(e,"url"),a=t.safeGet(e,"method"),i=t.safeGet(e,"data",""),o=t.safeGet(e,"headers"),l=t.safeGet(e,"options"),g=new XMLHttpRequest;g.open(a,n,!0),l&&Object.keys(l).forEach((t=>{g[t]=l[t]})),o&&Object.keys(o).forEach((t=>{g.setRequestHeader(t,o[t])})),g.addEventListener("load",(()=>{200===g.status||201===g.status?s(g):r(g)})),g.addEventListener("error",(()=>{r(g)})),g.send(i)}))}static loadScript(t){return new Promise(((e,s)=>{let r=t,n=document.createElement("script"),a=document.getElementsByTagName("script")[0];n.async=1,n.onload=n.onreadystatechange=(t,s)=>{(s||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,n=void 0,s||e())},n.src=r,a.parentNode.insertBefore(n,a)}))}}class a{constructor(e){this._options=Object.assign({},e),this.items=t.safeGet(this._options,"items"),this.merger=t.safeGet(this._options,"merger",t.deepMerge)}get items(){return this.clone()}set items(t){this._items=Object.assign({},t)}get merger(){this._merger}set merger(e){t.assert("function"==typeof e,`Store.merger(setter): Merger is not a function. merger=${e}`,TypeError),this._merger=e}clear(){this._items={}}clone(){return t.deepClone({},this._items)}merge(t,e){e=e||this._merger;let s=Array.isArray(t)?t:[t];for(let t=0;t<s.length;t++)s[t]&&"object"==typeof s[t]&&e(this._items,s[t])}get(e,s){return t.safeGet(this._items,e,s)}set(e,s,r){t.safeMerge(this._items,e,s)}remove(t){delete this._items[t]}has(e){return t.safeHas(this._items,e)}}class i extends a{constructor(e){super(e),this.chain;let s=t.safeGet(this._options,"chain");s&&this.chain(s)}get items(){let e;return e=this._chain?t.deepClone(this._chain.clone(),this._items):this.clone(),e}set items(t){this._items=Object.assign({},t)}get localItems(){return this.clone()}clone(){return this._chain?t.deepClone(this._chain.clone(),this._items):a.prototype.clone.call(this)}chain(e){t.assert(e instanceof i,'ChainableStore.chain(): "store" parameter must be a ChainableStore.',TypeError),this._chain=e}get(t,e){let s=e;return this.has(t)?s=a.prototype.get.call(this,t,e):this._chain&&(s=this._chain.get(t,e)),s}merge(t,e){this._options.writeThrough?this._chain.merge(t,e):a.prototype.merge.call(this,t,e)}set(e,s,r){t.safeGet(r,"writeThrough",this._options.writeThrough)?this._chain.set(e,s,r):a.prototype.set.call(this,e,s)}}class o extends s{static globalInit(t){Object.defineProperty(t.prototype,"settings",{get(){return this._settings}}),o.__globalSettings=new i,Object.defineProperty(o,"globalSettings",{get:()=>o.__globalSettings})}static init(t,e){return t._settings=new i({items:e}),t._settings.merge(t._getSettings()),t._settings.get("settings.useGlobalSettings")&&t._settings.chain(o.globalSettings),Promise.resolve().then((()=>o._loadExternalSetting(t,"setting"))).then((()=>{o._loadAttrSettings(t)}))}static _loadExternalSetting(e,s){let r,n;if(e.hasAttribute("bm-"+s+"ref")){let a=t.getFilenameAndPathFromUrl(e.getAttribute("bm-"+s+"ref"));n=a[0],r=a[1].slice(0,-3)}else n=e.hasAttribute("bm-"+s+"path")?e.getAttribute("bm-"+s+"path"):"",r=e.hasAttribute("bm-"+s+"name")?e.getAttribute("bm-"+s+"name"):"",n&&!r&&(r="settings");if(r||n)return e.loadSetting(r,{path:n})}static _loadAttrSettings(t){let e=document.querySelector(t._settings.get("settings.rootNode"))?document.querySelector(t._settings.get("settings.rootNode")).getAttribute("bm-settings"):t.getAttribute("bm-settings");if(e){let s={settings:JSON.parse(e)};t._settings.merge(s)}}}function l(){return Reflect.construct(HTMLElement,[],this.constructor)}e.inherit(l,HTMLElement),l.prototype.connectedCallback=function(){this._ready||(this._ready=Promise.resolve()),this._ready=this._ready.then((()=>!this._initialized||this.settings.get("settings.autoRestart")?(this._initialized=!0,this.start()):this.changeState("started")))},l.prototype.disconnectedCallback=function(){this.settings.get("settings.autoStop")&&(this._ready=this._ready.then((()=>this.stop())))},l.prototype.adoptedCallback=function(){},l.prototype.attributeChangedCallback=function(){},Object.defineProperty(l.prototype,"name",{get(){return this._name}}),Object.defineProperty(l.prototype,"uniqueId",{get(){return this._uniqueId}}),Object.defineProperty(l.prototype,"rootElement",{get(){return this._rootElement}}),l.prototype.start=function(e){let s={settings:{autoFetch:!0,autoFill:!0,autoPostStart:!0,autoRefresh:!0,autoRestart:!1,autoSetup:!0,autoStop:!0,hasTemplate:!0,useGlobalSettings:!0},organizers:{OrganizerOrganizer:{settings:{attach:!0}},SettingOrganizer:{settings:{attach:!0}},StateOrganizer:{settings:{attach:!0}},EventOrganizer:{settings:{attach:!0}},LoaderOrganizer:{settings:{attach:!0}},TemplateOrganizer:{settings:{attach:!0}}}};return e=e?t.deepMerge(s,e):s,this.setAttribute("bm-powered",""),this._uniqueId=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16),this._name=this.constructor.name,this._rootElement=t.safeGet(e,"settings.rootElement",this),Promise.resolve().then((()=>this._initStart(e))).then((()=>this._preStart())).then((()=>{if(this.settings.get("settings.autoPostStart"))return this._postStart()}))},l.prototype.stop=function(t){return t=Object.assign({},t),Promise.resolve().then((()=>this.changeState("stopping"))).then((()=>this.trigger("beforeStop",t))).then((()=>this.trigger("doStop",t))).then((()=>this.changeState("stopped"))).then((()=>this.trigger("afterStop",t)))},l.prototype.switchTemplate=function(t,e){return e=Object.assign({},e),this.activeTemplateName===t?Promise.resolve():Promise.resolve().then((()=>this.addTemplate(t))).then((()=>this.applyTemplate(t))).then((()=>{if(this.settings.get("settings.autoSetup"))return this.setup(this.settings.items);this.hideConditionalElements()})).then((()=>this.loadTags(this.rootElement))).then((()=>this.callOrganizers("afterAppend",this.settings.items))).then((()=>this.trigger("afterAppend",e))).then((()=>{}))},l.prototype.setup=function(t){return t=Object.assign({},t),Promise.resolve().then((()=>this.trigger("beforeSetup",t))).then((()=>this.trigger("doSetup",t))).then((()=>this.trigger("afterSetup",t))).then((()=>{}))},l.prototype.refresh=function(e){return e=Object.assign({},e),Promise.resolve().then((()=>this.trigger("beforeRefresh",e))).then((()=>this.trigger("doTarget",e))).then((()=>{if(t.safeGet(e,"autoFetch",this.settings.get("settings.autoFetch")))return this.fetch(e)})).then((()=>{this.showConditionalElements(this.item)})).then((()=>{if(t.safeGet(e,"autoFill",this.settings.get("settings.autoFill")))return this.fill(e)})).then((()=>this.trigger("doRefresh",e))).then((()=>this.trigger("afterRefresh",e))).then((()=>{}))},l.prototype.fetch=function(t){return t=Object.assign({},t),Promise.resolve().then((()=>this.trigger("beforeFetch",t))).then((()=>this.callOrganizers("doFetch",t))).then((()=>this.trigger("doFetch",t))).then((()=>this.trigger("afterFetch",t))).then((()=>{}))},l.prototype.fill=function(t){},l.prototype.clear=function(t){},l.prototype.scopedSelectorAll=function(e){return t.scopedSelectorAll(this,e)},l.prototype._injectSettings=function(t){return t},l.prototype._getSettings=function(){return{}},l.prototype._initStart=function(t){return Promise.resolve().then((()=>this._injectSettings(t))).then((t=>o.init(this,t))).then((()=>(this._adjustSettings(),this.initOrganizers(this.settings.items))))},l.prototype._preStart=function(){return Promise.resolve().then((()=>this.changeState("starting"))).then((()=>this.addOrganizers(this.settings.items))).then((()=>this.callOrganizers("beforeStart",this.settings.items))).then((()=>this.trigger("beforeStart"))).then((()=>{if(this.settings.get("settings.hasTemplate"))return this.switchTemplate(this.settings.get("settings.templateName"));if(this.settings.get("settings.autoSetup"))return this.setup(this.settings.items)})).then((()=>{if(this.settings.get("settings.autoRefresh"))return this.refresh()}))},l.prototype._postStart=function(){return Promise.resolve().then((()=>this.changeState("started"))).then((()=>this.callOrganizers("afterStart",this.settings.items))).then((()=>this.trigger("afterStart")))},l.prototype._adjustSettings=function(){this._rootElement=this.settings.get("settings.rootElement",this);let t=this.settings.get("settings.name");t&&(this._name=t),this.settings.get("settings.autoMorph")&&(this.settings.set("settings.autoRefresh",!1),this.settings.set("settings.autoSetup",!1))},customElements.define("bm-component",l);class g extends s{static globalInit(){Object.defineProperty(l.prototype,"state",{get(){return this._state},set(t){this._state=t}}),l.prototype.changeState=function(t){return g._changeState(this,t)},l.prototype.waitFor=function(t,e){return g._waitFor(this,t,e)},l.prototype.suspend=function(t){return g._suspend(this,t)},l.prototype.resume=function(t){return g._resume(this,t)},l.prototype.pause=function(t){return g._pause(this,t)},g.__suspends={},g.__components=new a,g.__waitingList=new a,g.__waitingListIndexName=new Map,g.__waitingListIndexId=new Map,g.__waitingListIndexNone=new Map,g.waitFor=function(t,e){return g._waitFor(null,t,e)}}static init(t,e){t._state="",t._suspends={},g.__loadAttrSettings(t)}static organize(t,e,s){let r=Promise.resolve(),n=s.waitFor;return n&&n[t]&&(r=g._waitFor(e,n[t],e.settings.get("system.waitforTimeout"))),r}static clear(){this.__waitingList.clear()}static globalSuspend(t){g.__suspends[t]=g._createSuspendInfo(t),g.__suspends[t].state="pending"}static globalResume(t){g.__suspends[t].resolve(),g.__suspends[t].state="resolved"}static _waitFor(t,e,s){let r,n=s&&s.timeout?s.timeout:1e4,a={waiter:s&&s.waiter?s.waiter:t,waitlist:e.slice()};return g.__isAllReady(a)?r=Promise.resolve():(r=new Promise(((s,r)=>{a.resolve=s,a.reject=r,setTimeout((()=>{let s=t&&t.name||a.waiter&&a.waiter.tagName||"";r(`StateOrganizer._waitFor(): Timed out after ${n} milliseconds waiting for ${g.__dumpWaitlist(e)}, name=${s}.`)}),n)})),a.promise=r,g.__addToWaitingList(a,t)),r}static _waitForSingle(t,e,s){let r=g.__components.get(t.uniqueId),n={id:t.uniqueId,state:e};return g.__isReady(n,r)?Promise.resolve():g.waitFor(t,[n],s)}static _changeState(e,s){t.assert(g.__isTransitionable(e._state,s),`StateOrganizer._changeState(): Illegal transition. name=${e.name}, fromState=${e._state}, toState=${s}, id=${e.id}`,Error),e._state=s,g.__components.set(e.uniqueId,{object:e,state:s}),g.__processWaitingList(e,s)}static _suspend(t,e){t._suspends[e]=g._createSuspendInfo(),t._suspends[e].state="pending"}static _resume(t,e){t._suspends[e].resolve(),t._suspends[e].state="resolved"}static _pause(t,e){let s=[];return g.__suspends[e]&&"pending"===g.__suspends[e].state&&!t.settings.get("settings.ignoreGlobalSuspend")&&s.push(g.__suspends[e].promise),t._suspends[e]&&"pending"===t._suspends[e].state&&s.push(t._suspends[e].promise),Promise.all(s)}static __isTransitionable(t,e){let s=!0;return t&&"ing"===t.slice(-3)&&("stopping"===t&&"stopped"!==e||"starting"===t&&"started"!==e)&&(s=!1),s}static __processWaitingList(t,e){let s=g.__waitingListIndexName.get(t.name+"."+e);s&&s.length>0&&g.__processIndex(s);let r=g.__waitingListIndexId.get(t.uniqueId+"."+e);r&&r.length>0&&g.__processIndex(r);let n=g.__waitingListIndexNone.get("none");n&&n.length>0&&g.__processIndex(n)}static __processIndex(t){let e=[];for(let s=0;s<t.length;s++){let r=t[s];g.__waitingList.get(r),g.__isAllReady(g.__waitingList.get(r))&&(g.__waitingList.get(r).resolve(),g.__waitingList.remove(r),e.push(r))}for(let s=e.length-1;s>=0;s--)g.__removeFromIndex(t,e[s])}static __addToWaitingList(t){let e=(new Date).getTime().toString(16)+Math.floor(100*Math.random()).toString(16);g.__waitingList.set(e,t);let s=t.waitlist;for(let t=0;t<s.length;t++)s[t].state=s[t].state||"started",s[t].id?g.__addToIndex(g.__waitingListIndexId,s[t].id+"."+s[t].state,e):s[t].name?g.__addToIndex(g.__waitingListIndexName,s[t].name+"."+s[t].state,e):g.__addToIndex(g.__waitingListIndexNone,"none",e)}static __addToIndex(t,e,s){let r=t.get(e);r||(r=[],t.set(e,r)),-1===r.indexOf(s)&&r.push(s)}static __removeFromIndex(t,e){let s=t.indexOf(e);s>-1&&t.splice(s,1)}static __getComponentInfo(t){let e;if(t.id)e=g.__components.get(t.id);else if(t.name)Object.keys(g.__components.items).forEach((s=>{t.name===g.__components.get(s).object.name&&(e=g.__components.get(s))}));else if(t.rootNode){let s=document.querySelector(t.rootNode);s&&s.uniqueId&&(e=g.__components.get(s.uniqueId))}else if(t.object){let s=t.object;s.uniqueId&&(e=g.__components.get(s.uniqueId))}return e}static __isAllReady(t){let e=!0,s=t.waitlist;for(let t=0;t<s.length;t++){let r=!1,n=this.__getComponentInfo(s[t]);if(n&&g.__isReady(s[t],n)&&(r=!0),!r){e=!1;break}}return e}static __isReady(t,e){let s=g.__isComponentMatch(e,t);return s&&(s=g.__isStateMatch(e.state,t.state)),s}static __isComponentMatch(t,e){let s=!0;return e.component&&t.object!==e.component&&(s=!1),e.name&&t.object.name!==e.name&&(s=!1),e.id&&t.object.uniqueId!==e.id&&(s=!1),e.rootNode&&!document.querySelector(e.rootNode)&&(s=!1),s}static __isStateMatch(t,e){let s=!0;if("started"===(e=e||"started"))"started"!==t&&(s=!1);else t!==e&&(s=!1);return s}static __loadAttrSettings(t){if(t.hasAttribute("bm-waitfor")){let e={name:t.getAttribute("bm-waitfor"),state:"started"};t.settings.merge({waitFor:[e]})}if(t.hasAttribute("bm-waitfornode")){let e={rootNode:t.getAttribute("bm-waitfornode"),state:"started"};t.settings.merge({waitFor:[e]})}}static __dumpWaitlist(t){let e="";for(let s=0;s<t.length;s++){e+="\n\t{"+(t[s].id?"id:"+t[s].id+",":"")+(t[s].name?"name:"+t[s].name+",":"")+(t[s].object?"element:"+t[s].object.tagName+",":"")+(t[s].rootNode?"node:"+t[s].rootNode+",":"")+(t[s].state?"state:"+t[s].state:"")+"},"}return"["+e+"\n]"}static _createSuspendInfo(){let t={},e=new Promise(((e,s)=>{t.resolve=e,t.reject=s,t.state="pending"}));return t.promise=e,t}}class c extends s{static globalInit(){Object.defineProperty(l.prototype,"templates",{get(){return this._templates}}),Object.defineProperty(l.prototype,"activeTemplateName",{get(){return this._activeTemplateName},set(t){this._activeTemplateName=t}}),l.prototype.addTemplate=function(t,e){return c._addTemplate(this,t,e)},l.prototype.applyTemplate=function(t){return c._applyTemplate(this,t)},l.prototype.cloneTemplate=function(t){return c._clone(this,t)},l.prototype.showConditionalElements=function(t){return c._showConditionalElements(this,t)},l.prototype.hideConditionalElements=function(){return c._hideConditionalElements(this)}}static init(t,e){if(t._templates={},t._activeTemplateName="",!t.settings.get("settings.templateName")){let e=t.settings.get("settings.fileName")||t.tagName.toLowerCase();t.settings.set("settings.templateName",e)}}static organize(t,e,s){let r=[],n=s.templates;return n&&Object.keys(n).forEach((s=>{if("beforeStart"===t)switch(n[s].type){case"html":case"url":r.push(c._addTemplate(e,s))}else if("afterAppend"===t&&"node"===n[s].type)r.push(c._addTemplate(e,s))})),Promise.all(r)}static clear(t){t._templates={}}static _addTemplate(t,e,s){return(t._templates[e]||c.__createTemplateInfo(t,e)).isLoaded?Promise.resolve():t.loadTemplate(e)}static _applyTemplate(e,s){if(e._activeTemplateName===s)return Promise.resolve();let r=e._templates[s];if(t.assert(r,`TemplateOrganizer._applyTemplate(): Template not loaded. name=${e.name}, templateName=${s}`,ReferenceError),r.node){let t=c.clone(e,r.name);e.insertBefore(t,e.firstChild)}else e.innerHTML=r.html;e._activeTemplateName=s}static _clone(e,s){s=s||e.settings.get("settings.templateName");let r,n=e._templates[s];if(t.assert(n,`TemplateOrganizer._addTemplate(): Template not loaded. name=${e.name}, templateName=${s}`,ReferenceError),n.node)r=document.importNode(n.node,!0);else{let t=document.createElement("div");t.innerHTML=n.html,r=t.firstElementChild}return r}static _showConditionalElements(e,s){t.scopedSelectorAll(e,"[bm-visible]").forEach((e=>{let r=e.getAttribute("bm-visible");t.safeEval(r,s,s)?e.style.removeProperty("display"):e.style.display="none"}))}static _hideConditionalElements(e){t.scopedSelectorAll(e,"[bm-visible]").forEach((t=>{t.style.display="none"}))}static __createTemplateInfo(t,e){return t._templates[e]||(t._templates[e]={},t._templates[e].name=e,t._templates[e].html="",t._templates[e].isLoaded=!1),t._templates[e]}}class d extends s{static globalInit(){l.prototype.initEvents=function(t,e,s){d._initEvents(this,t,e,s)},l.prototype.addEventHandler=function(t,e,s,r){d._addEventHandler(this,s,t,e,r)},l.prototype.trigger=function(t,e,s){return d._trigger(this,t,e,s)},l.prototype.triggerAsync=function(t,e,s){return d._triggerAsync(this,t,e,s)},l.prototype.getEventHandler=function(t){return d._getEventHandler(this,t)},l.prototype.removeEventHandler=function(t,e,s){return d._removeEventHandler(this,s,t,e)},Object.defineProperty(l.prototype,"eventResult",{get(){return this._eventResult}})}static init(t,e){t._eventResult={}}static organize(t,e,s){let r=s.events;if(r){let s=d.__filterElements(e,r,t);Object.keys(s).forEach((t=>{d._initEvents(e,t,r[t])}))}}static unorganize(t,e,s){let r=s.events;r&&Object.keys(r).forEach((t=>{d._removeEvents(e,t,r[t])}))}static _addEventHandler(e,s,r,n,a){s=s||e;let i="object"==typeof n?n:{},o=d._getEventHandler(e,n);t.assert(o,`EventOrganizer._addEventHandler(): handler not found. name=${e.name}, eventName=${r}`),s.__bm_eventinfo||(s.__bm_eventinfo={component:e,listeners:{},promises:{},statuses:{}});let l=s.__bm_eventinfo.listeners;l[r]||(l[r]=[],s.addEventListener(r,d.__callEventHandler,i.listnerOptions)),l[r].push({handler:o,options:i.options,bindTo:a}),t.safeGet(i,"order"),l[r].sort(((t,e)=>t.order===e.order?0:t.order>e.order?1:-1))}static _removeEventHandler(e,s,r,n){s=s||e;let a=d._getEventHandler(e,n);t.assert(a,`EventOrganizer._removeEventHandler(): handler not found. name=${e.name}, eventName=${r}`);let i=t.safeGet(s,"__bm_eventinfo.listeners."+r);if(i)for(let t=i.length-1;t>=0;t--)if(i[t].handler===a){i.splice(t,1);break}}static _initEvents(t,e,s,r){r=r||t;let n=d.__getTargetElements(t,r,e,s);Object.keys(s.handlers).forEach((e=>{let r=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<r.length;s++)for(let a=0;a<n.length;a++)t.addEventHandler(e,r[s],n[a])}))}static _removeEvents(t,e,s,r){r=r||t;let n=d.__getTargetElements(t,r,e,s);Object.keys(s.handlers).forEach((e=>{let r=Array.isArray(s.handlers[e])?s.handlers[e]:[s.handlers[e]];for(let s=0;s<r.length;s++)for(let a=0;a<n.length;a++)t.removeEventHandler(e,r[s],n[a])}))}static _trigger(e,s,r,n){(r=Object.assign({},r)).sender=r.sender||e,e._eventResult={},r.result=e._eventResult,n=n||e;let a=null;try{a=new CustomEvent(s,{detail:r})}catch(t){a=document.createEvent("CustomEvent"),a.initCustomEvent(s,!1,!1,r)}return n.dispatchEvent(a),t.safeGet(n,"__bm_eventinfo.promises."+s)||Promise.resolve()}static _triggerAsync(t,e,s,r){return(s=s||{}).async=!0,d._trigger.call(t,t,e,s,r)}static _getEventHandler(t,e){return"object"==typeof e?e.handler:e}static __filterElements(t,e,s){let r;switch(s){case"beforeStart":r=Object.keys(e).filter((t=>d.__isTargetSelf(t,e[t])));break;case"afterAppend":r=Object.keys(e).filter((t=>!d.__isTargetSelf(t,e[t])));break;case"afterSpecLoad":r=Object.keys(e)}return r.reduce(((t,s)=>(t[s]=e[s],t)),{})}static __isTargetSelf(t,e){let s=!1;return("this"===t||e&&"this"===e.rootNode)&&(s=!0),s}static __getTargetElements(e,s,r,n){let a;return a=d.__isTargetSelf(r,n)?[s]:n&&n.rootNode?t.scopedSelectorAll(s,n.rootNode):t.scopedSelectorAll(s,"#"+r),a}static __isHandlerInstalled(e,s,r){let n=!1,a=t.safeGet(e.__bm_eventinfo,"listeners."+s);if(a)for(let t=0;t<a.length;t++)if(a[t].handler===r){n=!0;break}return n}static __callEventHandler(e){let s=t.safeGet(this,"__bm_eventinfo.listeners."+e.type),r=t.safeGet(e,"detail.sender",this),n=t.safeGet(this,"__bm_eventinfo.component");t.warn("handling"!==t.safeGet(this,"__bm_eventinfo.statuses."+e.type),`EventOrganizer.__callEventHandler(): Event handler is already running. name=${this.tagName}, eventName=${e.type}`),t.safeSet(this,"__bm_eventinfo.statuses."+e.type,"handling"),!1===t.safeGet(e,"detail.async",!1)?this.__bm_eventinfo.promises[e.type]=d.__handle(e,r,n,s).then((s=>{t.safeSet(this,"__bm_eventinfo.promises."+e.type,null),t.safeSet(this,"__bm_eventinfo.statuses."+e.type,"")})):(this.__bm_eventinfo.promises[e.type]=d.__handleAsync(e,r,n,s),t.safeSet(this,"__bm_eventinfo.promises."+e.type,null),t.safeSet(this,"__bm_eventinfo.statuses."+e.type,""))}static __handle(e,s,r,n){let a=Promise.resolve(),i=!1;for(let o=0;o<n.length;o++){let l={component:r,options:n[o].options?n[o].options:{}};a=a.then((()=>{let a=n[o].handler;a="string"==typeof a?r[a]:a,t.assert("function"==typeof a,`EventOrganizer._addEventHandler(): Event handler is not a function. name=${r.name}, eventName=${e.type}`,TypeError);let i=n[o].bindTo?n[o].bindTo:r;return a.call(i,s,e,l)})),i=!(!n[o].options||!n[o].options.stopPropagation)||i}return i&&e.stopPropagation(),a}static __handleAsync(e,s,r,n){let a=!1;for(let i=0;i<n.length;i++){let o={component:r,options:n[i].options?n[i].options:{}},l=n[i].handler;l="string"==typeof l?r[l]:l,t.assert("function"==typeof l,`EventOrganizer._addEventHandler(): Event handler is not a function. name=${r.name}, eventName=${e.type}`,TypeError);let g=n[i].bindTo?n[i].bindTo:r;l.call(g,s,e,o),a=!(!n[i].options||!n[i].options.stopPropagation)||a}return a&&e.stopPropagation(),Promise.resolve()}}class p extends s{static globalInit(){BITSMIST.v1.Component.prototype.getLoader=function(...t){return p._getLoader(this,...t)},BITSMIST.v1.Component.prototype.loadTags=function(...t){return this.getLoader().loadTags(...t)},BITSMIST.v1.Component.prototype.loadTag=function(...t){return this.getLoader().loadTag(...t)},BITSMIST.v1.Component.prototype.loadComponent=function(...t){return this.getLoader().loadComponent(...t)},BITSMIST.v1.Component.prototype.loadTemplate=function(...t){return this.getLoader().loadTemplate(this,...t)},BITSMIST.v1.Component.prototype.loadSetting=function(...t){return this.getLoader().loadSetting(this,...t)},BITSMIST.v1.Component.prototype.loadSettingFile=function(...t){return this.getLoader().loadSettingFile(this,...t)},p._loaders={},Object.defineProperty(p,"loaders",{get:()=>p._loaders}),p._loaders.DefaultLoader=BITSMIST.v1.DefaultLoader,document.addEventListener("DOMContentLoaded",(()=>{if(BITSMIST.v1.settings.get("organizers.LoaderOrgaznier.settings.autoLoadOnStartup",!0)){let e=BITSMIST.v1.settings.get("system.loaderName","DefaultLoader"),s=p._loaders[e].object;t.assert(p._loaders[e],`Loader doesn't exist. loaderName=${e}`),s.loadTags(document.body,{waitForTags:!1})}}))}static init(t,e){Object.defineProperty(t,"components",{get(){return this._components}}),t.addComponent=function(t,e,s){return p._addComponent(this,t,e,s)},t._components={},t.getLoader().init(t)}static organize(t,e,s){let r=Promise.resolve(),n=s.molds;n&&Object.keys(n).forEach((t=>{r=r.then((()=>p._addComponent(e,t,n[t],!0)))}));let a=s.components;return a&&Object.keys(a).forEach((t=>{r=r.then((()=>p._addComponent(e,t,a[t])))})),r}static register(t,e){(e=Object.assign({},e)).name=e.name?e.name:t,p._loaders[t]=e}static _getLoader(e,s){return s=s||e.settings.get("settings.loaderName","DefaultLoader"),t.assert(p._loaders[s],`Loader doesn't exist. loaderName=${s}`),p._loaders[s].object}static _addComponent(e,s,r,n){let a=t.safeGet(r,"loadings.className")||s,i=t.safeGet(r,"loadings.tagName")||t.getTagNameFromClassName(a);return Promise.resolve().then((()=>{let s={splitComponent:t.safeGet(r,"loadings.splitComponent",e.settings.get("system.splitComponent",!1))};return e.loadComponent(a,r,s,i)})).then((()=>{t.safeGet(r,"loadings.rootNode")&&!e._components[s]&&(e._components[s]=p.__insertTag(e,i,r))})).then((()=>{if(n||t.safeGet(r,"loadings.sync")){let s=!0===(n=n||t.safeGet(r,"loadings.sync"))?"started":n,i=a.split(".");return e.waitFor([{name:i[i.length-1],state:s}])}}))}static __insertTag(e,s,r){let n,a=e.rootElement.querySelector(t.safeGet(r,"loadings.rootNode"));t.assert(a,`LoaderOrganizer.__insertTag(): Root node does not exist. name=${e.name}, tagName=${s}, rootNode=${t.safeGet(r,"settings.rootNode")}`,ReferenceError);let i=t.safeGet(r,"loadings.tag")?t.safeGet(r,"loadings.tag"):"<"+s+"></"+s+">";return t.safeGet(r,"loadings.overwrite")?(a.outerHTML=i,n=a):(a.insertAdjacentHTML("afterbegin",i),n=a.children[0]),n._injectSettings=function(e){return n._super&&n._super.prototype._injectSettings&&(e=n._super.prototype._injectSettings.call(n,e)),t.deepMerge(e,r)},n}}class m{static init(t,e){this._loadAttrSettings(t)}static loadTags(e,s){let r=[],n=[],a=t.scopedSelectorAll(e,"[bm-autoload]:not([bm-autoloading]):not([bm-powered]),[bm-automorph]:not([bm-autoloading]):not([bm-powered])");return a.forEach((t=>{t.setAttribute("bm-autoloading","");let e=t.hasAttribute("bm-loader")?p.getLoader(t.getAttribute("bm-loader")).object:this;r.push(e.loadTag(t,s).then((()=>{t.removeAttribute("bm-autoloading")})))})),a=t.scopedSelectorAll(e,"[bm-powered],[bm-autoloading]"),a.forEach((t=>{if(e!=t.rootElement&&!t.hasAttribute("bm-nowait")){let e={object:t,state:"started"};n.push(e)}})),Promise.all(r).then((()=>{if(t.safeGet(s,"waitForTags")&&n.length>0)return BITSMIST.v1.StateOrganizer.waitFor(n,{waiter:e})}))}static loadTag(e,s){let r=e.getAttribute("bm-autoload"),n=e.getAttribute("bm-classname")||t.getClassNameFromTagName(e.tagName),a=e.getAttribute("bm-path")||"",i=t.safeGet(s,"splitComponent",BITSMIST.v1.settings.get("system.splitComponent",!1)),o={loadings:{autoMorph:!!e.hasAttribute("bm-automorph")&&(!e.getAttribute("bm-automorph")||e.getAttribute("bm-automorph")),path:a}},l={splitComponent:i};if(r){let e=t.getFilenameAndPathFromUrl(r);l.path=e[0],".js"===r.slice(-3).toLowerCase()?o.loadings.fileName=e[1].substring(0,e[1].length-3):".html"===r.slice(-5).toLowerCase()&&(o.loadings.autoMorph=!0,o.loadings.fileName=e[1].substring(0,e[1].length-5))}return this.loadComponent(n,o,l,e.tagName)}static loadComponent(s,r,n,a){let i;a=a.toLowerCase();let o=t.safeGet(n,"path",t.concatPath([BITSMIST.v1.settings.get("system.appBaseUrl",""),BITSMIST.v1.settings.get("system.componentPath",""),t.safeGet(r,"loadings.path")]));if(customElements.get(a))return Promise.resolve();let l=t.safeGet(r,"loadings.autoMorph");if(l){let t=!0===l?BITSMIST.v1.Component:e.getClass(l);e.newComponent(t,r,a,s)}else{let e=t.safeGet(r,"loadings.fileName",a);i=this._autoloadComponent(s,e,o,n)}return Promise.all([i]).then((()=>{if(!customElements.get(a)){let t=e.getClass(s);customElements.define(a,t)}}))}static loadTemplate(t,e,s){let r,n=t._templates[e],a=t.settings.get("templates."+e,{});switch(a.type){case"html":n.html=a.html,r=Promise.resolve();break;case"node":n.html=t.querySelector(a.rootNode).innerHTML,r=Promise.resolve();break;default:r=this._loadTemplateFile(t,n.name,s).then((t=>{n.html=t}))}return r.then((()=>{n.isLoaded=!0}))}static loadSetting(e,s,r){let n;return Promise.resolve().then((()=>(n=t.safeGet(r,"path",t.concatPath([BITSMIST.v1.settings.get("system.appBaseUrl",""),BITSMIST.v1.settings.get("system.componentPath",""),t.safeGet(r,"path")])),this.loadSettingFile(e,s,n,"js")))).then((t=>{t&&e.settings.merge(t)}))}static loadSettingFile(e,s,r,a){a=a||"js";let i,o=t.concatPath([r,s+"."+a]);return n.ajaxRequest({url:o,method:"GET"}).then((t=>{if("json"===a)try{i=JSON.parse(t.responseText)}catch(t){throw t instanceof SyntaxError?new SyntaxError(`Illegal json string. url=${o}, message=${t.message}`):t}else i=Function('"use strict";return ('+t.responseText+")").call(e);return i}))}static _isLoadedClass(t){let s=!1;return("loaded"===m._classes.get(t,{}).state||e.getClass(t))&&(s=!0),s}static _autoloadComponent(t,e,s,r){let n;return this._isLoadedClass(t)?(m._classes.set(t,{state:"loaded"}),n=Promise.resolve()):"loading"===m._classes.get(t,{}).state?n=m._classes.get(t).promise:(m._classes.set(t,{state:"loading"}),n=this._loadComponentScript(e,s,r).then((()=>{m._classes.set(t,{state:"loaded",promise:null})})),m._classes.set(t,{promise:n})),n}static _loadComponentScript(e,s,r){let a=t.concatPath([s,e+".js"]),i=t.concatPath([s,e+".settings.js"]);return Promise.resolve().then((()=>n.loadScript(a))).then((()=>{if(r.splitComponent)return n.loadScript(i)})).then((()=>{}))}static _loadTemplateFile(e,s,r){let a=t.concatPath([e.settings.get("system.appBaseUrl",""),e.settings.get("system.templatePath",""),e.settings.get("loadings.path","")]),i=t.concatPath([a,s])+".html";return n.ajaxRequest({url:i,method:"GET"}).then((t=>t.responseText))}static _loadAttrSettings(e){if(e.getAttribute("bm-autoload")){let s=t.getFilenameAndPathFromUrl(e.getAttribute("bm-autoload"));e._settings.set("system.appBaseUrl",""),e._settings.set("system.templatePath",s[0]),e._settings.set("system.componentPath",s[0]),e._settings.set("loadings.path",""),".js"===s[1].slice(-3).toLowerCase()?e._settings.set("loadings.fileName",s[1].substring(0,s[1].length-3)):".html"===s[1].slice(-5).toLowerCase()&&e._settings.set("loadings.fileName",s[1].substring(0,s[1].length-5))}e.hasAttribute("bm-path")&&e._settings.set("loadings.path",e.getAttribute("bm-path"))}}m._classes=new a,window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},window.BITSMIST.v1.Component=l,window.BITSMIST.v1.Organizer=s,window.BITSMIST.v1.OrganizerOrganizer=r,r.globalInit(l),window.BITSMIST.v1.SettingOrganizer=o,o.globalInit(l),window.BITSMIST.v1.settings=o.globalSettings,r.register("StateOrganizer",{object:g,targetWords:"waitFor",targetEvents:"*",order:100}),window.BITSMIST.v1.StateOrganizer=g,r.register("TemplateOrganizer",{object:c,targetWords:"templates",targetEvents:["beforeStart","afterAppend"],order:200}),window.BITSMIST.v1.TemplateOrganizer=c,r.register("EventOrganizer",{object:d,targetWords:"events",targetEvents:["beforeStart","afterAppend","afterSpecLoad"],order:210}),window.BITSMIST.v1.EventOrganizer=d,r.register("LoaderOrganizer",{object:p,targetWords:["molds","components"],targetEvents:["afterStart"],order:400}),window.BITSMIST.v1.LoaderOrganizer=p,p.register("DefaultLoader",{object:m}),window.BITSMIST.v1.DefaultLoader=m,window.BITSMIST.v1.Store=a,window.BITSMIST.v1.ChainableStore=i,window.BITSMIST.v1.AjaxUtil=n,window.BITSMIST.v1.ClassUtil=e,window.BITSMIST.v1.Util=t}();
